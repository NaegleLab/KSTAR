
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>kstar.calculate &#8212; KSTAR 1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/classic.css" />
    
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">KSTAR 1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">kstar.calculate</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for kstar.calculate</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">stats</span>
<span class="kn">from</span> <span class="nn">statsmodels.stats</span> <span class="kn">import</span> <span class="n">multitest</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">repeat</span>
<span class="kn">import</span> <span class="nn">concurrent.futures</span>

<span class="kn">from</span> <span class="nn">kstar</span> <span class="kn">import</span> <span class="n">config</span><span class="p">,</span> <span class="n">helpers</span>
<span class="kn">from</span> <span class="nn">kstar.normalize</span> <span class="kn">import</span> <span class="n">generate_random_experiments</span><span class="p">,</span> <span class="n">calculate_fpr</span>

<div class="viewcode-block" id="KinaseActivity"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.KinaseActivity">[docs]</a><span class="k">class</span> <span class="nc">KinaseActivity</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Kinase Activity calculates the estimated activity of kinases given an experiment using hypergeometric distribution.</span>
<span class="sd">    Hypergeometric distribution examines the number of protein sites found to be active in evidence compared to the </span>
<span class="sd">    number of protein sites attributed to a kinase on a provided network.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    evidence : pandas df</span>
<span class="sd">        a dataframe that contains (at minimum, but can have more) data columms as evidence to use in analysis and KSTAR_ACCESSION and KSTAR_SITE</span>
<span class="sd">    data_columns: list</span>
<span class="sd">        list of the columns containing the abundance values, which will be used to determine which sites will be used as evidence for activity prediction in each sample</span>
<span class="sd">    logger : Logger object</span>
<span class="sd">        keeps track of kstar analysis, including any errors that occur</span>
<span class="sd">    phospho_type: string, either &#39;Y&#39; or &#39;ST&#39;</span>
<span class="sd">        indicates the phoshpo modification of interest</span>
<span class="sd">    </span>
<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    -------------------</span>
<span class="sd">    Upon Initialization</span>
<span class="sd">    -------------------</span>
<span class="sd">    evidence: pandas dataframe</span>
<span class="sd">        inputted evidence column</span>
<span class="sd">    data_columns: list</span>
<span class="sd">        list of columns containing abundance values, which will be used to determine which sites will be used as evidence. If inputted data_columns parameter was None, this lists includes in column in evidence prefixed by &#39;data:&#39;</span>
<span class="sd">    logger : Logger object</span>
<span class="sd">        keeps track of kstar analysis, including any errors that occur</span>
<span class="sd">    phospho_type: string</span>
<span class="sd">        indicated phosphomod of interest</span>
<span class="sd">    network_directory: string</span>
<span class="sd">        directory where kinase substrate networks can be downloaded, as indicated in config.py</span>
<span class="sd">    normalized: bool</span>
<span class="sd">        indicates whether normalization analysis has been performed</span>
<span class="sd">    aggregate: string</span>
<span class="sd">        the type of aggregation to use when determining binary evidence, either &#39;count&#39; or &#39;mean&#39;. Default is &#39;count&#39;.</span>
<span class="sd">    threshold: float</span>
<span class="sd">        cutoff to use when determining what sites to use for each experiment</span>
<span class="sd">    greater: bool</span>
<span class="sd">        indicates whether sites with greater or lower abundances than the threshold will be used</span>
<span class="sd">    run_data: string</span>
<span class="sd">        indicates the date that kinase activity object was initialized</span>
<span class="sd">    </span>
<span class="sd">    ---------------------------------</span>
<span class="sd">    After Hypergeometric Calculations</span>
<span class="sd">    ---------------------------------</span>
<span class="sd">    activities_list: pandas dataframe</span>
<span class="sd">        p-values obtained for all pruned networks indicating statistical enrichment of a kinase&#39;s substrates for each network, based on hypergeometric </span>
<span class="sd">        tests</span>
<span class="sd">    activities: pandas dataframe</span>
<span class="sd">        median p-values obtained from the activities_list object for each experiment/kinase</span>
<span class="sd">    agg_activities: pandas dataframe</span>
<span class="sd">    </span>
<span class="sd">    -----------------------------------</span>
<span class="sd">    After Random Enrichment Calculation</span>
<span class="sd">    -----------------------------------</span>
<span class="sd">    random_experiments: pandas dataframe</span>
<span class="sd">        contains information about the sites randomly sampled for each random experiment</span>
<span class="sd">    </span>
<span class="sd">    random_kinact: KinaseActivity object</span>
<span class="sd">        KinaseActivity object containing random activities predicted from each of the random experiments</span>
<span class="sd">    </span>
<span class="sd">    ---------------------------</span>
<span class="sd">    After Mann Whitney Analysis</span>
<span class="sd">    ---------------------------</span>
<span class="sd">    activities_mann_whitney: pandas dataframe</span>
<span class="sd">        p-values obtained from comparing the real distribution of p-values to the distribution of p-values from random datasets, based</span>
<span class="sd">        the Mann Whitney U-test</span>
<span class="sd">    fpr_mann_whitney: pandas dataframe</span>
<span class="sd">        false positive rates for predicted kinase activities</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evidence</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">data_columns</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">phospho_type</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">phospho_type</span> <span class="o">=</span> <span class="n">phospho_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_evidence</span><span class="p">(</span><span class="n">evidence</span><span class="p">)</span>
        

        <span class="bp">self</span><span class="o">.</span><span class="n">networks</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network_sizes</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalizers</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network_directory</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">NETWORK_DIR</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">num_networks</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">activities_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agg_activities</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activities</span> <span class="o">=</span> <span class="kc">None</span>


        <span class="c1">#Properties for normalized information</span>
        <span class="c1">#self.normalizers = defaultdict()</span>
        <span class="c1">#self.normalized = False</span>
        <span class="c1">#self.normalized_activities_list = None</span>
        <span class="c1">#self.normalized_agg_activities = None</span>
        <span class="c1">#self.activities_normalized = None</span>
        <span class="c1">#self.fpr_activity = None</span>
        
        <span class="c1">#Location of random experiments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">randomized</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_experiments</span> <span class="o">=</span> <span class="kc">None</span>



        <span class="bp">self</span><span class="o">.</span><span class="n">aggregate</span> <span class="o">=</span> <span class="s1">&#39;mean&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">greater</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">run_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%m/%Y %H:%M:%S&quot;</span><span class="p">)</span>
        
        <span class="c1">#if data columns is None, set data columns to be columns with data: in front</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_data_columns</span><span class="p">(</span><span class="n">data_columns</span> <span class="o">=</span> <span class="n">data_columns</span><span class="p">)</span>
   

<div class="viewcode-block" id="KinaseActivity.check_data_columns"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.KinaseActivity.check_data_columns">[docs]</a>    <span class="k">def</span> <span class="nf">check_data_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks data columns to make sure column is in evidence and that evidence filtered on that data column </span>
<span class="sd">        has at least one point of evidence. Removes all columns that do not meet criteria</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_data_columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">evidence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evidence</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_ACCESSION</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aggregate</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">evidence</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">greater</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">evidence</span><span class="p">[</span><span class="n">evidence</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">new_data_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> does not have any evidence&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">evidence</span><span class="p">[</span><span class="n">evidence</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">new_data_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> does not have any evidence&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> not in evidence&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span> <span class="o">=</span> <span class="n">new_data_columns</span></div>

<div class="viewcode-block" id="KinaseActivity.set_data_columns"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.KinaseActivity.set_data_columns">[docs]</a>    <span class="k">def</span> <span class="nf">set_data_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_columns</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the data columns to use in the kinase activity calculation</span>
<span class="sd">        If data_columns is None or an empty list then set data_columns to </span>
<span class="sd">        be all columns that start with data:</span>

<span class="sd">        Checks all set columns to make sure columns are vaild after filtering evidence</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">data_columns</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">data_columns</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">evidence</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;data:&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>  
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span> <span class="o">=</span> <span class="n">data_columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_data_columns</span><span class="p">()</span>    </div>

<div class="viewcode-block" id="KinaseActivity.calculate_random_activities"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.KinaseActivity.calculate_random_activities">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_random_activities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">num_random_experiments</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">PROCESSES</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate random experiments and calculate the kinase activities for these random experiments</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running Randomization Pipeline&quot;</span><span class="p">)</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span> <span class="o">=</span> <span class="n">PROCESSES</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_random_experiments</span> <span class="o">=</span> <span class="n">num_random_experiments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating random experiments&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_experiments</span> <span class="o">=</span> <span class="n">generate_random_experiments</span><span class="o">.</span><span class="n">build_random_experiments</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">evidence_binary</span><span class="p">,</span> 
            <span class="n">config</span><span class="o">.</span><span class="n">HUMAN_REF_COMPENDIA</span><span class="p">,</span> 
            <span class="n">num_random_experiments</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phospho_type</span><span class="p">,</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span><span class="p">,</span>
            <span class="n">pool</span><span class="p">,</span>
            <span class="n">PROCESSES</span> <span class="o">=</span> <span class="n">PROCESSES</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Calculating random kinase activities&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_kinact</span> <span class="o">=</span> <span class="n">KinaseActivity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">random_experiments</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">phospho_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">phospho_type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_kinact</span><span class="o">.</span><span class="n">add_networks_batch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_kinact</span><span class="o">.</span><span class="n">calculate_kinase_activities</span><span class="p">(</span> <span class="n">agg</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">greater</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">PROCESSES</span> <span class="o">=</span> <span class="n">PROCESSES</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_kinact</span><span class="o">.</span><span class="n">agg_activities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_kinact</span><span class="o">.</span><span class="n">aggregate_activities</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_kinact</span><span class="o">.</span><span class="n">activities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_kinact</span><span class="o">.</span><span class="n">summarize_activities</span><span class="p">()</span></div>

    
    <span class="c1">#def run_normalization(self, logger, num_random_experiments=150, target_alpha=0.05, PROCESSES = 1):</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    Run entire normaliation pipeline (Generate random experiments, calculate kinase activities for random experiments, and normalize p-values based on provided target_alpha)</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    self.logger.info(&quot;Running Normalization Pipeline&quot;)</span>
    <span class="c1">#    pool = multiprocessing.Pool(processes = PROCESSES)</span>
    <span class="c1">#    self.normalized = True</span>
    <span class="c1">#    self.num_random_experiments = num_random_experiments</span>
    <span class="c1">#    self.logger.info(&quot;Generating random experiments&quot;)</span>
    <span class="c1">#    self.random_experiments = generate_random_experiments.build_random_experiments(</span>
    <span class="c1">#        self.evidence_binary, </span>
    <span class="c1">#        config.HUMAN_REF_COMPENDIA, </span>
    <span class="c1">#        num_random_experiments,</span>
    <span class="c1">#        self.phospho_type, </span>
    <span class="c1">#        self.data_columns,</span>
    <span class="c1">#        pool,</span>
    <span class="c1">#        PROCESSES = PROCESSES)</span>

        
    <span class="c1">#    self.logger.info(&quot;Calculating random kinase activities&quot;)</span>
    <span class="c1">#    self.random_kinact = KinaseActivity(self.random_experiments, logger, phospho_type=self.phospho_type)</span>
    <span class="c1">#    self.random_kinact.add_networks_batch(self.networks)</span>
    <span class="c1">#    self.random_kinact.calculate_kinase_activities( agg=&#39;count&#39;, threshold=1.0, greater=True, PROCESSES = PROCESSES )</span>
        
    <span class="c1">#    self.logger.info(&quot;Normalizing Activities&quot;)</span>
    <span class="c1">#    self.normalize(target_alpha=target_alpha)</span>



    <span class="c1">#def normalize(self, target_alpha=0.05):</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    Given random_kinace.activities, summarize, calculate FPR, and normalize. Called in the run_normalization pipelin</span>
    <span class="c1">#    and useful for changing the target_alpha value, without requiring generation and calculation of random datasets</span>
    <span class="c1">#    such as in reading a project from slim format.</span>
    <span class="c1">#</span>
    <span class="c1">#    Parameters</span>
    <span class="c1">#    ----------</span>
    <span class="c1">#    target_alpha: float</span>
    <span class="c1">#        FPR target value between 0 and 1</span>
    <span class="c1">#</span>
    <span class="c1">#</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    if target_alpha &gt; 1 or target_alpha &lt; 0:</span>
    <span class="c1">#        self.logger.info(&quot;ERROR: Target alpha should be between 0 an 1, setting to default of 0.05&quot;)</span>
    <span class="c1">#        target_alpha = 0.05</span>
    <span class="c1">#    self.random_kinact.aggregate_activities()</span>
    <span class="c1">#    self.random_kinact.activities = self.random_kinact.summarize_activities()</span>

    <span class="c1">#    self.normalizers, self.fpr_activity = calculate_fpr.generate_fpr_values(self.activities, self.random_kinact.activities, target_alpha)</span>

    <span class="c1">#    self.normalize_activities(default_normalization=target_alpha)</span>
    <span class="c1">#    self.activities_normalized = self.summarize_activities(self.normalized_agg_activities,&#39;median_normalized_activity&#39;,normalized=True)</span>
        

    <span class="k">def</span> <span class="nf">add_networks_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">networks</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">network</span> <span class="ow">in</span> <span class="n">networks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_network</span><span class="p">(</span><span class="n">nid</span><span class="p">,</span> <span class="n">network</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_networks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">networks</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_network</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">network_id</span><span class="p">,</span> <span class="n">network</span><span class="p">,</span> <span class="n">network_size</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add network to be analyzed</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        network_id : str</span>
<span class="sd">            name of the network</span>
<span class="sd">        network : pandas DataFrame</span>
<span class="sd">            network with columns substrate_id, site, kinase_id</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">network_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">network</span>
        <span class="k">if</span> <span class="n">network_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">network_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">network_sizes</span><span class="p">[</span><span class="n">network_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">network_size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">network_sizes</span><span class="p">[</span><span class="n">network_id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">network</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_ACCESSION</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ADD NETWORK : Number of Accession Sites : </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">network_sizes</span><span class="p">[</span><span class="n">network_id</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
<div class="viewcode-block" id="KinaseActivity.get_run_date"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.KinaseActivity.get_run_date">[docs]</a>    <span class="k">def</span> <span class="nf">get_run_date</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        return date that kinase activities were run</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_date</span></div>

    <span class="k">def</span> <span class="nf">set_evidence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evidence</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evidence to use in analysis</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        evidence : pandas DataFrame</span>
<span class="sd">            substrate sites with activity seen. </span>
<span class="sd">            columns : dict for column mapping</span>
<span class="sd">                substrate : Uniprot ID (P12345)</span>
<span class="sd">                site : phosphorylation site (Y123)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">evidence</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_ACCESSION</span> <span class="ow">in</span> <span class="n">columns</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_SITE</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
            <span class="n">phospho_type</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phospho_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">evidence</span> <span class="o">=</span> <span class="n">evidence</span><span class="p">[</span><span class="n">evidence</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">phospho_type</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Evidence not set. Evidence columns must include &#39;</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_ACCESSION</span><span class="si">}</span><span class="s2">&#39; and &#39;</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="si">}</span><span class="s2">&#39; keys&quot;</span><span class="p">)</span>
    
    <span class="c1">#def set_normalizers(self, normalizers):</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    Sets the Kinase normalization values to be used in calculating the updated p-values</span>
    <span class="c1">#    Updated p-values normalized via original p-value / normalization-factor * normalization_factor</span>

    <span class="c1">#    Parameters</span>
    <span class="c1">#    ----------</span>
    <span class="c1">#    normalizers : dict or pandas df</span>
    <span class="c1">#        Kinase Activity Normalizers</span>
    <span class="c1">#        index : kinase</span>
    <span class="c1">#        columns : data_column normalization values</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    self.normalizers = normalizers</span>

    <span class="c1"># def calculate_hypergeometric_single_network(self, evidence, network_id):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Hypergeometric Cumulative Distribution Function calculated for each kinase given evidence</span>
    <span class="c1">#         k : number of times kinase seen in evidence</span>
    <span class="c1">#         M : number of unique sites in network</span>
    <span class="c1">#         n : number of times kinase seen in network</span>
    <span class="c1">#         N : size of evidence</span>
        
    <span class="c1">#     Parameters</span>
    <span class="c1">#     ----------</span>
    <span class="c1">#     evidence : pandas df</span>
    <span class="c1">#         subset of kstar evidence that has been filtered to only include evidence associated with experimetn</span>
    <span class="c1">#     network_id : str</span>
    <span class="c1">#         network to use for analysis</span>
        
    <span class="c1">#     Returns</span>
    <span class="c1">#     -------</span>
    <span class="c1">#     results : pandas df</span>
    <span class="c1">#         Hypergeometric results of evidence for given network</span>
    <span class="c1">#         index : kinase_id</span>
    <span class="c1">#         columns</span>
    <span class="c1">#             frequency : number of times kinase seen in network</span>
    <span class="c1">#             kinase_activity : activity derived from hypergometric cdf </span>
    <span class="c1">#     &quot;&quot;&quot;</span>
        
    <span class="c1">#     network = self.networks[network_id]</span>
    <span class="c1">#     intersect = pd.merge(network, evidence, how=&#39;inner&#39;,</span>
    <span class="c1">#         on=[config.KSTAR_ACCESSION, config.KSTAR_SITE])</span>
    <span class="c1">#     counts = intersect.groupby(config.KSTAR_KINASE).size()</span>
    <span class="c1">#     N = len(intersect.groupby([config.KSTAR_ACCESSION, config.KSTAR_SITE]).size())</span>
    <span class="c1">#     results = pd.DataFrame(counts, columns = [&#39;frequency&#39;])</span>
    <span class="c1">#     results[&#39;kinase_activity&#39;] = 1.0</span>

    <span class="c1">#     K = network.groupby(config.KSTAR_KINASE).size()</span>
        
    <span class="c1">#     kinases = counts.index</span>
    <span class="c1">#     for kin in kinases:</span>
    <span class="c1">#         k = 0</span>
    <span class="c1">#         if counts.loc[kin] &gt; 0:</span>
    <span class="c1">#             k = counts.loc[kin] - 1</span>
    <span class="c1">#         prb = stats.hypergeom.sf(</span>
    <span class="c1">#             k = int(k), </span>
    <span class="c1">#             M = int(self.network_sizes[network_id]), </span>
    <span class="c1">#             n = int(K.loc[kin]), </span>
    <span class="c1">#             N = int(N)</span>
    <span class="c1">#             )</span>
    <span class="c1">#         results.at[kin, &#39;kinase_activity&#39;] = prb</span>
    <span class="c1">#     results[&#39;network&#39;] = network_id</span>
    <span class="c1">#     return results</span>
        
    <span class="c1"># def calculate_hypergeometric_activities(self, evidence, name):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Perform hypergeometric kinase activity analysis given evidence on all networks</span>
        
    <span class="c1">#     Parameters</span>
    <span class="c1">#     ----------</span>
    <span class="c1">#     evidence : pandas df</span>
    <span class="c1">#         subset of class evidence variable where data is filtered based on experiment</span>
    <span class="c1">#     name : str</span>
    <span class="c1">#         name of experiment being performed</span>
            
    <span class="c1">#     Returns</span>
    <span class="c1">#     ---------</span>
    <span class="c1">#     fdr_act : pd DataFrame</span>
    <span class="c1">#         network : network name, from networks key</span>
    <span class="c1">#         frequency : number of times kinase was seen in subgraph of evidence and network</span>
    <span class="c1">#         kinase_activity : hypergeometric kinase activity</span>
    <span class="c1">#         fdr_corrected_kinase_activity : kinase activity after fdr correction</span>
    <span class="c1">#         significant : whether kinase activity is significant based on fdr alpha</span>
    <span class="c1">#     combined : pd DataFrame</span>
    <span class="c1">#         significant : number of networks where kinase was found to be significant</span>
    <span class="c1">#         fraction_significant : fraction of networks kinase was found to be significant through FDR correction</span>
    <span class="c1">#         avg_p_value : combined p-values of kinase using mean</span>
    <span class="c1">#         median_p_value : combined p-values of kinase using median</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
        
    <span class="c1">#     self.logger.info(f&quot;Running hypergeometric analysis on {name}&quot;)</span>
        
    <span class="c1">#     results = []</span>
    <span class="c1">#     for network_id in self.networks.keys(): # calculate kinase activity within each network </span>
    <span class="c1">#         result = self.calculate_hypergeometric_single_network(evidence, network_id) </span>
    <span class="c1">#         results.append(result)</span>

    <span class="c1">#     # combine results into single dataframe</span>
    <span class="c1">#     hyp_act = pd.concat(results)</span>
    <span class="c1">#     hyp_act = hyp_act.reset_index()</span>
    <span class="c1">#     hyp_act[&#39;data&#39;] = name</span>
    <span class="c1">#     return hyp_act</span>

<div class="viewcode-block" id="KinaseActivity.create_binary_evidence"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.KinaseActivity.create_binary_evidence">[docs]</a>    <span class="k">def</span> <span class="nf">create_binary_evidence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agg</span> <span class="o">=</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">threshold</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>  <span class="n">greater</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a binary evidence data frame according to the parameters passed in for method for aggregating</span>
<span class="sd">        duplicates and considering whether a site is included as evidence or not</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        threshold : float</span>
<span class="sd">            threshold value used to filter rows </span>
<span class="sd">        agg : {&#39;count&#39;, &#39;mean&#39;}</span>
<span class="sd">            method to use when aggregating duplicate substrate-sites. </span>
<span class="sd">            &#39;count&#39; combines multiple representations and adds if values are non-NaN</span>
<span class="sd">            &#39;mean&#39; uses the mean value of numerical data from multiple representations of the same peptide.</span>
<span class="sd">                NA values are droped from consideration.</span>
<span class="sd">        greater: Boolean</span>
<span class="sd">            whether to keep sites that have a numerical value &gt;=threshold (TRUE, default) or &lt;=threshold (FALSE)</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        evidence_binary : pd.DataFrame</span>
<span class="sd">            Matches the evidence dataframe of the kinact object, but with 0 or 1 if a site is included or not.</span>
<span class="sd">            This is uniquified and rows that are never used are removed.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">evidence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evidence</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_ACCESSION</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">agg</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        
        <span class="c1">#set the binary evidence for whether a site is included</span>
        <span class="n">evidence_binary</span> <span class="o">=</span> <span class="n">evidence</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">greater</span><span class="p">:</span>
                <span class="n">evidence_binary</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">evidence</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">evidence_binary</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">evidence</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">evidence_binary</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">evidence</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">threshold</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">evidence_binary</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">evidence</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1">#remove phosphorylation sites that were not selected in any experiment (useful for very large experiments where removing the need to copy data reduces time)</span>
        <span class="n">evidence_binary</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">evidence_binary</span><span class="p">[</span><span class="n">evidence_binary</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> 
        <span class="k">return</span> <span class="n">evidence_binary</span></div>


<div class="viewcode-block" id="KinaseActivity.calculate_kinase_activities"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.KinaseActivity.calculate_kinase_activities">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_kinase_activities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agg</span> <span class="o">=</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">threshold</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>  <span class="n">greater</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">PROCESSES</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates combined activity of experiments based that uses a threshold value to determine if an experiment sees a site or not</span>
<span class="sd">        To use values use &#39;mean&#39; as agg</span>
<span class="sd">            mean aggregation drops NA values from consideration</span>
<span class="sd">        To use count use &#39;count&#39; as agg - present if not na</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data_columns : list</span>
<span class="sd">            columns that represent experimental result, if None, takes the columns that start with `data:&#39;&#39; in experiment. </span>
<span class="sd">            Pass this value in as a list, if seeking to calculate on fewer than all available data columns</span>
<span class="sd">        threshold : float</span>
<span class="sd">            threshold value used to filter rows </span>
<span class="sd">        agg : {&#39;count&#39;, &#39;mean&#39;}</span>
<span class="sd">            method to use when aggregating duplicate substrate-sites. </span>
<span class="sd">            &#39;count&#39; combines multiple representations and adds if values are non-NaN</span>
<span class="sd">            &#39;mean&#39; uses the mean value of numerical data from multiple representations of the same peptide.</span>
<span class="sd">                NA values are droped from consideration.</span>
<span class="sd">        greater: Boolean</span>
<span class="sd">            whether to keep sites that have a numerical value &gt;=threshold (TRUE, default) or &lt;=threshold (FALSE)</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        activities : dict</span>
<span class="sd">            key : experiment</span>
<span class="sd">            value : pd DataFrame</span>
<span class="sd">                network : network name, from networks key</span>
<span class="sd">                kinase : kinase examined</span>
<span class="sd">                frequency : number of times kinase was seen in subgraph of evidence and network</span>
<span class="sd">                kinase_activity : hypergeometric kinase activity</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#for each phosphoType, check that the </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aggregate</span> <span class="o">=</span> <span class="n">agg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">greater</span> <span class="o">=</span> <span class="n">greater</span>
        <span class="c1">#self.set_data_columns(data_columns)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">evidence_binary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_binary_evidence</span><span class="p">(</span><span class="n">agg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregate</span><span class="p">,</span> <span class="n">threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span>  <span class="n">greater</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">greater</span><span class="p">)</span>
        
        <span class="c1"># if no data columns are provided use all columns that start with data:</span>
        <span class="c1"># data columns that filtered have no evidence are removed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Kinase Activity will be run on the following data columns: </span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        

        <span class="c1"># MULTIPROCESSING</span>
        <span class="k">if</span> <span class="n">PROCESSES</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span> <span class="o">=</span> <span class="n">PROCESSES</span><span class="p">)</span>
            
            <span class="n">filtered_evidence_list</span>  <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">evidence_binary</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">evidence_binary</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">==</span><span class="mi">1</span> <span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span><span class="p">]</span> 
            <span class="n">networks</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">)</span>  
            <span class="n">network_sizes</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network_sizes</span><span class="p">)</span>
            <span class="n">iterable</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">filtered_evidence_list</span><span class="p">,</span> <span class="n">networks</span><span class="p">,</span> <span class="n">network_sizes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span><span class="p">)</span>
            <span class="n">activities_list</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="n">calculate_hypergeometric_activities</span><span class="p">,</span> <span class="n">iterable</span><span class="p">)</span>
        
        <span class="c1"># SINGLE CORE PROCESSING</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">activities_list</span> <span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span><span class="p">:</span>
                <span class="n">filtered_evidence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evidence_binary</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">evidence_binary</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">act</span> <span class="o">=</span> <span class="n">calculate_hypergeometric_activities</span><span class="p">(</span><span class="n">filtered_evidence</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_sizes</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
                <span class="n">act</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">col</span>
                <span class="n">activities_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">act</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_networks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network_sizes</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">activities_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">activities_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">activities_list</span></div>

    <span class="k">def</span> <span class="nf">summarize_activities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">activities</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;median_activity&#39;</span><span class="p">,</span> <span class="n">normalized</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Builds a single combined dataframe from the provided activities such that </span>
<span class="sd">        each piece of evidence is given a single column. Values are based on the method selected.</span>
<span class="sd">        The method must be a column in the activities</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        activities : dict</span>
<span class="sd">            hypergeometric activities that have previously been summarized by network.</span>
<span class="sd">            key : experiment name</span>
<span class="sd">            value : hypergeometric activity</span>
<span class="sd">        method : str</span>
<span class="sd">            The column in the hypergeometric activity to use for summarizing data</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        ---------</span>
<span class="sd">        activity_summary : pandas DataFrame</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">activities</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">activities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_activities</span>
        <span class="n">available_methods</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">activities</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">available_methods</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">available_methods</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;the method &#39;</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&#39; is not in the availble methods. </span><span class="se">\n</span><span class="s2">Available methods include : </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">available_methods</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


        <span class="n">activity_summary</span> <span class="o">=</span> <span class="n">activities</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_KINASE</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">method</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_KINASE</span><span class="p">)</span>
        <span class="n">activity_summary</span> <span class="o">=</span> <span class="n">activity_summary</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">activity_summary</span>

    <span class="k">def</span> <span class="nf">aggregate_activities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">activities</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Aggregate network activity using median for all activities</span>

<span class="sd">        Parameters</span>
<span class="sd">        ---------</span>
<span class="sd">        activities : dict</span>
<span class="sd">            key : Experiment</span>
<span class="sd">            value : kinase activity result</span>
<span class="sd">        </span>
<span class="sd">        Returns </span>
<span class="sd">        ---------</span>
<span class="sd">        summaries : dict</span>
<span class="sd">            key : experiment</span>
<span class="sd">            value : summarized kinase activities accross networks</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">activities</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">activities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activities_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agg_activities</span> <span class="o">=</span> <span class="n">activities</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_KINASE</span> <span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
            <span class="n">median_activity</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;kinase_activity&#39;</span><span class="p">,</span> <span class="s1">&#39;median&#39;</span><span class="p">),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_activities</span>
    
    <span class="c1">#def normalize_activities(self, activities = None, default_normalization = 0.05, normalization_multiplier = 0.05):</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    Generates the normalized activities and corresponding summary statistics</span>

    <span class="c1">#    Parameters</span>
    <span class="c1">#    ----------</span>
    <span class="c1">#    activities : dict</span>
    <span class="c1">#        hypergeometric activities generated by KSTAR algorithm</span>
    <span class="c1">#        key : experiment</span>
    <span class="c1">#        value : hypergeometric result</span>
    <span class="c1">#    default_normalization: float</span>
    <span class="c1">#        value to normalize to, if no normalizers are set.</span>
        
    <span class="c1">#    Returns</span>
    <span class="c1">#    --------</span>
    <span class="c1">#    normalized_activities : dict</span>
    <span class="c1">#        normalized Kinase Activity results</span>
    <span class="c1">#        key : experiment</span>
    <span class="c1">#        value : normalized results</span>
    <span class="c1">#    summarized_activities : dict</span>
    <span class="c1">#        summary statistics of normalized kinase activity</span>
    <span class="c1">#        key : experiment</span>
    <span class="c1">#        value : summary statistics</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    self.normalized = True</span>
    <span class="c1">#    </span>
    <span class="c1">#    if activities is None:</span>
    <span class="c1">#        activities = self.activities_list</span>
    <span class="c1">#    normalized_activities = []</span>
    <span class="c1">#    for data in self.data_columns:</span>
    <span class="c1">#        if type(self.normalizers) is dict:</span>
    <span class="c1">#            normalizers = self.normalizers</span>
    <span class="c1">#        elif type(self.normalizers) is pd.DataFrame and data #in self.normalizers.columns:</span>
    <span class="c1">#            #print(&quot;setting normalizers&quot;)</span>
    <span class="c1">#            normalizers = self.normalizers[data].to_dict()</span>
    <span class="c1">#        else:</span>
    <span class="c1">#            normalizers = {}</span>
    <span class="c1">#        activity = activities[activities[&#39;data&#39;] == data]</span>
    <span class="c1">#        normalized_activities.append(</span>
    <span class="c1">#            self.calculate_normalized_activity(</span>
    <span class="c1">#                activity, </span>
    <span class="c1">#                normalizers, </span>
    <span class="c1">#                default_normalization, </span>
    <span class="c1">#                normalization_multiplier))</span>
    <span class="c1">#    self.normalized_activities_list = pd.concat(normalized_activities)</span>
    <span class="c1">#    self.aggregate_normalized_activities(self.normalized_activities_list)</span>
        
    <span class="c1">#    return self.normalized_activities_list, self.normalized_agg_activities</span>
    
    
    <span class="c1">#def calculate_normalized_activity(self, kinase_activity, normalizers, default_normalization = 0.05, normalization_multiplier = 0.05):</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    Activity is normalized based on kinase normalization factors. </span>
    <span class="c1">#    Added Columns : </span>
    <span class="c1">#        Normalization Factor : normalization factor for given Kinase</span>
    <span class="c1">#        Significant : 1 if Kinase Activity &lt;= Normalization Factor</span>
    <span class="c1">#        Normalized Activity : ( Kinase Activity ) / ( Normalization Factor ) * Normalization Multiplier</span>

    <span class="c1">#    Parameters</span>
    <span class="c1">#    ----------</span>
    <span class="c1">#    kinase_activity : pandas df</span>
    <span class="c1">#        hypergeometric activity calculated through KSTAR algorithm</span>
    <span class="c1">#    default_normalization : float</span>
    <span class="c1">#        Normalization factor to use if one not provided</span>
    <span class="c1">#    normalization_multiplier : float</span>
    <span class="c1">#        normalization multiplier to use for calculated #normalized kinase activity</span>
    <span class="c1">#    &quot;&quot;&quot;</span>

    <span class="c1">#    normalized_activity = kinase_activity.copy()</span>
    <span class="c1">#    normalized_activity[&#39;Normalization Factor&#39;] = normalized_activity[config.KSTAR_KINASE].apply(lambda name: normalizers[name] if name in normalizers.keys() else default_normalization)</span>
    <span class="c1">#    if len(self.networks) &gt; 0:</span>
    <span class="c1">#        normalized_activity[&#39;Significant&#39;] = normalized_activity.apply(lambda row: (row[&#39;kinase_activity&#39;] &lt;= row[&#39;Normalization Factor&#39;] / len( self.networks ) ) * 1, axis = 1)</span>
    <span class="c1">#    else:</span>
    <span class="c1">#        normalized_activity[&#39;Significant&#39;] = normalized_activity.apply(lambda row: (row[&#39;kinase_activity&#39;] &lt;= row[&#39;Normalization Factor&#39;]) * 1, axis = 1)</span>
    <span class="c1">#    normalized_activity[&#39;Normalized Activity&#39;] = normalized_activity.apply(lambda row: np.clip( row[&#39;kinase_activity&#39;] / row[&#39;Normalization Factor&#39;] * normalization_multiplier, 0.0, 1.0 ), axis = 1)</span>
    <span class="c1">#    return normalized_activity</span>
    
    
    <span class="c1">#def aggregate_normalized_activities(self, normalized_activities):</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    Summarizes normalized kinase activity results of all networks by kinase</span>
    <span class="c1">#    Summaries provided : </span>
    <span class="c1">#        median original activity</span>
    <span class="c1">#        average original activity</span>
    <span class="c1">#        median normalized activity</span>
    <span class="c1">#        average normalized activity</span>
    <span class="c1">#        count significant</span>
    <span class="c1">#        fraction significant</span>
        
    <span class="c1">#    Parameters</span>
    <span class="c1">#    ----------</span>
    <span class="c1">#    normalized_activity : pandas df</span>
    <span class="c1">#        Normalized kinase activty</span>
        
    <span class="c1">#    Returns</span>
    <span class="c1">#    --------</span>
    <span class="c1">#    summary : pandas df</span>
    <span class="c1">#        summarized data of all networks by kinase</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    self.normalized_agg_activities = normalized_activities.groupby([&#39;data&#39;,config.KSTAR_KINASE]).agg(</span>
    <span class="c1">#        median_original_activity = (&#39;kinase_activity&#39;, &#39;median&#39;),</span>
    <span class="c1">#        median_normalized_activity = (&#39;Normalized Activity&#39;, &#39;median&#39;),</span>
    <span class="c1">#        count_significant = (&#39;Significant&#39;, &#39;sum&#39;),</span>
    <span class="c1">#        fraction_significant = (&#39;Significant&#39;, &#39;mean&#39;)</span>
    <span class="c1">#    ).reset_index()</span>
    <span class="c1">#    return self.normalized_agg_activities</span>

<div class="viewcode-block" id="KinaseActivity.find_pvalue_limits"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.KinaseActivity.find_pvalue_limits">[docs]</a>    <span class="k">def</span>  <span class="nf">find_pvalue_limits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_columns</span><span class="p">,</span> <span class="n">agg</span> <span class="o">=</span> <span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="n">threshold</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For each data column and network find the lowest p-value achievable and how many </span>
<span class="sd">        seen sites are required to get to that limit.</span>
<span class="sd">        Assumptions</span>
<span class="sd">            - kinase size in network is same for all kinases</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data_columns : list</span>
<span class="sd">            what columns in evidence to compare</span>
<span class="sd">        agg : str</span>
<span class="sd">            aggregate function - what function to use for determining if site is present</span>
<span class="sd">                count : use when using activity_count</span>
<span class="sd">                mean : use when using activity_threshold</span>
<span class="sd">        threshold : float</span>
<span class="sd">            threshold to use in determining if site present in evidence</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        all_limits : pandas DataFrame</span>
<span class="sd">            p-value limits of each column for each network</span>
<span class="sd">            columns:</span>
<span class="sd">                evidence        evidence data column</span>
<span class="sd">                network         network being compared</span>
<span class="sd">                kinase          kinase being evaluated</span>
<span class="sd">                evidence_size   size of evidence</span>
<span class="sd">                limit_size      number of sites to get non-zero p-value</span>
<span class="sd">                p-value          p-value generated</span>
<span class="sd">        limit_summary : pandas DataFrame</span>
<span class="sd">            summary of all_limits by taking average over by evidence</span>
<span class="sd">        &quot;&quot;&quot;</span>

        
        <span class="n">evidence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evidence</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_ACCESSION</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">agg</span><span class="p">)</span>
        <span class="n">all_rows</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">kinase_sizes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">network</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># kinase_sizes[nid] = network.groupby(config.KSTAR_KINASE).size()</span>
            <span class="n">kinase_sizes</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">network</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_KINASE</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
            

        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">data_columns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
            <span class="n">filtered_evidence</span> <span class="o">=</span> <span class="n">evidence</span><span class="p">[</span><span class="n">evidence</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">]</span>
            <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_evidence</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_ACCESSION</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">M</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_sizes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># kinases = list(kinase_sizes[nid].index)</span>
                <span class="c1"># for kinase in kinases:</span>
                <span class="c1"># n = int(kinase_sizes[nid].loc[kinase])</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">kinase_sizes</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">pvalue</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">hypergeom</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span>
                        <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="p">,</span> 
                        <span class="n">M</span> <span class="o">=</span> <span class="n">M</span><span class="p">,</span> 
                        <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="p">,</span> 
                        <span class="n">N</span> <span class="o">=</span> <span class="n">N</span>
                    <span class="p">)</span>
                    <span class="c1"># pvalue = 1 - prb</span>
                    <span class="k">if</span> <span class="n">pvalue</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="n">row</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;evidence&#39;</span> <span class="p">:</span> <span class="n">col</span><span class="p">,</span>
                    <span class="s1">&#39;network&#39;</span> <span class="p">:</span> <span class="n">nid</span><span class="p">,</span>
                    <span class="c1"># &#39;kinase&#39; : kinase,</span>
                    <span class="s1">&#39;evidence_size&#39;</span> <span class="p">:</span> <span class="n">N</span><span class="p">,</span>
                    <span class="s1">&#39;limit_size&#39;</span> <span class="p">:</span> <span class="n">k</span><span class="p">,</span>
                    <span class="s1">&#39;kinase_size&#39;</span> <span class="p">:</span> <span class="n">n</span><span class="p">,</span>
                    <span class="s1">&#39;network_size&#39;</span> <span class="p">:</span> <span class="n">M</span><span class="p">,</span>
                    <span class="s1">&#39;p-value&#39;</span> <span class="p">:</span> <span class="n">pvalue</span>
                    <span class="p">}</span>
                <span class="n">all_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="n">all_limits</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">all_rows</span><span class="p">)</span>
        <span class="n">limit_summary</span> <span class="o">=</span> <span class="n">all_limits</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;evidence&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">all_limits</span><span class="p">,</span> <span class="n">limit_summary</span></div>

<div class="viewcode-block" id="KinaseActivity.calculate_Mann_Whitney_activities_sig"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.KinaseActivity.calculate_Mann_Whitney_activities_sig">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_Mann_Whitney_activities_sig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">number_sig_trials</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">PROCESSES</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For a kinact_dict, where random generation and activity has already been run for the phospho_types of interest, </span>
<span class="sd">        this will calculate the Mann-Whitney U test for comparing the array of p-values for real data </span>
<span class="sd">        to those of random data, across the number of networks used.</span>
<span class="sd">        It will also calculate the false positive rate for a pvalue, given observations of a random bootstrapping analysis</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        kinact_dict: dictionary</span>
<span class="sd">            A dictionary of kinact objects, with keys &#39;Y&#39; and/or &#39;ST&#39;</span>
<span class="sd">        log: logger </span>
<span class="sd">            Logger for logging activity messages</span>
<span class="sd">        phospho_types: {[&#39;Y&#39;, &#39;ST&#39;], [&#39;Y&#39;], [&#39;ST&#39;]}</span>
<span class="sd">            Which substrate/kinaset-type to run activity for: Both [&#39;Y, &#39;ST&#39;] (default), Tyrosine [&#39;Y&#39;], or Serine/Threonine [&#39;ST&#39;]</span>
<span class="sd">        number_sig_trials: int</span>
<span class="sd">            Maximum number of significant trials to run</span>

<span class="sd">            </span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#First, check that objects are correct and values can be found</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">random_kinact</span><span class="o">.</span><span class="n">activities_list</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Random activities do not exist, please run kstar_activity.normalize_analysis&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">number_sig_trials</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_random_experiments</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Warning: number of trials for Mann Whitney exceeds number available, using </span><span class="si">%d</span><span class="s2"> instead of </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_random_experiments</span><span class="p">,</span> <span class="n">number_sig_trials</span><span class="p">))</span>
            <span class="n">number_sig_trials</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_random_experiments</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">activities_mann_whitney</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">activities</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">activities</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fpr_mann_whitney</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">activities</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">activities</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="c1">#for every kinase and every dataset, calculate and assemble dataframes of activities and significance values</span>

        <span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;MW Working on </span><span class="si">%s</span><span class="s2">: &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">exp</span><span class="p">))</span>

            <span class="c1">#Get a subset of the random and real activites for this experiment</span>
            <span class="n">activities_sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activities_list</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">activities_list</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">exp</span><span class="p">]</span>
            <span class="n">rand_activities_sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_kinact</span><span class="o">.</span><span class="n">activities_list</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">random_kinact</span><span class="o">.</span><span class="n">activities_list</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">exp</span><span class="p">)]</span>

            <span class="n">pval_arr</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">fpr_arr</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">PROCESSES</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">pval</span><span class="p">,</span> <span class="n">fpr</span> <span class="ow">in</span> <span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">calculate_MannWhitney_one_experiment_one_kinase</span><span class="p">,</span> <span class="n">repeat</span><span class="p">(</span><span class="n">activities_sub</span><span class="p">),</span> <span class="n">repeat</span><span class="p">(</span><span class="n">rand_activities_sub</span><span class="p">),</span> <span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_networks</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">activities</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">repeat</span><span class="p">(</span><span class="n">exp</span><span class="p">),</span> <span class="n">repeat</span><span class="p">(</span><span class="n">number_sig_trials</span><span class="p">)):</span>
                    <span class="n">pval_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pval</span><span class="p">)</span>
                    <span class="n">fpr_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fpr</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">activities_mann_whitney</span><span class="p">[</span><span class="n">exp</span><span class="p">]</span> <span class="o">=</span> <span class="n">pval_arr</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fpr_mann_whitney</span><span class="p">[</span><span class="n">exp</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpr_arr</span></div></div>
    




<span class="k">def</span> <span class="nf">calculate_hypergeometric_single_network</span><span class="p">(</span><span class="n">evidence</span><span class="p">,</span> <span class="n">network</span><span class="p">,</span> <span class="n">network_size</span><span class="p">,</span> <span class="n">network_id</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Hypergeometric Cumulative Distribution Function calculated for each kinase given evidence</span>
<span class="sd">            k : number of times kinase seen in evidence</span>
<span class="sd">            M : number of unique sites in network</span>
<span class="sd">            n : number of times kinase seen in network</span>
<span class="sd">            N : size of evidence</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        evidence : pandas df</span>
<span class="sd">            subset of kstar evidence that has been filtered to only include evidence associated with experiment</span>
<span class="sd">        network_id : str</span>
<span class="sd">            network to use for analysis</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        results : pandas df</span>
<span class="sd">            Hypergeometric results of evidence for given network</span>
<span class="sd">            index : kinase_id</span>
<span class="sd">            columns</span>
<span class="sd">                frequency : number of times kinase seen in network</span>
<span class="sd">                kinase_activity : activity derived from hypergometric cdf </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        
        <span class="n">intersect</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">evidence</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span>
            <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_ACCESSION</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="p">])</span>
        
        <span class="n">counts</span> <span class="o">=</span> <span class="n">intersect</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_KINASE</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">intersect</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_ACCESSION</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">])</span>

        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;kinase_activity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="n">K</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_KINASE</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
        
        <span class="n">kinases</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">index</span>
        <span class="k">for</span> <span class="n">kin</span> <span class="ow">in</span> <span class="n">kinases</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">counts</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">kin</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">kin</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">prb</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">hypergeom</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span>
                <span class="n">k</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> 
                <span class="n">M</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">network_size</span><span class="p">),</span> 
                <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">kin</span><span class="p">]),</span> 
                <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">kin</span><span class="p">,</span> <span class="s1">&#39;kinase_activity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prb</span>

        <span class="n">kinases</span> <span class="o">=</span> <span class="n">network</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_KINASE</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">kin</span> <span class="ow">in</span> <span class="n">kinases</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kin</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">kin</span><span class="p">,</span><span class="s1">&#39;frequency&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">results</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">kin</span><span class="p">,</span><span class="s1">&#39;kinase_activity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">network_id</span>
        <span class="k">return</span> <span class="n">results</span>
        
<span class="k">def</span> <span class="nf">calculate_hypergeometric_activities</span><span class="p">(</span><span class="n">evidence</span><span class="p">,</span> <span class="n">networks</span><span class="p">,</span> <span class="n">network_sizes</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform hypergeometric kinase activity analysis given evidence on all networks</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        evidence : pandas df</span>
<span class="sd">            subset of class evidence variable where data is filtered based on experiment</span>
<span class="sd">        name : str</span>
<span class="sd">            name of experiment being performed</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        ---------</span>
<span class="sd">        fdr_act : pd DataFrame</span>
<span class="sd">            network : network name, from networks key</span>
<span class="sd">            frequency : number of times kinase was seen in subgraph of evidence and network</span>
<span class="sd">            kinase_activity : hypergeometric kinase activity</span>
<span class="sd">            fdr_corrected_kinase_activity : kinase activity after fdr correction</span>
<span class="sd">            significant : whether kinase activity is significant based on fdr alpha</span>
<span class="sd">        combined : pd DataFrame</span>
<span class="sd">            significant : number of networks where kinase was found to be significant</span>
<span class="sd">            fraction_significant : fraction of networks kinase was found to be significant through FDR correction</span>
<span class="sd">            avg_p_value : combined p-values of kinase using mean</span>
<span class="sd">            median_p_value : combined p-values of kinase using median</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># self.logger.info(f&quot;Running hypergeometric analysis on {name}&quot;)</span>
        
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">network_id</span> <span class="ow">in</span> <span class="n">networks</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="c1"># calculate kinase activity within each network </span>
            <span class="n">result</span> <span class="o">=</span><span class="n">calculate_hypergeometric_single_network</span><span class="p">(</span><span class="n">evidence</span><span class="p">,</span> <span class="n">networks</span><span class="p">[</span><span class="n">network_id</span><span class="p">],</span> <span class="n">network_sizes</span><span class="p">[</span><span class="n">network_id</span><span class="p">],</span> <span class="n">network_id</span><span class="p">)</span> 
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="c1"># combine results into single dataframe</span>
        <span class="n">hyp_act</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="n">hyp_act</span> <span class="o">=</span> <span class="n">hyp_act</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">hyp_act</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">return</span> <span class="n">hyp_act</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">****************************************</span>
<span class="sd">Methods for Mann Whitney analysis</span>
<span class="sd">****************************************</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">def</span> <span class="nf">calculate_fpr_Mann_Whitney</span><span class="p">(</span><span class="n">random_kinase_activity_array</span><span class="p">,</span> <span class="n">number_sig_trials</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given an mxn array of kinase activities from m random experiments across n networks</span>
<span class="sd">    use bootstrapping to calculate an empirical p-value at which the false positive rate is controlled. </span>
<span class="sd">    This function takes one of m random experiments and calculates the Mann Whitney U pvalue </span>
<span class="sd">    then finds the pvalue at which the target_alpha is achieved</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    random_kinase_activity_array: np.array</span>
<span class="sd">        See calculate_MannWhitney_one_experiment_one_kinase for unwrapping all activities for a kinase and experiment</span>
<span class="sd">    number_sig_trials:</span>
<span class="sd">        Number of random trials to perform, where one random set is tested number_sig_trials against the full background</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    random_stats: np.array </span>
<span class="sd">        A vector of Mann Whitney p-values that is m long, representing pvalues from m bootstrap tests</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#calculate the significance by taking each experiment </span>
    <span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">random_kinase_activity_array</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">number_sig_trials</span> <span class="o">&gt;</span> <span class="n">m</span><span class="p">:</span> 
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning, using </span><span class="si">%d</span><span class="s2">, maximum number for significance&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
        <span class="n">number_sig_trials</span> <span class="o">=</span> <span class="n">m</span>
    <span class="n">random_stats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">number_sig_trials</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">number_sig_trials</span><span class="p">):</span>
        <span class="c1">#take out one vector as real</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="n">random_kinase_activity_array</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
        <span class="n">bgnd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">random_kinase_activity_array</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">#remove the sample before testing</span>
        <span class="p">[</span><span class="n">stat</span><span class="p">,</span> <span class="n">random_stats</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">mannwhitneyu</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">sample</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">bgnd</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">bgnd</span><span class="o">.</span><span class="n">size</span><span class="p">)),</span> <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;greater&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">random_stats</span>

<span class="k">def</span> <span class="nf">calculate_MannWhitney_one_experiment_one_kinase</span><span class="p">(</span><span class="n">kinact_activities</span><span class="p">,</span> <span class="n">rand_activities</span><span class="p">,</span> <span class="n">number_networks</span><span class="p">,</span> <span class="n">kinase</span><span class="p">,</span> <span class="n">experiment</span><span class="p">,</span> <span class="n">number_sig_trials</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For a given kinact object, where random generation and activity has already been run, this will calculate</span>
<span class="sd">    the Mann-Whitney U test between the p-values across all networks for the given experiment name </span>
<span class="sd">    and from the random networks. It will also calculate the significance value for the given test </span>
<span class="sd">    based on the target_alpha value by using each random set as a real set to bootstrap. </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kinact: kinact object</span>
<span class="sd">        A kinact object (not a dictionary)</span>
<span class="sd">    kinase: str</span>
<span class="sd">        Kinase name to measure significance for</span>
<span class="sd">    experiment: str</span>
<span class="sd">        Experiment name to measure significance for</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    p-value: float</span>
<span class="sd">        p-value that results from Mann Whitney U test</span>
<span class="sd">    fpr_value: float</span>
<span class="sd">        the false positive rate where the p_value for the real experiment lies, given the random experiments</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    
    <span class="n">kinase_activity_list</span> <span class="o">=</span> <span class="n">kinact_activities</span><span class="p">[(</span><span class="n">kinact_activities</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_KINASE</span><span class="p">]</span><span class="o">==</span><span class="n">kinase</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">kinact_activities</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">experiment</span><span class="p">)]</span><span class="o">.</span><span class="n">kinase_activity</span><span class="o">.</span><span class="n">values</span>
    
    <span class="n">random_kinase_activity_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">number_sig_trials</span><span class="p">,</span> <span class="n">number_networks</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">number_sig_trials</span><span class="p">):</span>
        <span class="c1"># get the kinase activity values for all networks for a random set</span>
        <span class="n">experiment_name</span> <span class="o">=</span> <span class="n">experiment</span><span class="o">+</span><span class="s1">&#39;:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">random_kinase_activity_array</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">=</span><span class="n">rand_activities</span><span class="p">[(</span><span class="n">rand_activities</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_KINASE</span><span class="p">]</span><span class="o">==</span><span class="n">kinase</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">rand_activities</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">experiment_name</span><span class="p">)]</span><span class="o">.</span><span class="n">kinase_activity</span><span class="o">.</span><span class="n">values</span>
       
    <span class="p">[</span><span class="n">stat</span><span class="p">,</span> <span class="n">p_value</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">mannwhitneyu</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">kinase_activity_list</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">random_kinase_activity_array</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">random_kinase_activity_array</span><span class="o">.</span><span class="n">size</span><span class="p">)),</span> <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;greater&#39;</span><span class="p">)</span>
    
    <span class="n">randomStats</span> <span class="o">=</span> <span class="n">calculate_fpr_Mann_Whitney</span><span class="p">(</span><span class="n">random_kinase_activity_array</span><span class="p">,</span> <span class="n">number_sig_trials</span><span class="p">)</span>
    
    <span class="c1">#sig_value = calculate_fpr.single_experiment_kinase_fpr(randomStats, target_alpha)</span>
    <span class="n">fpr_value</span> <span class="o">=</span> <span class="n">calculate_fpr</span><span class="o">.</span><span class="n">single_pvalue_fpr</span><span class="p">(</span><span class="n">randomStats</span><span class="p">,</span> <span class="n">p_value</span><span class="p">)</span>
    <span class="c1">#sig_value = 1</span>
    
    <span class="k">return</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">fpr_value</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">****************************************</span>
<span class="sd">Methods for running KSTAR pipeline</span>
<span class="sd">****************************************</span>
<span class="sd">&quot;&quot;&quot;</span>
<div class="viewcode-block" id="enrichment_analysis"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.enrichment_analysis">[docs]</a><span class="k">def</span> <span class="nf">enrichment_analysis</span><span class="p">(</span><span class="n">experiment</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">networks</span><span class="p">,</span> <span class="n">phospho_types</span> <span class="o">=</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;ST&#39;</span><span class="p">],</span> <span class="n">data_columns</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">agg</span> <span class="o">=</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">threshold</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>  <span class="n">greater</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">PROCESSES</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to establish a kstar KinaseActivity object from an experiment with an activity log</span>
<span class="sd">    add the networks, calculate, aggregate, and summarize the hypergeometric enrichment into a final activity object. Should be followed by </span>
<span class="sd">    randomized_analyis, then Mann_Whitney_analysis.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    experiment: pandas df</span>
<span class="sd">        experiment dataframe that has been mapped, includes KSTAR_SITE, KSTAR_ACCESSION, etc.</span>
<span class="sd">    log: logger object</span>
<span class="sd">        Log to write activity log error and update to</span>
<span class="sd">    networks: dictionary of dictionaries</span>
<span class="sd">        Outer dictionary keys are &#39;Y&#39; and &#39;ST&#39;.</span>
<span class="sd">        Establish a network by loading a pickle of desired networks. See the helpers and config file for this.</span>
<span class="sd">        If downloaded from FigShare, then the GLOBAL network pickles in config file can be loaded</span>
<span class="sd">        For example: networks[&#39;Y&#39;] = pickle.load(open(config.NETWORK_Y_PICKLE, &quot;rb&quot; ))</span>
<span class="sd">    phospho_types: {[&#39;Y&#39;, &#39;ST&#39;], [&#39;Y&#39;], [&#39;ST&#39;]}</span>
<span class="sd">        Which substrate/kinaset-type to run activity for: Both [&#39;Y, &#39;ST&#39;] (default), Tyrosine [&#39;Y&#39;], or Serine/Threonine [&#39;ST&#39;]</span>
<span class="sd">    data_columns : list</span>
<span class="sd">        columns that represent experimental result, if None, takes the columns that start with `data:&#39;&#39; in experiment. </span>
<span class="sd">        Pass this value in as a list, if seeking to calculate on fewer than all available data columns</span>
<span class="sd">    agg : {&#39;count&#39;, &#39;mean&#39;}</span>
<span class="sd">        method to use when aggregating duplicate substrate-sites. </span>
<span class="sd">        &#39;count&#39; combines multiple representations and adds if values are non-NaN</span>
<span class="sd">        &#39;mean&#39; uses the mean value of numerical data from multiple representations of the same peptide.</span>
<span class="sd">            NA values are droped from consideration.</span>
<span class="sd">    threshold : float</span>
<span class="sd">        threshold value used to filter rows</span>
<span class="sd">    greater: Boolean</span>
<span class="sd">        whether to keep sites that have a numerical value &gt;=threshold (TRUE, default) or &lt;=threshold (FALSE)</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    kinactDict: dictionary of Kinase Activity Objects</span>
<span class="sd">        Outer keys are phosphoTypes run &#39;Y&#39; and &#39;ST&#39;</span>
<span class="sd">        Includes the activities dictionary (see calculate_kinase_activities)</span>
<span class="sd">        aggregation of activities across networks (see aggregate activities)</span>
<span class="sd">        activity summary (see summarize_activities)</span>

<span class="sd">    &quot;&quot;&quot;</span>


    <span class="n">kinact_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># For each phosphoType of interest, establish a kinase activity object on a filtered dataset and run, aggregate, and summarize activity</span>
    <span class="k">for</span> <span class="n">phospho_type</span> <span class="ow">in</span> <span class="n">phospho_types</span><span class="p">:</span>
        <span class="c1">#first check that networks for the phosphotypes were passed in</span>
        <span class="k">if</span> <span class="n">phospho_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">networks</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR: Please pass networks as dictionary with phosphotype key&quot;</span><span class="p">)</span>
        <span class="c1">#filter the experiment (log how many are of that type)</span>
        <span class="k">if</span> <span class="n">phospho_type</span> <span class="o">==</span> <span class="s1">&#39;ST&#39;</span><span class="p">:</span>
            <span class="n">experiment_sub</span> <span class="o">=</span> <span class="n">experiment</span><span class="p">[(</span><span class="n">experiment</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;S&#39;</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">experiment</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">))]</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running Serine/Threonine Kinase Activity Analysis&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">phospho_type</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span>
            <span class="n">experiment_sub</span> <span class="o">=</span> <span class="n">experiment</span><span class="p">[(</span><span class="n">experiment</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">))]</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running Tyrosine Kinase Activity Analysis&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR: Did not recognize phosphoType </span><span class="si">%s</span><span class="s2">, which should only include &#39;Y&#39; or &#39;ST&#39; &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">phospho_type</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="n">kinact</span> <span class="o">=</span> <span class="n">KinaseActivity</span><span class="p">(</span><span class="n">experiment_sub</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">data_columns</span> <span class="o">=</span> <span class="n">data_columns</span><span class="p">,</span> <span class="n">phospho_type</span><span class="o">=</span><span class="n">phospho_type</span><span class="p">)</span>
        <span class="n">kinact</span><span class="o">.</span><span class="n">add_networks_batch</span><span class="p">(</span><span class="n">networks</span><span class="p">[</span><span class="n">phospho_type</span><span class="p">])</span>
        <span class="n">kinact</span><span class="o">.</span><span class="n">calculate_kinase_activities</span><span class="p">(</span><span class="n">agg</span><span class="o">=</span><span class="n">agg</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span> <span class="n">greater</span><span class="o">=</span><span class="n">greater</span><span class="p">,</span> <span class="n">PROCESSES</span> <span class="o">=</span> <span class="n">PROCESSES</span><span class="p">)</span>
        <span class="n">kinact</span><span class="o">.</span><span class="n">aggregate_activities</span><span class="p">()</span>
        <span class="n">kinact</span><span class="o">.</span><span class="n">activities</span> <span class="o">=</span> <span class="n">kinact</span><span class="o">.</span><span class="n">summarize_activities</span><span class="p">()</span>
        <span class="n">kinact_dict</span><span class="p">[</span><span class="n">phospho_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">kinact</span>
    <span class="k">return</span> <span class="n">kinact_dict</span></div>

<span class="c1">#def normalize_analysis(kinact_dict, log, num_random_experiments=150, target_alpha = 0.05, PROCESSES = 1):</span>
<span class="c1">#    &quot;&quot;&quot;</span>
<span class="c1">#    Creates random experiments, drawn from the human phosphoproteome, according to the distribution of the number of compendia</span>
<span class="c1">#    that each data column in the experiment has for num_random_experiments. Kinase activity calculation is then run on every random experiment</span>
<span class="c1">#    and then assembled for each data column to calculate the pvalue at which a kinase hits the target_alpha value of false positives. </span>
<span class="c1">#    Finally, it takes these empirically defined pvalue corrections and normalizes the kinase activities according to these, such that</span>
<span class="c1">#    the real experimental data also has the target_alpha value. </span>
<span class="c1">#</span>
<span class="c1">#    Parameters</span>
<span class="c1">#    ----------</span>
<span class="c1">#    kinact_dict: KinaseActivities dictionary</span>
<span class="c1">#        Has keys [&#39;Y&#39;] and/or [&#39;ST&#39;] and values that are KinaseActivity objects. These objects are modified to add normalization</span>
<span class="c1">#    log: logger </span>
<span class="c1">#        Logger for logging activity messages</span>
<span class="c1">#    num_random_experiments: int</span>
<span class="c1">#        Number of random experiments, for each data column, to create and run activity from</span>
<span class="c1">#    target_alpha: float </span>
<span class="c1">#        Value between 0 and 1 that is the target false positive rate. </span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#    &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#    if target_alpha &gt; 1 or target_alpha &lt; 0: </span>
<span class="c1">#        raise ValueError(&#39;ERROR: target_alpha must be value between 0 and 1&#39;)</span>
<span class="c1">#</span>
<span class="c1">#    for phospho_type, kinact in kinact_dict.items():</span>
<span class="c1">#        kinact.run_normalization(log, num_random_experiments, target_alpha, PROCESSES = PROCESSES)</span>
        
<div class="viewcode-block" id="randomized_analysis"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.randomized_analysis">[docs]</a><span class="k">def</span> <span class="nf">randomized_analysis</span><span class="p">(</span><span class="n">kinact_dict</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">num_random_experiments</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">PROCESSES</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates random experiments, drawn from the human phosphoproteome, according to the distribution of the number of compendia</span>
<span class="sd">    that each data column in the experiment has for num_random_experiments. Kinase activity calculation is then run on every random experiment. </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kinact_dict: KinaseActivities dictionary</span>
<span class="sd">        Has keys [&#39;Y&#39;] and/or [&#39;ST&#39;] and values that are KinaseActivity objects. These objects are modified to add normalization</span>
<span class="sd">    log: logger </span>
<span class="sd">        Logger for logging activity messages</span>
<span class="sd">    num_random_experiments: int</span>
<span class="sd">        Number of random experiments, for each data column, to create and run activity from</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">phospho_type</span><span class="p">,</span> <span class="n">kinact</span> <span class="ow">in</span> <span class="n">kinact_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">kinact</span><span class="o">.</span><span class="n">calculate_random_activities</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="n">num_random_experiments</span><span class="p">,</span> <span class="n">PROCESSES</span> <span class="o">=</span> <span class="n">PROCESSES</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="Mann_Whitney_analysis"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.Mann_Whitney_analysis">[docs]</a><span class="k">def</span> <span class="nf">Mann_Whitney_analysis</span><span class="p">(</span><span class="n">kinact_dict</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">number_sig_trials</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">PROCESSES</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For a kinact_dict, where random generation and activity has already been run for the phospho_types of interest, </span>
<span class="sd">    this will calculate the Mann-Whitney U test for comparing the array of p-values for real data </span>
<span class="sd">    to those of random data, across the number of networks used.</span>
<span class="sd">    It will also calculate the false positive rate for a pvalue, given observations of a random bootstrapping analysis</span>
<span class="sd">        </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kinact_dict: dictionary</span>
<span class="sd">        A dictionary of kinact objects, with keys &#39;Y&#39; and/or &#39;ST&#39;</span>
<span class="sd">    log: logger </span>
<span class="sd">        Logger for logging activity messages</span>
<span class="sd">    number_sig_trials: int</span>
<span class="sd">        Maximum number of significant trials to run</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">phospho_type</span><span class="p">,</span> <span class="n">kinact</span> <span class="ow">in</span> <span class="n">kinact_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">kinact</span><span class="o">.</span><span class="n">calculate_Mann_Whitney_activities_sig</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="n">number_sig_trials</span> <span class="o">=</span> <span class="n">number_sig_trials</span><span class="p">,</span> <span class="n">PROCESSES</span> <span class="o">=</span> <span class="n">PROCESSES</span><span class="p">)</span></div>
        
    
        
    
<div class="viewcode-block" id="save_kstar"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.save_kstar">[docs]</a><span class="k">def</span> <span class="nf">save_kstar</span><span class="p">(</span><span class="n">kinact_dict</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">odir</span><span class="p">,</span> <span class="n">PICKLE</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Having performed kinase activities (run_kstar_analyis), save each of the important dataframes to files and the final pickle</span>
<span class="sd">        Saves an activities, aggregated_activities, summarized_activities tab-separated files</span>
<span class="sd">        Saves a pickle file of dictionary </span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        kinact_dict: dictionary of Kinase Activity Objects</span>
<span class="sd">            Outer keys are phosphoTypes run &#39;Y&#39; and &#39;ST&#39;</span>
<span class="sd">            Includes the activities dictionary (see calculate_kinase_activities)</span>
<span class="sd">            aggregation of activities across networks (see aggregate activities)</span>
<span class="sd">            activity summary (see summarize_activities)</span>
<span class="sd">        name: string </span>
<span class="sd">            The name to use when saving activities</span>
<span class="sd">        odir:  string</span>
<span class="sd">            Outputdirectory to save files and pickle to</span>
<span class="sd">        PICKLE: boolean</span>
<span class="sd">            Whether to save the entire pickle file </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Nothing</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS&quot;</span><span class="p">):</span> 
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS&quot;</span><span class="p">)</span> 
        
        <span class="k">for</span> <span class="n">phospho_type</span> <span class="ow">in</span> <span class="n">kinact_dict</span><span class="p">:</span>
            <span class="n">kinact</span> <span class="o">=</span> <span class="n">kinact_dict</span><span class="p">[</span><span class="n">phospho_type</span><span class="p">]</span>
            <span class="n">name_out</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">phospho_type</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">kinact</span><span class="o">.</span><span class="n">activities_list</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name_out</span><span class="si">}</span><span class="s2">_activities_list.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">kinact</span><span class="o">.</span><span class="n">agg_activities</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name_out</span><span class="si">}</span><span class="s2">_aggregated_activities.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">kinact</span><span class="o">.</span><span class="n">activities</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name_out</span><span class="si">}</span><span class="s2">_activities.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">kinact</span><span class="o">.</span><span class="n">evidence_binary</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name_out</span><span class="si">}</span><span class="s2">_binarized_experiment.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">kinact</span><span class="p">,</span> <span class="s1">&#39;random_kinact&#39;</span><span class="p">):</span>
                <span class="n">kinact</span><span class="o">.</span><span class="n">random_kinact</span><span class="o">.</span><span class="n">activities_list</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name_out</span><span class="si">}</span><span class="s2">_random_activities_list.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">kinact</span><span class="o">.</span><span class="n">random_kinact</span><span class="o">.</span><span class="n">agg_activities</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name_out</span><span class="si">}</span><span class="s2">_random_aggregated_activities.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">kinact</span><span class="o">.</span><span class="n">random_kinact</span><span class="o">.</span><span class="n">activities</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name_out</span><span class="si">}</span><span class="s2">_random_activities.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                <span class="n">kinact</span><span class="o">.</span><span class="n">random_experiments</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name_out</span><span class="si">}</span><span class="s2">_random_experiments.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">kinact</span><span class="o">.</span><span class="n">random_kinact</span><span class="o">.</span><span class="n">evidence</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name_out</span><span class="si">}</span><span class="s2">_random_experiments.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
                
            <span class="c1">#if kinact.normalized:</span>

            <span class="c1">#    kinact.normalized_activities_list.to_csv(f&quot;{odir}/RESULTS/{name_out}_normalized_activities_list.tsv&quot;, sep = &#39;\t&#39;, index = True)</span>
            <span class="c1">#    kinact.normalized_agg_activities.to_csv(f&quot;{odir}/RESULTS/{name_out}_normalized_aggregated_activities.tsv&quot;, sep = &#39;\t&#39;, index = True)</span>
            <span class="c1">#    kinact.activities_normalized.to_csv(f&quot;{odir}/RESULTS/{name_out}_activities_normalized.tsv&quot;, sep = &#39;\t&#39;, index = True)</span>
            <span class="c1">#    kinact.fpr_activity.to_csv(f&quot;{odir}/RESULTS/{name_out}_activities_fpr.tsv&quot;, sep=&#39;\t&#39;, index=True)</span>


            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">kinact</span><span class="p">,</span> <span class="s1">&#39;activities_mann_whitney&#39;</span><span class="p">):</span>
                <span class="n">kinact</span><span class="o">.</span><span class="n">activities_mann_whitney</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name_out</span><span class="si">}</span><span class="s2">_mann_whitney_activities.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> 
                <span class="n">kinact</span><span class="o">.</span><span class="n">fpr_mann_whitney</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name_out</span><span class="si">}</span><span class="s2">_mann_whitney_fpr.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> 

        <span class="k">if</span> <span class="n">PICKLE</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span> <span class="n">kinact_dict</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_kinact.p&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span> <span class="p">)</span> <span class="p">)</span></div>

<div class="viewcode-block" id="save_kstar_slim"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.save_kstar_slim">[docs]</a><span class="k">def</span> <span class="nf">save_kstar_slim</span><span class="p">(</span><span class="n">kinact_dict</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">odir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Having performed kinase activities (run_kstar_analyis), save each of the important dataframes, minimizing the memory storage needed to get back </span>
<span class="sd">    to a rebuilt version for plotting results and analysis. For each phospho_type in the kinact_dict, this will save three .tsv files for every activities</span>
<span class="sd">    analysis run, two additional if random analysis was run, and two more if Mann Whitney based analysis was run. It also creates a readme file of the parameter values </span>
<span class="sd">    used </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kinact_dict: dictionary of Kinase Activity Objects</span>
<span class="sd">        Outer keys are phosphoTypes run &#39;Y&#39; and &#39;ST&#39;</span>
<span class="sd">        Includes the activities dictionary (see calculate_kinase_activities)</span>
<span class="sd">        aggregation of activities across networks (see aggregate activities)</span>
<span class="sd">        activity summary (see summarize_activities)</span>
<span class="sd">    name: string </span>
<span class="sd">        The name to use when saving activities</span>
<span class="sd">    odir:  string</span>
<span class="sd">        Outputdirectory to save files and pickle to</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Nothing</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS&quot;</span><span class="p">):</span> 
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS&quot;</span><span class="p">)</span> 


    <span class="n">param_dict</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">for</span> <span class="n">phospho_type</span> <span class="ow">in</span> <span class="n">kinact_dict</span><span class="p">:</span>

        <span class="n">kinact</span> <span class="o">=</span> <span class="n">kinact_dict</span><span class="p">[</span><span class="n">phospho_type</span><span class="p">]</span>
        <span class="n">name_out</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">phospho_type</span><span class="si">}</span><span class="s2">&quot;</span>


        <span class="n">param_temp</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">param_temp</span><span class="p">[</span><span class="s1">&#39;data_columns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kinact</span><span class="o">.</span><span class="n">data_columns</span>
        <span class="n">param_temp</span><span class="p">[</span><span class="s1">&#39;aggregate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kinact</span><span class="o">.</span><span class="n">aggregate</span>
        <span class="n">param_temp</span><span class="p">[</span><span class="s1">&#39;greater&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kinact</span><span class="o">.</span><span class="n">greater</span>
        <span class="n">param_temp</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kinact</span><span class="o">.</span><span class="n">threshold</span>
        <span class="n">param_temp</span><span class="p">[</span><span class="s1">&#39;run_date&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">kinact</span><span class="o">.</span><span class="n">run_date</span>
        <span class="n">param_temp</span><span class="p">[</span><span class="s1">&#39;mann_whitney&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">param_temp</span><span class="p">[</span><span class="s1">&#39;randomized&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">param_temp</span><span class="p">[</span><span class="s1">&#39;num_networks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kinact</span><span class="o">.</span><span class="n">num_networks</span>
        <span class="n">param_temp</span><span class="p">[</span><span class="s1">&#39;network_directory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kinact</span><span class="o">.</span><span class="n">network_directory</span>


        <span class="n">kinact</span><span class="o">.</span><span class="n">activities_list</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name_out</span><span class="si">}</span><span class="s2">_activities_list.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">kinact</span><span class="o">.</span><span class="n">activities</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name_out</span><span class="si">}</span><span class="s2">_activities.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">kinact</span><span class="o">.</span><span class="n">evidence_binary</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name_out</span><span class="si">}</span><span class="s2">_binarized_experiment.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1">#if kinact.normalized:</span>
        <span class="c1">#    param_temp[&#39;normalized&#39;] = True</span>
        <span class="c1">#    kinact.activities_normalized.to_csv(f&quot;{odir}/RESULTS/{name_out}_activities_normalized.tsv&quot;, sep = &#39;\t&#39;, index = True)</span>
        <span class="c1">#    kinact.fpr_activity.to_csv(f&quot;{odir}/RESULTS/{name_out}_activities_fpr.tsv&quot;, sep=&#39;\t&#39;, index=True)</span>
            
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">kinact</span><span class="p">,</span> <span class="s1">&#39;random_kinact&#39;</span><span class="p">):</span>
            <span class="n">param_temp</span><span class="p">[</span><span class="s1">&#39;randomized&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">param_temp</span><span class="p">[</span><span class="s1">&#39;num_random_experiments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kinact</span><span class="o">.</span><span class="n">num_random_experiments</span>
            <span class="n">kinact</span><span class="o">.</span><span class="n">random_kinact</span><span class="o">.</span><span class="n">activities_list</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name_out</span><span class="si">}</span><span class="s2">_random_activities_list.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">kinact</span><span class="o">.</span><span class="n">random_kinact</span><span class="o">.</span><span class="n">evidence</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name_out</span><span class="si">}</span><span class="s2">_random_experiments.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">kinact</span><span class="p">,</span> <span class="s1">&#39;activities_mann_whitney&#39;</span><span class="p">):</span>
            <span class="n">param_temp</span><span class="p">[</span><span class="s1">&#39;mann_whitney&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">kinact</span><span class="o">.</span><span class="n">activities_mann_whitney</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name_out</span><span class="si">}</span><span class="s2">_mann_whitney_activities.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> 
            <span class="n">kinact</span><span class="o">.</span><span class="n">fpr_mann_whitney</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name_out</span><span class="si">}</span><span class="s2">_mann_whitney_fpr.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> 

        <span class="n">param_dict</span><span class="p">[</span><span class="n">phospho_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_temp</span>

    <span class="c1">#save the parameters in a pickle file for reinstantiating object information</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">param_dict</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_params.p&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">))</span></div>


<div class="viewcode-block" id="from_kstar_slim"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.from_kstar_slim">[docs]</a><span class="k">def</span> <span class="nf">from_kstar_slim</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">odir</span><span class="p">,</span> <span class="n">log</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given the name and output directory of a saved kstar analyis, load the parameters and minimum dataframes needed for reinstantiating a kinact object</span>
<span class="sd">    This minimum list will allow you to repeat normalization or mann whitney at a different false positive rate threshold and plot results.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name: string </span>
<span class="sd">        The name to used when saving activities and mapped data</span>
<span class="sd">    odir:  string</span>
<span class="sd">        Output directory of saved files and parameter pickle</span>
<span class="sd">    log: logger </span>
<span class="sd">        Logger for logging activity messages</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#First check for the param file</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">param_dict</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_params.p&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR: Cannot find parameter dictionary file in RESULTS: </span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_params.p&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR: Cannot find parameter dictionary file in RESULTS: </span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_params.p&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">kinact_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">phospho_type</span> <span class="ow">in</span> <span class="n">param_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">param_dict</span><span class="p">[</span><span class="n">phospho_type</span><span class="p">]</span>
        <span class="n">name_out</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">phospho_type</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="c1">#instantiate an object and update values according to </span>

        <span class="c1">#check that the minimum file set exists so we can use binary_evidence file as the experiment</span>
        <span class="n">evidence_binary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name_out</span><span class="si">}</span><span class="s2">_binarized_experiment.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>


        <span class="n">kinact</span> <span class="o">=</span> <span class="n">KinaseActivity</span><span class="p">(</span><span class="n">evidence_binary</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">phospho_type</span><span class="o">=</span><span class="n">phospho_type</span><span class="p">)</span>

        <span class="n">kinact</span><span class="o">.</span><span class="n">activities_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name_out</span><span class="si">}</span><span class="s2">_activities_list.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index_col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">kinact</span><span class="o">.</span><span class="n">activities</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name_out</span><span class="si">}</span><span class="s2">_activities.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index_col</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_KINASE</span><span class="p">)</span>
        <span class="n">kinact</span><span class="o">.</span><span class="n">evidence_binary</span> <span class="o">=</span> <span class="n">evidence_binary</span>

        <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;mann_whitney&#39;</span><span class="p">]:</span>
            <span class="c1">#read mann_whitney and load</span>
            <span class="n">kinact</span><span class="o">.</span><span class="n">activities_mann_whitney</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name_out</span><span class="si">}</span><span class="s2">_mann_whitney_activities.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index_col</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_KINASE</span><span class="p">)</span> 
            <span class="n">kinact</span><span class="o">.</span><span class="n">fpr_mann_whitney</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name_out</span><span class="si">}</span><span class="s2">_mann_whitney_fpr.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index_col</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_KINASE</span><span class="p">)</span> 
            <span class="n">params</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;mann_whitney&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            
        <span class="c1">#if params[&#39;normalized&#39;]:</span>
        <span class="c1">#    kinact.activities_normalized= pd.read_csv(f&quot;{odir}/RESULTS/{name_out}_activities_normalized.tsv&quot;, sep = &#39;\t&#39;, index_col = config.KSTAR_KINASE)</span>
        <span class="c1">#    kinact.fpr_activity = pd.read_csv(f&quot;{odir}/RESULTS/{name_out}_activities_fpr.tsv&quot;, sep=&#39;\t&#39;, index_col=config.KSTAR_KINASE)</span>
        
        <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;randomized&#39;</span><span class="p">]:</span>
            <span class="n">rand_experiments</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name_out</span><span class="si">}</span><span class="s2">_random_experiments.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">kinact</span><span class="o">.</span><span class="n">random_kinact</span> <span class="o">=</span> <span class="n">KinaseActivity</span><span class="p">(</span><span class="n">rand_experiments</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">phospho_type</span><span class="o">=</span><span class="n">phospho_type</span><span class="p">)</span>
            <span class="n">kinact</span><span class="o">.</span><span class="n">random_kinact</span><span class="o">.</span><span class="n">activities_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name_out</span><span class="si">}</span><span class="s2">_random_activities_list.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">kinact</span><span class="o">.</span><span class="n">random_kinact</span><span class="o">.</span><span class="n">evidence</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name_out</span><span class="si">}</span><span class="s2">_random_experiments.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1">#set data columns according to file</span>
            <span class="n">kinact</span><span class="o">.</span><span class="n">random_kinact</span><span class="o">.</span><span class="n">set_data_columns</span><span class="p">(</span><span class="n">data_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>


        <span class="k">for</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">kinact</span><span class="p">,</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="n">param_name</span><span class="p">])</span>
        <span class="n">kinact_dict</span><span class="p">[</span><span class="n">phospho_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">kinact</span>
    <span class="k">return</span> <span class="n">kinact_dict</span></div>
    
<div class="viewcode-block" id="from_kstar_nextflow"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.from_kstar_nextflow">[docs]</a><span class="k">def</span> <span class="nf">from_kstar_nextflow</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">odir</span><span class="p">,</span> <span class="n">log</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given the name and output directory of a saved kstar analyis from the nextflow pipeline, load the results into new kinact object with</span>
<span class="sd">    the minimum dataframes required for analysis (binary experiment, hypergeometric activities, normalized activities, mann whitney activities)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name: string </span>
<span class="sd">        The name to used when saving activities and mapped data</span>
<span class="sd">    odir:  string</span>
<span class="sd">        Output directory of saved files</span>
<span class="sd">    log: logger</span>
<span class="sd">        logger used when loading nextflow data into kinase activity object. If not provided, new logger will be created.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#create new logger if not provided</span>
    <span class="k">if</span> <span class="n">log</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;activity_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/activity_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.log&quot;</span><span class="p">)</span>
    
    <span class="n">kinact_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">phospho_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;ST&#39;</span><span class="p">]:</span>
        <span class="c1">#check to see if folder for phosphotype is present (have Y or ST activities been calculated)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">phospho_type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="c1">#check that the minimum file set exists so we can use binary_evidence file as the experiment</span>
            <span class="n">evidence_binary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">phospho_type</span><span class="si">}</span><span class="s2">/binary_experiment/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_binarized_experiment.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>


            <span class="n">kinact</span> <span class="o">=</span> <span class="n">KinaseActivity</span><span class="p">(</span><span class="n">evidence_binary</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">phospho_type</span><span class="o">=</span><span class="n">phospho_type</span><span class="p">)</span>

            <span class="n">kinact</span><span class="o">.</span><span class="n">activities_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">phospho_type</span><span class="si">}</span><span class="s2">/hypergeometric_activity/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_activities_list.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index_col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">kinact</span><span class="o">.</span><span class="n">activities</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">phospho_type</span><span class="si">}</span><span class="s2">/hypergeometric_activity/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_activities.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index_col</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_KINASE</span><span class="p">)</span>
            <span class="n">kinact</span><span class="o">.</span><span class="n">evidence_binary</span> <span class="o">=</span> <span class="n">evidence_binary</span>

            <span class="c1">#read mann_whitney and load</span>
            <span class="n">kinact</span><span class="o">.</span><span class="n">activities_mann_whitney</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">phospho_type</span><span class="si">}</span><span class="s2">/mann_whitney/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_mann_whitney_activities.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index_col</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_KINASE</span><span class="p">)</span> 
            <span class="n">kinact</span><span class="o">.</span><span class="n">fpr_mann_whitney</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">phospho_type</span><span class="si">}</span><span class="s2">/mann_whitney/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_mann_whitney_fpr.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index_col</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_KINASE</span><span class="p">)</span> 
            <span class="c1">#rand_experiments = pd.read_csv(f&quot;{odir}/{phospho_type}/{name_out}_random_experiments.tsv&quot;, sep = &#39;\t&#39;)</span>
            <span class="c1">#kinact.random_kinact = KinaseActivity(rand_experiments, log, phospho_type=phospho_type)</span>
            <span class="c1">#kinact.random_kinact.activities_list = pd.read_csv(f&quot;{odir}/{phospho_type}/{name}_random_activities_list.tsv&quot;, sep = &#39;\t&#39;, index_col=0)</span>
            <span class="c1">#kinact.random_kinact.evidence = pd.read_csv(f&quot;{odir}/{phospho_type}/{name_out}_random_experiments.tsv&quot;, sep = &#39;\t&#39;)</span>
            <span class="c1">#set data columns according to file</span>
            <span class="c1">#kinact.random_kinact.set_data_columns(data_columns=None)</span>

            <span class="n">kinact_dict</span><span class="p">[</span><span class="n">phospho_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">kinact</span>
            
    
    <span class="c1">#check to see if any files were loaded</span>
    <span class="k">if</span> <span class="n">kinact_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;KSTAR results were not found for either Y or ST&#39;</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">kinact_dict</span></div>













</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table of Contents</a></h3>
  <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Dependencies.html">Dependencies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../KSTAR.html">KSTAR</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Tutorial/tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Examples/Examples.html">Analysis Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Parallel/parallel.html">KSTAR in Parallel</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">KSTAR 1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">kstar.calculate</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, Naegle Lab.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.0.1.
    </div>
  </body>
</html>