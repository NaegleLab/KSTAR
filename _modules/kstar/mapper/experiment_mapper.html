
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>kstar.mapper.experiment_mapper &#8212; KSTAR 1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/classic.css" />
    
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">KSTAR 1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">kstar.mapper.experiment_mapper</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for kstar.mapper.experiment_mapper</h1><div class="highlight"><pre>
<span></span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">kstar</span> <span class="kn">import</span> <span class="n">config</span><span class="p">,</span> <span class="n">helpers</span>



<div class="viewcode-block" id="ExperimentMapper"><a class="viewcode-back" href="../../../KSTAR.html#kstar.mapper.experiment_mapper.ExperimentMapper">[docs]</a><span class="k">class</span> <span class="nc">ExperimentMapper</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given an experiment object and reference sequences, map the phosphorylation sites to the common reference.</span>
<span class="sd">    Inputs</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        Name of experiment. Used for logging</span>
<span class="sd">    experiment: pandas dataframe</span>
<span class="sd">        Pandas dataframe of an experiment that has a reference accession, a peptide column and/or a site column. </span>
<span class="sd">        The peptide column should be upper case, with lower case indicating the site of phosphorylation - this is preferred</span>
<span class="sd">        The site column should be in the format S/T/Y&lt;pos&gt;, e.g. Y15 or S345</span>
<span class="sd">    columns: dict</span>
<span class="sd">        Dictionary with mappings of the experiment dataframe column names for the required names &#39;accession_id&#39;, &#39;peptide&#39;, or &#39;site&#39;. </span>
<span class="sd">        One of &#39;peptide&#39; or &#39;site&#39; is required. </span>
<span class="sd">    logger: Logger object</span>
<span class="sd">        used for logging when peptides cannot be matched and when a site location changes</span>
<span class="sd">    sequences: dict</span>
<span class="sd">        Dictionary of sequences. Key : accession. Value : protein sequence. </span>
<span class="sd">        Default is imported from kstar.config</span>
<span class="sd">    compendia: pd.DataFrame</span>
<span class="sd">        Human phosphoproteome compendia, mapped to KinPred and annotated with number of compendia. </span>
<span class="sd">        Default is imported from kstar.config</span>
<span class="sd">    window : int</span>
<span class="sd">        The length of amino acids to the N- and C-terminal sides of the central phosphoprotein to map a site to.</span>
<span class="sd">        Default is 7.</span>
<span class="sd">    data_columns: list, or empty</span>
<span class="sd">        The list of data columns to use. If this is empty, logger will look for anything that starts with statement data: and those values</span>
<span class="sd">        Default is None.</span>

<span class="sd">    </span>
<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    experiment: pandas dataframe</span>
<span class="sd">        mapped experiment, which for each peptide, no contains the mapped accession, site, peptide, number of compendia, compendia type</span>
<span class="sd">    sequences: dict</span>
<span class="sd">        Dictionary of sequences passed into the class</span>
<span class="sd">    compendia: pandas dataframe</span>
<span class="sd">        compendia dataframe passed into the class</span>
<span class="sd">    data_columns: list</span>
<span class="sd">        indicates which columns will be used as data</span>
<span class="sd">    </span>

<span class="sd">    &quot;&quot;&quot;</span> 
    <span class="c1">#for documentation purposes convert non required parameters to kwargs</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">experiment</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="o">*</span><span class="n">kwargs</span><span class="p">):</span> 
    <span class="c1">#def __init__(self, experiment, columns, logger, sequences=config.HUMAN_REF_SEQUENCES, compendia=config.HUMAN_REF_COMPENDIA, window = 7, data_columns = None): </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span> <span class="o">=</span> <span class="n">experiment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sequences</span> <span class="o">=</span> <span class="n">sequences</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compendia</span> <span class="o">=</span> <span class="n">compendia</span>
        <span class="k">def</span> <span class="nf">set_accession_id</span><span class="p">(</span><span class="n">accession</span><span class="p">):</span>
            <span class="n">acc</span> <span class="o">=</span> <span class="n">accession</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">acc</span> <span class="o">=</span> <span class="n">acc</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">return</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;accession_id&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">columns</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ExperimentMapper requires accession_id as a dictionary key&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_ACCESSION</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="p">[</span><span class="n">columns</span><span class="p">[</span><span class="s1">&#39;accession_id&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">set_accession_id</span><span class="p">)</span> 

        <span class="k">if</span> <span class="s1">&#39;peptide&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">columns</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;site&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">columns</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ExperimentMapper requires either site or peptide as keys in dictionary&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_PEPTIDE</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="p">[</span><span class="n">columns</span><span class="p">[</span><span class="s1">&#39;peptide&#39;</span><span class="p">]]</span> <span class="k">if</span> <span class="s1">&#39;peptide&#39;</span> <span class="ow">in</span> <span class="n">columns</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="p">[</span><span class="n">columns</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]]</span> <span class="k">if</span> <span class="s1">&#39;site&#39;</span> <span class="ow">in</span> <span class="n">columns</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_data_columns</span><span class="p">(</span><span class="n">data_columns</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">align_sites</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>

        <span class="n">compendia</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compendia</span><span class="p">[[</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_ACCESSION</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="p">,</span> <span class="s1">&#39;KSTAR_NUM_COMPENDIA&#39;</span><span class="p">,</span> <span class="s1">&#39;KSTAR_NUM_COMPENDIA_CLASS&#39;</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="p">,</span> <span class="n">compendia</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_ACCESSION</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="p">]</span> <span class="p">)</span>
        <span class="c1">#after merge, NUM_COMPENDIA/CLASS as become a float, likely due to mismatches, so assume those evidences are 0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;KSTAR_NUM_COMPENDIA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;KSTAR_NUM_COMPENDIA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;KSTAR_NUM_COMPENDIA_CLASS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;KSTAR_NUM_COMPENDIA_CLASS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<div class="viewcode-block" id="ExperimentMapper.set_data_columns"><a class="viewcode-back" href="../../../KSTAR.html#kstar.mapper.experiment_mapper.ExperimentMapper.set_data_columns">[docs]</a>    <span class="k">def</span> <span class="nf">set_data_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_columns</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Identifies which columns in the experiment should be used as data columns. If data_columns is provided,</span>
<span class="sd">        then &#39;data:&#39; is added to the front and experiment dataframe is renamed. Otherwise, function will look for columns</span>
<span class="sd">        with &#39;data:&#39; in front and this to the data_columns attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">data_columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;data:&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_rename</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">data_columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;data:&#39;</span><span class="p">):</span>
                    <span class="n">data_rename</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;data:</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="n">data_rename</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">col</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="n">data_rename</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_rename</span><span class="o">.</span><span class="n">values</span><span class="p">())</span></div>

<div class="viewcode-block" id="ExperimentMapper.get_experiment"><a class="viewcode-back" href="../../../KSTAR.html#kstar.mapper.experiment_mapper.ExperimentMapper.get_experiment">[docs]</a>    <span class="k">def</span> <span class="nf">get_experiment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the mapped experiment dataframe</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span></div>


<div class="viewcode-block" id="ExperimentMapper.get_sequence"><a class="viewcode-back" href="../../../KSTAR.html#kstar.mapper.experiment_mapper.ExperimentMapper.get_sequence">[docs]</a>    <span class="k">def</span> <span class="nf">get_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">accession</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the sequence that matches the given accession</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">accession</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequences</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequences</span><span class="p">[</span><span class="n">accession</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span></div>

    
<div class="viewcode-block" id="ExperimentMapper.align_sites"><a class="viewcode-back" href="../../../KSTAR.html#kstar.mapper.experiment_mapper.ExperimentMapper.align_sites">[docs]</a>    <span class="k">def</span> <span class="nf">align_sites</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window</span> <span class="o">=</span> <span class="mi">7</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Map the peptide/sites to the common sequence reference and remove and report errors for sites that do not align as expected.</span>
<span class="sd">        expMapper.align_sites(window=7). Operates on the experiment dataframe of class.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        window: int</span>
<span class="sd">            The length of amino acids to the N- and C-terminal sides of the central phosphoprotein to map a site to.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span> <span class="o">=</span> <span class="n">expand_peptide</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_PEPTIDE</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">sequence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sequence</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_ACCESSION</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">sequence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># If peptide provided then find site</span>
                <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_PEPTIDE</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    
                    <span class="n">site</span> <span class="o">=</span>  <span class="n">peptide_site_number</span><span class="p">(</span><span class="n">peptide</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_PEPTIDE</span><span class="p">],</span> 
                                                <span class="n">site</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="p">],</span>
                                                <span class="n">sequence</span> <span class="o">=</span> <span class="n">sequence</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">site</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SITE NOT FOUND : </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_ACCESSION</span><span class="p">]</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_PEPTIDE</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_PEPTIDE</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">continue</span>
                    <span class="k">elif</span> <span class="n">site</span> <span class="o">!=</span> <span class="n">row</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SITE CHANGED : </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_ACCESSION</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="p">]</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">site</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="p">]</span> <span class="o">=</span> <span class="n">site</span>
                    
                    <span class="n">peptide</span> <span class="o">=</span> <span class="n">get_aligned_peptide</span><span class="p">(</span><span class="n">site</span> <span class="o">=</span> <span class="n">site</span><span class="p">,</span>
                                                  <span class="n">sequence</span> <span class="o">=</span> <span class="n">sequence</span><span class="p">,</span> 
                                                  <span class="n">window</span> <span class="o">=</span> <span class="n">window</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">peptide</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_PEPTIDE</span><span class="p">]</span> <span class="o">=</span> <span class="n">peptide</span>
                        
                <span class="c1"># Peptide not provided but site is provided - build peptide</span>
                <span class="k">elif</span> <span class="n">row</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">peptide</span> <span class="o">=</span> <span class="n">get_aligned_peptide</span><span class="p">(</span><span class="n">site</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="p">],</span>
                                                  <span class="n">sequence</span> <span class="o">=</span> <span class="n">sequence</span><span class="p">,</span> 
                                                  <span class="n">window</span> <span class="o">=</span> <span class="n">window</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">peptide</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_PEPTIDE</span><span class="p">]</span> <span class="o">=</span> <span class="n">peptide</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PEPTIDE MISMATCH : </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_ACCESSION</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_PEPTIDE</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SITE NOT FOUND : </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_ACCESSION</span><span class="p">]</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Sequence not found in compendia</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SEQUENCE NOT FOUND : </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_ACCESSION</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_PEPTIDE</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="s1">&#39;rows&#39;</span><span class="p">,</span> <span class="n">subset</span> <span class="o">=</span> <span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_ACCESSION</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_PEPTIDE</span><span class="p">],</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div></div>


<span class="k">def</span> <span class="nf">expand_peptide</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">peptide_column</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Expands a dataframe based on the peptide column such that each </span>
<span class="sd">    peptide contains one modification type. </span>
<span class="sd">    Example</span>
<span class="sd">        Accession  Peptide  Info</span>
<span class="sd">        P0001      aBCDeF   Good</span>
<span class="sd">        P0002      TUvWXy   Bad</span>

<span class="sd">        Becomes</span>
<span class="sd">        Accession  Peptide  Info</span>
<span class="sd">        P0001      aBCDEF   Good</span>
<span class="sd">        P0001      ABCDeF   Good</span>
<span class="sd">        P0002      TUvWXY   Bad</span>
<span class="sd">        P0002      TUVWXy   Bad</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    --------</span>
<span class="sd">    df : pandas df</span>
<span class="sd">        Experiment pandas dataframe</span>
<span class="sd">    peptide_column: str</span>
<span class="sd">        peptide column to expand</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    ---------</span>
<span class="sd">    df : pandas DataFrame</span>
<span class="sd">        expanded dataframe</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">peptide_column</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mods</span> <span class="o">=</span> <span class="n">find_modified_sites</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">peptide_column</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">mod</span> <span class="ow">in</span> <span class="n">mods</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">tmp</span><span class="p">[</span><span class="n">peptide_column</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="n">peptide_column</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
                <span class="n">tmp</span><span class="p">[</span><span class="n">peptide_column</span><span class="p">][</span><span class="n">mod</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="n">peptide_column</span><span class="p">][</span><span class="n">mod</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">tmp</span><span class="p">[</span><span class="n">peptide_column</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="n">peptide_column</span><span class="p">])</span>
                <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df_list</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>
        
<span class="k">def</span> <span class="nf">find_modified_sites</span><span class="p">(</span><span class="n">peptide</span><span class="p">,</span> <span class="n">modification_types</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finds all modification sites, indicated by a lower letter in the peptide column </span>
<span class="sd">        and returns as a list of lists </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        row : pandas row</span>
<span class="sd">        peptide_column : column that contains peptide with mod site</span>
<span class="sd">            mod site identified by being lower case</span>

<span class="sd">        Returns : [[modtype, relative_location]]</span>
<span class="sd">        1st element is the modification type</span>
<span class="sd">        2nd element is the relative modification location</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">modification_types</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mod_types</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">modification_types</span><span class="p">)</span>
            <span class="n">mod_types</span> <span class="o">=</span> <span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="n">mod_types</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span>
            <span class="k">return</span> <span class="p">[[</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">()</span> <span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">mod_types</span><span class="p">,</span> <span class="n">peptide</span><span class="p">)]</span>
        <span class="k">return</span> <span class="p">[[</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">()</span> <span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="s1">&#39;[a-z]&#39;</span><span class="p">,</span> <span class="n">peptide</span><span class="p">)]</span>

<span class="k">def</span> <span class="nf">find_peptide_locations</span><span class="p">(</span><span class="n">peptide</span><span class="p">,</span> <span class="n">sequence</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finds all start locations of a peptide in a given sequence. </span>
<span class="sd">    Sequence starts at location 1.</span>
<span class="sd">    Example: Sequence: ABCDEFGABCDHIJK, Peptide: BCD</span>
<span class="sd">    would return [2, 9], as peptide is found at location 2 and 9</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">peptide</span><span class="p">,</span> <span class="n">sequence</span><span class="p">)]</span>

<span class="k">def</span> <span class="nf">peptide_site_number</span><span class="p">(</span><span class="n">peptide</span><span class="p">,</span> <span class="n">sequence</span><span class="p">,</span> <span class="n">site</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">modification_types</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finds the site number by finding the modification site in sequence and the peptide location</span>
<span class="sd">    in the sequence. A modification site is defined as where in a peptide a lower case letter appears.</span>
<span class="sd">    If a site is provided with alphabetical character the alphabetical character is</span>
<span class="sd">    the modification type checked for in the peptide.</span>
<span class="sd">    If a site contains numbers the closest match of the petide in the sequence to the site number is used as the site</span>
<span class="sd">    If no modification sites are found or peptide is not found in sequence None is returned</span>
<span class="sd">    </span>
<span class="sd">    Example: sequence is ZZZZABCDEFGZZZABCDEFGHIZZ, peptide is AbCdEfG</span>
<span class="sd">    If no site is provided and no modification types are provided then B6 is returned</span>
<span class="sd">    If no site is provided and modification_types is [&#39;d&#39;,&#39;f&#39;] or &#39;df&#39; then D8 is returned</span>
<span class="sd">    If site is 30 and modification_types is [&#39;d&#39;,&#39;f&#39;] then F20 is returned</span>
<span class="sd">    If site is D23 then D18 is returned, modification_type is ignored</span>
<span class="sd">    If site is X50 then X50 is returned as modification_type x is not found in peptide</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    peptide :str</span>
<span class="sd">        peptide string where modification site is first lower-case letter found</span>
<span class="sd">    sequence : str</span>
<span class="sd">        sequence string where all characters are uppercase</span>
<span class="sd">    site : str</span>
<span class="sd">        site number to check against. can either have letters or just numbers</span>
<span class="sd">    modification_types: list</span>
<span class="sd">        list of modification types to check against while checking peptide</span>
<span class="sd">        ex: [&#39;s&#39;, &#39;t&#39;, &#39;y&#39;] would ingore all modifications except for s,t,y</span>
<span class="sd">        not used if site contains alphabetical characters</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    ---------</span>
<span class="sd">    site : str</span>
<span class="sd">        site of peptide in sequence dataframe in format S123</span>
<span class="sd">        closest to original site if provided, otherwise first location found</span>
<span class="sd">        if no modification sites are found, the sequence cannot be found, or the peptide</span>
<span class="sd">            cannot be found in the sequence then the original site is returned</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">peptide</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">peptide</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">isalpha</span><span class="p">,</span> <span class="n">peptide</span><span class="p">))</span> <span class="c1"># keep only alphabetical letters</span>
    <span class="n">all_mod_sites</span> <span class="o">=</span> <span class="n">find_modified_sites</span><span class="p">(</span><span class="n">peptide</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="c1"># get all mod sites</span>
        
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">modification_types</span> <span class="o">=</span> <span class="n">site</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    
    <span class="n">mod_sites</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">modification_types</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">mod_site</span> <span class="ow">in</span> <span class="n">all_mod_sites</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mod_site</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">modification_types</span><span class="p">:</span>
                <span class="n">mod_sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mod_site</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mod_sites</span> <span class="o">=</span> <span class="n">all_mod_sites</span>
    
    <span class="c1"># if no mod sites are found return None</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mod_sites</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">peptide_locations</span> <span class="o">=</span> <span class="n">find_peptide_locations</span><span class="p">(</span><span class="n">peptide</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">sequence</span><span class="p">)</span> 


    <span class="n">relative_location</span> <span class="o">=</span> <span class="n">mod_sites</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># only looking at first mod site location</span>
    <span class="n">site_type</span> <span class="o">=</span> <span class="n">mod_sites</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="c1"># first mod type (STY)</span>
    
    <span class="c1"># get all locations where peptide appears in sequence</span>
    <span class="n">peptide_locations</span> <span class="o">=</span> <span class="n">find_peptide_locations</span><span class="p">(</span><span class="n">peptide</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">sequence</span><span class="p">)</span> 
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">peptide_locations</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">site</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># get closest peptide location to provided site</span>
            <span class="n">site_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;[^0-9]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">site</span><span class="p">)))</span> <span class="c1">#remove all letters and make int</span>
            <span class="n">closeness</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="n">closest_site</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">peptide_locations</span><span class="p">:</span>
                <span class="n">true_location</span> <span class="o">=</span> <span class="n">loc</span> <span class="o">+</span> <span class="n">relative_location</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">true_location</span> <span class="o">-</span> <span class="n">site_num</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">closeness</span><span class="p">:</span>
                    <span class="n">closeness</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">true_location</span> <span class="o">-</span> <span class="n">site_num</span><span class="p">)</span>
                    <span class="n">closest_site</span> <span class="o">=</span> <span class="n">true_location</span>
            <span class="k">return</span> <span class="n">site_type</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">closest_site</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># no site info provided : return first instance</span>
            <span class="k">return</span> <span class="n">site_type</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">peptide_locations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">relative_location</span><span class="p">)</span>  
    <span class="k">return</span> <span class="kc">None</span>

<span class="k">def</span> <span class="nf">peptide_site_number_df</span><span class="p">(</span><span class="n">peptide</span><span class="p">,</span> <span class="n">accession</span><span class="p">,</span> <span class="n">df_sequence</span><span class="p">,</span> <span class="n">site</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">modification_types</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finds the site number by finding the modification site in sequence and the peptide location</span>
<span class="sd">    in the sequence from the given dataframe.</span>
<span class="sd">    If the sequence cannot be found then the original site is returned.</span>
<span class="sd">    See peptide_site_number(peptide,sequence,site,modification_types) </span>
<span class="sd">    for details of how site is found once sequence is found</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    peptide :str</span>
<span class="sd">        peptide string where modification site is first lower-case letter found</span>
<span class="sd">    accession : str</span>
<span class="sd">        UniProt accession number </span>
<span class="sd">    df_sequence : pandas DataFrame</span>
<span class="sd">        sequence dataframe pulled from UniProt with columns Entry, Sequence</span>
<span class="sd">    site : str</span>
<span class="sd">        site number to check against. can either have letters or just numbers</span>
<span class="sd">    modification_types: list</span>
<span class="sd">        list of modification types to check against while checking peptide</span>
<span class="sd">        ex: [&#39;s&#39;, &#39;t&#39;, &#39;y&#39;] would ingore all modifications except for s,t,y</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    ---------</span>
<span class="sd">    site : str</span>
<span class="sd">        site of peptide in sequence dataframe in format S123</span>
<span class="sd">        closest to row[site_column] if provided, otherwise first location found</span>
<span class="sd">        if no modification sites are found, the sequence cannot be found, or the peptide</span>
<span class="sd">            cannot be found in the sequence then the original site is returned</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sequence</span> <span class="o">=</span> <span class="n">df_sequence</span><span class="p">[</span><span class="n">df_sequence</span><span class="p">[</span><span class="s1">&#39;Entry&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">accession</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># get first sequence for accession</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="n">sequence</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Sequence&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">peptide_site_number</span><span class="p">(</span><span class="n">peptide</span><span class="p">,</span> <span class="n">sequence</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">modification_types</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">site</span>

<span class="k">def</span> <span class="nf">is_valid_site</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">sequence</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks whether the site provided is a valid site in the given sequence</span>
<span class="sd">    Valid sites are sites where site has same modification as sequence location</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    site: str</span>
<span class="sd">        site AA#, e.g. Y12</span>
<span class="sd">    sequence : str</span>
<span class="sd">        sequence to check</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    --------</span>
<span class="sd">    is_valid : bool</span>
<span class="sd">        True if site is valid. False otherwise</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">site_type</span>  <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">isalpha</span><span class="p">,</span> <span class="n">site</span><span class="p">))</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">site_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">isdigit</span><span class="p">(),</span> <span class="n">site</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">if</span> <span class="n">site_number</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">site_number</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sequence</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">site_type</span> <span class="o">==</span> <span class="n">sequence</span><span class="p">[</span><span class="n">site_number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="kc">False</span>

<span class="k">def</span> <span class="nf">get_aligned_peptide</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">sequence</span><span class="p">,</span> <span class="n">window</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns aligned peptide where modificaiton site is lowercase. </span>
<span class="sd">    Aligned peptide contains +/- window AA surrounding modification site. </span>
<span class="sd">    No buffer characters are added.</span>
<span class="sd">    If the site is not a valid location in the sequence then None is returned</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    site : str</span>
<span class="sd">        modification site. AA#. e.g. Y12</span>
<span class="sd">    sequence : str</span>
<span class="sd">        sequence to use for generating aligned peptide</span>
<span class="sd">    window : int</span>
<span class="sd">        number of amino acids to pull surrounding modification site</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    peptide : str</span>
<span class="sd">        peptide of AA surrounding mod site. Mod site is lowercase. </span>
<span class="sd">        None is returned if not a valid site</span>
<span class="sd">            e.g. ABCDeFGHI where site=E5, window=4</span>
<span class="sd">            e.g. AbCDEF    where site=B2, window=4 </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">is_valid_site</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">sequence</span><span class="p">):</span> 
        <span class="n">site_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">isdigit</span><span class="p">(),</span> <span class="n">site</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">site_number</span> <span class="o">-</span> <span class="n">window</span><span class="p">)</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sequence</span><span class="p">),</span> <span class="n">site_number</span> <span class="o">+</span> <span class="n">window</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span>
        <span class="n">sequence</span><span class="p">[</span><span class="n">site_number</span><span class="p">]</span> <span class="o">=</span> <span class="n">sequence</span><span class="p">[</span><span class="n">site_number</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">peptide</span> <span class="o">=</span> <span class="n">sequence</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>
        <span class="n">peptide</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">peptide</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">peptide</span>
    <span class="k">return</span> <span class="kc">None</span>

<span class="k">def</span> <span class="nf">run_mapping</span><span class="p">(</span><span class="n">experiment</span><span class="p">,</span> <span class="n">odir</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">map_columns</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">data_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/MAPPED_DATA&quot;</span><span class="p">):</span> 
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/MAPPED_DATA&quot;</span><span class="p">)</span>   
    <span class="n">mapping_log</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mapping_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/MAPPED_DATA/mapping_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.log&quot;</span><span class="p">)</span>
    <span class="n">exp_mapper</span> <span class="o">=</span> <span class="n">ExperimentMapper</span><span class="p">(</span>
        <span class="n">experiment</span> <span class="o">=</span> <span class="n">experiment</span><span class="p">,</span>
        <span class="n">sequences</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">HUMAN_REF_SEQUENCES</span><span class="p">,</span> 
        <span class="n">columns</span> <span class="o">=</span> <span class="n">map_columns</span><span class="p">,</span> 
        <span class="n">logger</span> <span class="o">=</span> <span class="n">mapping_log</span><span class="p">,</span> 
        <span class="n">compendia</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">HUMAN_REF_COMPENDIA</span><span class="p">,</span> 
        <span class="n">window</span> <span class="o">=</span> <span class="n">window</span><span class="p">,</span> 
        <span class="n">data_columns</span> <span class="o">=</span> <span class="n">data_columns</span><span class="p">)</span>
     
    <span class="n">experiment</span> <span class="o">=</span> <span class="n">exp_mapper</span><span class="o">.</span><span class="n">experiment</span> 
    <span class="n">experiment</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/MAPPED_DATA/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_mapped.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">experiment</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../../index.html">Table of Contents</a></h3>
  <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Dependencies.html">Dependencies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart.html">Quick Start Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../KSTAR.html">KSTAR</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Tutorial/tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Examples/Examples.html">Plotting Examples from KSTAR Paper</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Running_with_nextflow.html">Running Large Datasets with Nextflow</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">KSTAR 1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">kstar.mapper.experiment_mapper</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, Naegle Lab.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.0.1.
    </div>
  </body>
</html>