
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>kstar.calculate &#8212; KSTAR 1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/classic.css" />
    
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">KSTAR 1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">kstar.calculate</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for kstar.calculate</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">itertools</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">stats</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>

<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">concurrent.futures</span>

<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">repeat</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">kstar</span> <span class="kn">import</span> <span class="n">config</span><span class="p">,</span> <span class="n">helpers</span>
<span class="kn">from</span> <span class="nn">kstar.random_experiments</span> <span class="kn">import</span> <span class="n">generate_random_experiments</span><span class="p">,</span> <span class="n">calculate_fpr</span>


<div class="viewcode-block" id="KinaseActivity"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.KinaseActivity">[docs]</a><span class="k">class</span> <span class="nc">KinaseActivity</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Kinase Activity calculates the estimated activity of kinases given an experiment using hypergeometric distribution.</span>
<span class="sd">    Hypergeometric distribution examines the number of protein sites found to be active in evidence compared to the</span>
<span class="sd">    number of protein sites attributed to a kinase on a provided network.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    evidence : pandas df</span>
<span class="sd">        a dataframe that contains (at minimum, but can have more) data columms as evidence to use in analysis and KSTAR_ACCESSION and KSTAR_SITE</span>
<span class="sd">    data_columns: list</span>
<span class="sd">        list of the columns containing the abundance values, which will be used to determine which sites will be used as evidence for activity prediction in each sample</span>
<span class="sd">    logger : Logger object</span>
<span class="sd">        keeps track of kstar analysis, including any errors that occur</span>
<span class="sd">    phospho_type: string, either &#39;Y&#39; or &#39;ST&#39;</span>
<span class="sd">        indicates the phoshpo modification of interest</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    -------------------</span>
<span class="sd">    Upon Initialization</span>
<span class="sd">    -------------------</span>
<span class="sd">    evidence: pandas dataframe</span>
<span class="sd">        inputted evidence column</span>
<span class="sd">    data_columns: list</span>
<span class="sd">        list of columns containing abundance values, which will be used to determine which sites will be used as evidence. If inputted data_columns parameter was None, this lists includes in column in evidence prefixed by &#39;data:&#39;</span>
<span class="sd">    logger : Logger object</span>
<span class="sd">        keeps track of kstar analysis, including any errors that occur</span>
<span class="sd">    phospho_type: string</span>
<span class="sd">        indicated phosphomod of interest</span>
<span class="sd">    network_directory: string</span>
<span class="sd">        directory where kinase substrate networks can be downloaded, as indicated in config.py</span>
<span class="sd">    normalized: bool</span>
<span class="sd">        indicates whether normalization analysis has been performed</span>
<span class="sd">    aggregate: string</span>
<span class="sd">        the type of aggregation to use when determining binary evidence, either &#39;count&#39; or &#39;mean&#39;. Default is &#39;count&#39;.</span>
<span class="sd">    threshold: float</span>
<span class="sd">        cutoff to use when determining what sites to use for each experiment</span>
<span class="sd">    greater: bool</span>
<span class="sd">        indicates whether sites with greater or lower abundances than the threshold will be used</span>
<span class="sd">    run_data: string</span>
<span class="sd">        indicates the date that kinase activity object was initialized</span>

<span class="sd">    ---------------------------------</span>
<span class="sd">    After Hypergeometric Calculations</span>
<span class="sd">    ---------------------------------</span>
<span class="sd">    real_enrichment: pandas dataframe</span>
<span class="sd">        p-values obtained for all pruned networks indicating statistical enrichment of a kinase&#39;s substrates for each network, based on hypergeometric</span>
<span class="sd">        tests</span>
<span class="sd">    activities: pandas dataframe</span>
<span class="sd">        median p-values obtained from the real_enrichment object for each experiment/kinase</span>
<span class="sd">    agg_activities: pandas dataframe</span>

<span class="sd">    -----------------------------------</span>
<span class="sd">    After Random Enrichment Calculation</span>
<span class="sd">    -----------------------------------</span>
<span class="sd">    random_experiments: pandas dataframe</span>
<span class="sd">        contains information about the sites randomly sampled for each random experiment</span>

<span class="sd">    random_kinact: KinaseActivity object</span>
<span class="sd">        KinaseActivity object containing random activities predicted from each of the random experiments</span>

<span class="sd">    ---------------------------</span>
<span class="sd">    After Mann Whitney Analysis</span>
<span class="sd">    ---------------------------</span>
<span class="sd">    activities_mann_whitney: pandas dataframe</span>
<span class="sd">        p-values obtained from comparing the real distribution of p-values to the distribution of p-values from random datasets, based</span>
<span class="sd">        the Mann Whitney U-test</span>
<span class="sd">    fpr_mann_whitney: pandas dataframe</span>
<span class="sd">        false positive rates for predicted kinase activities</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evidence</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">data_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">phospho_type</span><span class="o">=</span><span class="s1">&#39;Y&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phospho_type</span> <span class="o">=</span> <span class="n">phospho_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_evidence</span><span class="p">(</span><span class="n">evidence</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">networks</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network_sizes</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="c1"># self.normalizers = defaultdict()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network_directory</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">NETWORK_DIR</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">num_networks</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">real_enrichment</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># self.agg_activities = None</span>
        <span class="c1"># self.activities = None</span>

        <span class="c1"># Location of random experiments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">randomized</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_experiments</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># added fields for pregenerated_random</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_dataset_size_for_pregenerated</span> <span class="o">=</span> <span class="mi">150</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_diff_from_pregenerated</span> <span class="o">=</span> <span class="mf">0.20</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_activities_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compendia_distribution</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_columns_from_scratch</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_pregen_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_new_precompute</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pregenerated_experiments_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directory_for_save_precompute</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network_hash</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># end of new fields for pregenerated_random</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">aggregate</span> <span class="o">=</span> <span class="s1">&#39;mean&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">greater</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">run_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%m/%Y %H:%M:%S&quot;</span><span class="p">)</span>

        <span class="c1"># if data columns is None, set data columns to be columns with data: in front</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_data_columns</span><span class="p">(</span><span class="n">data_columns</span><span class="o">=</span><span class="n">data_columns</span><span class="p">)</span>

<div class="viewcode-block" id="KinaseActivity.check_data_columns"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.KinaseActivity.check_data_columns">[docs]</a>    <span class="k">def</span> <span class="nf">check_data_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks data columns to make sure column is in evidence and that evidence filtered on that data column</span>
<span class="sd">        has at least one point of evidence. Removes all columns that do not meet criteria</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_data_columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">evidence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evidence</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_ACCESSION</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="p">])[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aggregate</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">evidence</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">greater</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">evidence</span><span class="p">[</span><span class="n">evidence</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">new_data_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> does not have any evidence&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">evidence</span><span class="p">[</span><span class="n">evidence</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">new_data_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> does not have any evidence&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="o">~</span><span class="n">evidence</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                        <span class="n">new_data_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> does not have any evidence&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> not in evidence&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span> <span class="o">=</span> <span class="n">new_data_columns</span></div>

<div class="viewcode-block" id="KinaseActivity.set_data_columns"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.KinaseActivity.set_data_columns">[docs]</a>    <span class="k">def</span> <span class="nf">set_data_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the data columns to use in the kinase activity calculation</span>
<span class="sd">        If data_columns is None or an empty list then set data_columns to</span>
<span class="sd">        be all columns that start with data:</span>

<span class="sd">        Checks all set columns to make sure columns are vaild after filtering evidence</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">data_columns</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">data_columns</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">evidence</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;data:&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span> <span class="o">=</span> <span class="n">data_columns</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_data_columns</span><span class="p">()</span></div>

<div class="viewcode-block" id="KinaseActivity.test_threshold"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.KinaseActivity.test_threshold">[docs]</a>    <span class="k">def</span> <span class="nf">test_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">agg</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">greater</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_evidence_sizes</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given a threshold value, calculate the distribution of evidence sizes (i.e. number of sites used in prediction for each sample in the experiment).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        threshold: float</span>
<span class="sd">            cutoff for inclusion as evidence for prediction. If greater = True, sites with quantification greater than the threshold are used as evidence.</span>
<span class="sd">        agg: str</span>
<span class="sd">            how to combine sites with multiple instances in experiment</span>
<span class="sd">        greater: bool</span>
<span class="sd">            whether to use sites greater (True) or less (False) than the threshold</span>
<span class="sd">        plot: bool</span>
<span class="sd">            whether to plot a histogram of the evidence sizes used</span>
<span class="sd">        return_site_nums: bool</span>
<span class="sd">            indicates whether to return the evidence sizes for all samples or not</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Outputs the minimum, maximum, and median evidence sizes across all samples. May return evidence sizes of all samples as pandas series</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">evidence_binary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_binary_evidence</span><span class="p">(</span><span class="n">agg</span><span class="o">=</span><span class="n">agg</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span> <span class="n">greater</span><span class="o">=</span><span class="n">greater</span><span class="p">)</span>
        <span class="n">num_sites</span> <span class="o">=</span> <span class="n">evidence_binary</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of Sites That Will Be Used As Evidence For Each Sample:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Maximum =&#39;</span><span class="p">,</span> <span class="n">num_sites</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Minimum =&#39;</span><span class="p">,</span> <span class="n">num_sites</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Median =&#39;</span><span class="p">,</span> <span class="n">num_sites</span><span class="o">.</span><span class="n">median</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="n">plt_data</span> <span class="o">=</span> <span class="n">num_sites</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">plt_data</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Number of Sites Used As Evidence&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_evidence_sizes</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">num_sites</span></div>

<div class="viewcode-block" id="KinaseActivity.parse_network_information"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.KinaseActivity.parse_network_information">[docs]</a>    <span class="k">def</span> <span class="nf">parse_network_information</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">file_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse the RUN_INFORMATION.txt file and extract its data.</span>

<span class="sd">        Args:</span>
<span class="sd">            file_path (str): Path to the RUN_INFORMATION.txt file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary containing the parsed data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;unique_id&quot;</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Unique ID:\s+([a-fA-F0-9]+)&quot;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                <span class="s2">&quot;date_run&quot;</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Date Run\s+([\d-]+\s[\d:.]+)&quot;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                <span class="s2">&quot;network_used&quot;</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Network Used\s+([^\n]+)&quot;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
                <span class="s2">&quot;phospho_type&quot;</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Phospho Type\s+(\w+)&quot;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                <span class="s2">&quot;kinase_size&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Kinase Size\s+(\d+)&quot;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span>
                <span class="s2">&quot;site_limit&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Site Limit\s+(\d+)&quot;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span>
                <span class="s2">&quot;num_networks&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;# of Networks\s+(\d+)&quot;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span>
                <span class="s2">&quot;use_compendia&quot;</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Use Compendia\s+(\w+)&quot;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span>
                <span class="s2">&quot;compendia_counts&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Compendia \d+\s+(\d+)&quot;</span><span class="p">,</span> <span class="n">content</span><span class="p">))),</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RUN_INFORMATION.txt file not found at: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error parsing the RUN_INFORMATION.txt file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="KinaseActivity.network_check_for_pregeneration"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.KinaseActivity.network_check_for_pregeneration">[docs]</a>    <span class="k">def</span> <span class="nf">network_check_for_pregeneration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the network hash matches a pre-generated network in pregen_experiments</span>
<span class="sd">        and verifies RUN_INFORMATION.txt within the hash subdirectory.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the data matches, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Base directory for pre-generated experiments</span>
        <span class="n">pregen_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pregenerated_experiments_path</span>
        <span class="n">target_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_hash</span>

        <span class="n">pregen_network_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pregen_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phospho_type</span><span class="p">)</span>

        <span class="c1"># Iterate over subdirectories in pregen_experiments</span>
        <span class="k">for</span> <span class="n">dir_name</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">pregen_network_dir</span><span class="p">):</span>
            <span class="n">dir_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pregen_network_dir</span><span class="p">,</span> <span class="n">dir_name</span><span class="p">)</span>

            <span class="c1"># Check if this is a directory and matches the target hash</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dir_name</span> <span class="o">==</span> <span class="n">target_hash</span><span class="p">:</span>
                <span class="c1"># Path to RUN_INFORMATION.txt in the hash subdirectory</span>
                <span class="n">default_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="s2">&quot;RUN_INFORMATION.txt&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">default_file_path</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">False</span>

                <span class="c1"># Parse and compare the RUN_INFORMATION.txt files</span>
                <span class="n">default_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_network_information</span><span class="p">(</span><span class="n">default_file_path</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">default_value</span> <span class="ow">in</span> <span class="n">default_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;hash&quot;</span> <span class="ow">and</span> <span class="n">default_value</span> <span class="o">!=</span> <span class="n">default_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                        <span class="k">return</span> <span class="kc">False</span>

                <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># If no matching hash directory is found</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="KinaseActivity.get_compendia_distribution"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.KinaseActivity.get_compendia_distribution">[docs]</a>    <span class="k">def</span> <span class="nf">get_compendia_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_pregenerated_evidence</span><span class="p">,</span> <span class="n">data_columns</span><span class="p">,</span>
                                   <span class="n">selection_type</span><span class="o">=</span><span class="s1">&#39;KSTAR_NUM_COMPENDIA_CLASS&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the compendia distribution for each data column.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        with_pregenerated_evidence : pandas DataFrame</span>
<span class="sd">            KSTAR mapped experimental dataframe that has been binarized by kstar_activity generation.</span>
<span class="sd">        data_columns : list</span>
<span class="sd">            Columns that represent experimental results.</span>
<span class="sd">        selection_type : str, optional</span>
<span class="sd">            The type of compendia selection, by default &#39;KSTAR_NUM_COMPENDIA_CLASS&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Dictionary containing the compendia distribution for each data column.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">compendia_distribution</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">data_columns</span><span class="p">:</span>
            <span class="n">filtered_data</span> <span class="o">=</span> <span class="n">with_pregenerated_evidence</span><span class="p">[</span><span class="n">with_pregenerated_evidence</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">compendia_counts</span> <span class="o">=</span> <span class="n">filtered_data</span><span class="p">[</span><span class="n">selection_type</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="n">compendia_distribution</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">compendia_counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)}</span>
        <span class="k">return</span> <span class="n">compendia_distribution</span></div>

    <span class="k">def</span> <span class="nf">check_file_sizes_for_pregenerated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check the sizes of pre-generated files for the given datasets.</span>

<span class="sd">        This function identifies the appropriate pre-generated file sizes based on the dataset size and returns a list of these sizes.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pregenerated_sizes_files : list</span>
<span class="sd">            List of sizes of pre-generated files that match the dataset size criteria.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">pregenerated_sizes_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Define mapping for compendia file paths</span>
        <span class="n">compendia_paths</span> <span class="o">=</span> <span class="p">{</span>
            <span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="s1">&#39;compendia_0_0_1_30_2_70&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="s1">&#39;compendia_0_5_1_50_2_45&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="s1">&#39;ST&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span> <span class="s1">&#39;compendia_0_0_1_30_2_70&#39;</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span><span class="p">:</span>
            <span class="n">compendia_class_counts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_compendia_distribution</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evidence_binary</span><span class="p">,</span> <span class="p">[</span><span class="n">dataset</span><span class="p">])</span>

            <span class="c1"># Determine path key (phospho_type + class condition)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phospho_type</span><span class="p">,</span> <span class="n">compendia_class_counts</span><span class="p">[</span><span class="n">dataset</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">60</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phospho_type</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">compendia_paths</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR: Unrecognized phosphoType &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">phospho_type</span><span class="si">}</span><span class="s2">&#39;. Must be &#39;Y&#39; or &#39;ST&#39;.&quot;</span><span class="p">)</span>

            <span class="n">compendia_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pregenerated_experiments_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phospho_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_hash</span><span class="p">,</span> <span class="n">compendia_paths</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">compendia_file_path</span><span class="p">):</span>
                <span class="n">pregenerated_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">compendia_file_path</span><span class="p">)</span>
                <span class="n">pregenerated_sizes_files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">pregenerated_files</span> <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()]</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Directory not found: </span><span class="si">{</span><span class="n">compendia_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pregenerated_sizes_files</span>

<div class="viewcode-block" id="KinaseActivity.calculate_random_activities"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.KinaseActivity.calculate_random_activities">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_random_activities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">num_random_experiments</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">use_pregen_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_new_precompute</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pregenerated_experiments_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">directory_for_save_precompute</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">network_hash</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_random_experiments</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">PROCESSES</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate random experiments and calculate kinase activities.Either uses pre-generated activity lists or</span>
<span class="sd">        generates new random experiments based on the provided parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        logger : Logger object</span>
<span class="sd">            Logger to record the progress and any issues during the randomization pipeline.</span>
<span class="sd">        num_random_experiments : int, optional</span>
<span class="sd">            Number of random experiments to generate, by default 150.</span>
<span class="sd">        use_pregen_data : bool, optional</span>
<span class="sd">            Whether to use pre-generated data, by default None.</span>
<span class="sd">        save_new_precompute : bool, optional</span>
<span class="sd">            Whether to save new precomputed data, by default None.</span>
<span class="sd">        pregenerated_experiments_path : str, optional</span>
<span class="sd">            Path to the directory containing pre-generated experiments, by default None.</span>
<span class="sd">        directory_for_save_precompute : str, optional</span>
<span class="sd">            Directory to save new precomputed data, by default None.</span>
<span class="sd">        network_hash : str, optional</span>
<span class="sd">            Hash of the network used, by default None.</span>
<span class="sd">        save_random_experiments : bool, optional</span>
<span class="sd">            Whether to save the generated random experiments, by default None.</span>
<span class="sd">        PROCESSES : int, optional</span>
<span class="sd">            Number of processes to use for parallel computation, by default 1.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running Randomization Pipeline&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_pregen_data</span> <span class="o">=</span> <span class="n">use_pregen_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_new_precompute</span> <span class="o">=</span> <span class="n">save_new_precompute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pregenerated_experiments_path</span> <span class="o">=</span> <span class="n">pregenerated_experiments_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directory_for_save_precompute</span> <span class="o">=</span> <span class="n">directory_for_save_precompute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network_hash</span> <span class="o">=</span> <span class="n">network_hash</span>

        <span class="k">if</span> <span class="n">use_pregen_data</span><span class="p">:</span>
            <span class="c1"># Initialize lists</span>
            <span class="n">pregen_activities_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># Classify datasets</span>
            <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span><span class="p">:</span>
                <span class="n">dataset_sizes</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">evidence_binary</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span><span class="p">}</span>
                <span class="n">pregenerated_sizes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_file_sizes_for_pregenerated</span><span class="p">()</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">dataset_sizes</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span>

                <span class="n">large_enough</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_dataset_size_for_pregenerated</span>
                <span class="n">close_enough</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
                    <span class="nb">abs</span><span class="p">(</span><span class="n">pregen_size</span> <span class="o">-</span> <span class="n">size</span><span class="p">)</span> <span class="o">/</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_diff_from_pregenerated</span> <span class="k">for</span> <span class="n">pregen_size</span> <span class="ow">in</span>
                    <span class="n">pregenerated_sizes</span><span class="p">)</span>

                <span class="n">use_pregen</span> <span class="o">=</span> <span class="n">large_enough</span> <span class="ow">and</span> <span class="n">close_enough</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_check_for_pregeneration</span><span class="p">()</span>

            <span class="c1"># Process pre-generated data, one dataset at a time</span>
                <span class="k">if</span> <span class="n">use_pregen</span><span class="p">:</span>
                    <span class="n">with_pregenerated</span> <span class="o">=</span> <span class="p">[</span><span class="n">dataset</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using pregenerated random experiments for: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">with_pregenerated_evidence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evidence_binary</span><span class="p">[</span>
                        <span class="p">[</span><span class="s1">&#39;KSTAR_ACCESSION&#39;</span><span class="p">,</span> <span class="s1">&#39;KSTAR_SITE&#39;</span><span class="p">,</span> <span class="s1">&#39;KSTAR_NUM_COMPENDIA&#39;</span><span class="p">,</span> <span class="s1">&#39;KSTAR_NUM_COMPENDIA_CLASS&#39;</span><span class="p">,</span> <span class="n">dataset</span><span class="p">]</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                    <span class="c1"># Process the current dataset</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">load_pregenerated_random_activities</span><span class="p">(</span><span class="n">with_pregenerated_evidence</span><span class="p">,</span> <span class="n">with_pregenerated</span><span class="p">,</span> <span class="n">pregen_activities_list</span><span class="p">)</span>
                <span class="c1"># Process from-scratch data</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data_columns_from_scratch</span> <span class="o">=</span> <span class="p">[</span><span class="n">dataset</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating random experiments for: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">calculate_random_enrichment</span><span class="p">(</span><span class="n">num_random_experiments</span><span class="p">,</span> <span class="n">selection_type</span><span class="o">=</span><span class="s1">&#39;KSTAR_NUM_COMPENDIA_CLASS&#39;</span><span class="p">,</span>
                        <span class="n">save_random_experiments</span> <span class="o">=</span> <span class="n">save_random_experiments</span><span class="p">,</span> <span class="n">PROCESSES</span><span class="o">=</span><span class="n">PROCESSES</span>
                <span class="p">)</span>

        <span class="c1"># Process all from-scratch data if use_pregen_data is False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_columns_from_scratch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating random experiments for: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calculate_random_enrichment</span><span class="p">(</span><span class="n">num_random_experiments</span><span class="p">,</span> <span class="n">selection_type</span><span class="o">=</span><span class="s1">&#39;KSTAR_NUM_COMPENDIA_CLASS&#39;</span><span class="p">,</span>
                <span class="n">save_random_experiments</span> <span class="o">=</span> <span class="n">save_random_experiments</span><span class="p">,</span> <span class="n">PROCESSES</span><span class="o">=</span><span class="n">PROCESSES</span>
            <span class="p">)</span>
        <span class="c1"># Add pre-generated data to random enrichment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_pregenerated_to_random_enrichment</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">calculate_random_enrichment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_random_experiments</span><span class="p">,</span> <span class="n">selection_type</span><span class="o">=</span><span class="s1">&#39;KSTAR_NUM_COMPENDIA_CLASS&#39;</span><span class="p">,</span> <span class="n">save_random_experiments</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">PROCESSES</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the kinase activities for each random experiment and discard the resulting random experiment unless save_random_experiments is set to True.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        num_random_experiments : int</span>
<span class="sd">            Number of random experiments to generate.</span>
<span class="sd">        selection_type : str, optional</span>
<span class="sd">            The type of compendia selection, by default &#39;KSTAR_NUM_COMPENDIA_CLASS&#39;.</span>
<span class="sd">        save_random_experiments : bool, optional</span>
<span class="sd">            Whether to save the generated random experiments, by default False.</span>
<span class="sd">        PROCESSES : int, optional</span>
<span class="sd">            Number of processes to use for parallel computation, by default 1.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pregen_data</span><span class="p">:</span>
            <span class="n">num_random_experiments</span> <span class="o">=</span> <span class="mi">150</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_random_experiments</span> <span class="o">=</span> <span class="n">num_random_experiments</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Change to calculate_random_enrichment to immediately calculate the kinase activities for each random experiment and discard the resulting random experiment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running Randomization Pipeline&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_random_experiments</span> <span class="o">=</span> <span class="n">num_random_experiments</span>
        <span class="n">filtered_compendia</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getFilteredCompendia</span><span class="p">(</span><span class="n">selection_type</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">PROCESSES</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">PROCESSES</span><span class="p">)</span>
            <span class="n">filtered_compendia</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">filtered_compendia</span><span class="p">)</span>
            <span class="n">networks</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">)</span>
            <span class="n">network_sizes</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network_sizes</span><span class="p">)</span>
            <span class="n">rand_exp_numbers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_random_experiments</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">save_random_experiments</span><span class="p">:</span>
                <span class="n">rand_experiments</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">save_experiments</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">save_random_experiments</span><span class="p">)</span>
                <span class="n">combined_activities_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_columns_from_scratch</span><span class="p">:</span>
                    <span class="n">activities_list</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">compendia_sizes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evidence_binary</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">evidence_binary</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                        <span class="n">selection_type</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
                    <span class="n">compendia_sizes</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">compendia_sizes</span><span class="p">)</span>
                    <span class="n">networks</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">)</span>
                    <span class="n">network_sizes</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network_sizes</span><span class="p">)</span>
                    <span class="n">col_name</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                    <span class="n">iterable</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">compendia_sizes</span><span class="p">,</span> <span class="n">filtered_compendia</span><span class="p">,</span> <span class="n">networks</span><span class="p">,</span> <span class="n">network_sizes</span><span class="p">,</span> <span class="n">col_name</span><span class="p">,</span>
                                   <span class="n">rand_exp_numbers</span><span class="p">,</span> <span class="n">save_experiments</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="n">calculate_random_activity_singleExperiment2</span><span class="p">,</span> <span class="n">iterable</span><span class="p">)</span>
                    <span class="c1"># extract results</span>
                    <span class="n">activities</span><span class="p">,</span> <span class="n">experiments</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">result</span><span class="p">)</span>
                    <span class="n">activities_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">activities</span><span class="p">)</span>
                    <span class="n">rand_experiments</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">experiments</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_new_precompute</span><span class="p">:</span>
                        <span class="n">activities_list_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">activities_list</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">save_new_precomputed_random_enrichment</span><span class="p">(</span><span class="n">activities_list_df</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
                    <span class="n">combined_activities_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">activities_list</span><span class="p">)</span>

                <span class="c1"># save data</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">random_enrichment</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">combined_activities_list</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">rand_experiments</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">rand_experiments</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">rand_experiments</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">random_experiments</span> <span class="o">=</span> <span class="n">rand_experiments</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_ACCESSION</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="p">],</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Experiment&#39;</span><span class="p">,</span>
                    <span class="n">values</span><span class="o">=</span><span class="s1">&#39;weight&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">combined_activities_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">save_experiments</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">save_random_experiments</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_columns_from_scratch</span><span class="p">:</span>
                    <span class="n">activities_list</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">compendia_sizes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evidence_binary</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">evidence_binary</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                        <span class="n">selection_type</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
                    <span class="n">compendia_sizes</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">compendia_sizes</span><span class="p">)</span>
                    <span class="n">col_name</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                    <span class="n">iterable</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">compendia_sizes</span><span class="p">,</span> <span class="n">filtered_compendia</span><span class="p">,</span> <span class="n">networks</span><span class="p">,</span> <span class="n">network_sizes</span><span class="p">,</span> <span class="n">col_name</span><span class="p">,</span>
                                   <span class="n">rand_exp_numbers</span><span class="p">,</span> <span class="n">save_experiments</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="n">calculate_random_activity_singleExperiment2</span><span class="p">,</span> <span class="n">iterable</span><span class="p">)</span>
                    <span class="c1"># extract results</span>
                    <span class="n">activities_list</span> <span class="o">=</span> <span class="n">activities_list</span> <span class="o">+</span> <span class="n">result</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_new_precompute</span><span class="p">:</span>
                        <span class="n">activities_list_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">activities_list</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">save_new_precomputed_random_enrichment</span><span class="p">(</span><span class="n">activities_list_df</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
                    <span class="n">combined_activities_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">activities_list</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">random_enrichment</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">combined_activities_list</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">save_random_experiments</span><span class="p">:</span>
                <span class="n">all_rand_experiments</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">combined_activities_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_columns_from_scratch</span><span class="p">:</span>
                    <span class="n">activities_list</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">compendia_sizes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evidence_binary</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">evidence_binary</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                            <span class="n">selection_type</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_random_experiments</span><span class="p">):</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="n">rand_experiment</span> <span class="o">=</span> <span class="n">generate_random_experiments</span><span class="o">.</span><span class="n">build_single_filtered_experiment</span><span class="p">(</span>
                            <span class="n">compendia_sizes</span><span class="p">,</span> <span class="n">filtered_compendia</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">selection_type</span><span class="o">=</span><span class="n">selection_type</span><span class="p">)</span>
                        <span class="n">all_rand_experiments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rand_experiment</span><span class="p">)</span>
                        <span class="n">act</span> <span class="o">=</span> <span class="n">calculate_hypergeometric_activities</span><span class="p">(</span><span class="n">rand_experiment</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">,</span>
                                                                    <span class="bp">self</span><span class="o">.</span><span class="n">network_sizes</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                        <span class="n">activities_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">act</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_new_precompute</span><span class="p">:</span>
                        <span class="n">activities_list_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">activities_list</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">save_new_precomputed_random_enrichment</span><span class="p">(</span><span class="n">activities_list_df</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
                    <span class="n">combined_activities_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">activities_list</span><span class="p">)</span>

                    <span class="c1"># combine all random activities</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">random_enrichment</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">combined_activities_list</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># reformat random experiments into single matrix</span>
                <span class="n">all_rand_experiments</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_rand_experiments</span><span class="p">)</span>
                <span class="n">all_rand_experiments</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">random_experiments</span> <span class="o">=</span> <span class="n">all_rand_experiments</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_ACCESSION</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="p">],</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Experiment&#39;</span><span class="p">,</span>
                    <span class="n">values</span><span class="o">=</span><span class="s1">&#39;weight&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">combined_activities_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_columns_from_scratch</span><span class="p">:</span>
                    <span class="n">activities_list</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="c1"># determine distribution of study bias across real dataset</span>
                    <span class="n">compendia_sizes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evidence_binary</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">evidence_binary</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                            <span class="n">selection_type</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_random_experiments</span><span class="p">):</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="n">rand_experiment</span> <span class="o">=</span> <span class="n">generate_random_experiments</span><span class="o">.</span><span class="n">build_single_filtered_experiment</span><span class="p">(</span>
                                <span class="n">compendia_sizes</span><span class="p">,</span> <span class="n">filtered_compendia</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">selection_type</span><span class="o">=</span><span class="s1">&#39;KSTAR_NUM_COMPENDIA_CLASS&#39;</span><span class="p">)</span>
                        <span class="n">act</span> <span class="o">=</span> <span class="n">calculate_hypergeometric_activities</span><span class="p">(</span><span class="n">rand_experiment</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">,</span>
                                                                      <span class="bp">self</span><span class="o">.</span><span class="n">network_sizes</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                        <span class="n">activities_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">act</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_new_precompute</span><span class="p">:</span>
                        <span class="n">activities_list_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">activities_list</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">save_new_precomputed_random_enrichment</span><span class="p">(</span><span class="n">activities_list_df</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
                    <span class="n">combined_activities_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">activities_list</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">random_enrichment</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">combined_activities_list</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>



<div class="viewcode-block" id="KinaseActivity.load_pregenerated_random_activities"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.KinaseActivity.load_pregenerated_random_activities">[docs]</a>    <span class="k">def</span> <span class="nf">load_pregenerated_random_activities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_pregenerated_evidence</span><span class="p">,</span> <span class="n">with_pregenerated</span><span class="p">,</span> <span class="n">pregen_activities_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load pre-generated random activities for the given datasets.</span>

<span class="sd">        This function processes datasets that have pre-generated random experiments. It identifies the appropriate</span>
<span class="sd">        pre-generated file based on the size of the dataset and appends the activities to the provided list.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        with_pregenerated_evidence : pandas.DataFrame</span>
<span class="sd">            DataFrame containing the evidence for the datasets with pre-generated random experiments.</span>
<span class="sd">        with_pregenerated : list</span>
<span class="sd">            List of dataset names that have pre-generated random experiments.</span>
<span class="sd">        random_activities_list : list</span>
<span class="sd">            List to which the concatenated activities of each dataset will be appended.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">with_pregenerated_evidence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_random_experiments</span> <span class="o">=</span> <span class="mi">150</span>
                <span class="n">dataset_activities_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1"># Define mapping for compendia file paths</span>
                <span class="n">compendia_paths</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="s1">&#39;compendia_0_0_1_30_2_70&#39;</span><span class="p">,</span>
                    <span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="s1">&#39;compendia_0_5_1_50_2_45&#39;</span><span class="p">,</span>
                    <span class="p">(</span><span class="s1">&#39;ST&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span> <span class="s1">&#39;compendia_0_0_1_30_2_70&#39;</span>
                <span class="p">}</span>

                <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">with_pregenerated</span><span class="p">:</span>
                    <span class="n">compendia_class_counts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_compendia_distribution</span><span class="p">(</span><span class="n">with_pregenerated_evidence</span><span class="p">,</span> <span class="p">[</span><span class="n">dataset</span><span class="p">])</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phospho_type</span><span class="p">,</span> <span class="n">compendia_class_counts</span><span class="p">[</span><span class="n">dataset</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">60</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phospho_type</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">compendia_paths</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR: Unrecognized phosphoType &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">phospho_type</span><span class="si">}</span><span class="s2">&#39;. Must be &#39;Y&#39; or &#39;ST&#39;.&quot;</span><span class="p">)</span>

                    <span class="n">compendia_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pregenerated_experiments_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phospho_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_hash</span><span class="p">,</span> <span class="n">compendia_paths</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">compendia_file_path</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Directory not found: </span><span class="si">{</span><span class="n">compendia_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="n">pregenerated_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">compendia_file_path</span><span class="p">)</span>
                    <span class="n">pregenerated_sizes_files</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">pregenerated_files</span> <span class="k">if</span>
                                                <span class="n">file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()]</span>

                    <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evidence_binary</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                    <span class="n">closest_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">pregenerated_sizes_files</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">size</span><span class="p">))</span>
                    <span class="n">matched_file_name</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">file</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">pregenerated_files</span> <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">closest_size</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">))</span>
                    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">compendia_file_path</span><span class="p">,</span> <span class="n">matched_file_name</span><span class="p">)</span>
                    <span class="n">rand_dataset_activities</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;:\d+$&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">rand_dataset_activities</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;^</span><span class="si">{</span><span class="n">dataset</span><span class="si">}</span><span class="s2">:\d+$&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                        <span class="n">rand_dataset_activities</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rand_dataset_activities</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dataset</span><span class="si">}{</span><span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span>
                        <span class="p">)</span>
                    <span class="n">dataset_activities_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rand_dataset_activities</span><span class="p">)</span>

                <span class="n">pregen_activities_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dataset_activities_list</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pregenerated_random_activities</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">pregen_activities_list</span><span class="p">)</span></div>

<div class="viewcode-block" id="KinaseActivity.add_pregenerated_to_random_enrichment"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.KinaseActivity.add_pregenerated_to_random_enrichment">[docs]</a>    <span class="k">def</span> <span class="nf">add_pregenerated_to_random_enrichment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Combine pre-generated random activities with random enrichment, sort based on the &quot;data&quot; column,</span>
<span class="sd">        and reorganize the combined DataFrame based on the original column order in self.data_columns.</span>

<span class="sd">        If use_pregen_data is True and data_columns_from_scratch is None, uses only pre-generated activities.</span>
<span class="sd">        If use_pregen_data is True and data_columns_from_scratch exists, combines both pre-generated and</span>
<span class="sd">        newly calculated random activities.</span>
<span class="sd">        If use_pregen_data is False, uses only newly calculated random activities.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">            Updates self.random_enrichment with the combined and sorted activities</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pregen_data</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_columns_from_scratch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">random_enrichment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pregenerated_random_activities</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Combine the two DataFrames</span>
                <span class="n">combined_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">random_enrichment</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pregenerated_random_activities</span><span class="p">],</span>
                                        <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;suffix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;data_prefix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">combined_df</span> <span class="o">=</span> <span class="n">combined_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;data_prefix&quot;</span><span class="p">,</span> <span class="s2">&quot;suffix&quot;</span><span class="p">])</span>
                <span class="n">combined_df</span> <span class="o">=</span> <span class="n">combined_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;suffix&#39;</span><span class="p">,</span> <span class="s1">&#39;data_prefix&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">random_enrichment</span> <span class="o">=</span> <span class="n">combined_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">random_enrichment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_enrichment</span></div>

<div class="viewcode-block" id="KinaseActivity.save_new_precomputed_random_enrichment"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.KinaseActivity.save_new_precomputed_random_enrichment">[docs]</a>    <span class="k">def</span> <span class="nf">save_new_precomputed_random_enrichment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">activities_list_df</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the new precomputed random enrichment activities to a file.</span>

<span class="sd">        This function saves the provided DataFrame of random enrichment activities to a file, using the specified column name.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        activities_list_df : pandas.DataFrame</span>
<span class="sd">            DataFrame containing the random enrichment activities to be saved.</span>
<span class="sd">        col : str</span>
<span class="sd">            Column name to be used for saving the activities.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">run_info_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_run_information_content</span><span class="p">()</span>
        <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evidence_binary</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1"># Determine the compendia directory based on phospho_type and class counts</span>
        <span class="n">compendia_class_counts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_compendia_distribution</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evidence_binary</span><span class="p">,</span> <span class="p">[</span><span class="n">col</span><span class="p">])</span>
        <span class="n">compendia_paths</span> <span class="o">=</span> <span class="p">{</span>
            <span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="s1">&#39;compendia_0_0_1_30_2_70&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="s1">&#39;compendia_0_5_1_50_2_45&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="s1">&#39;ST&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span> <span class="s1">&#39;compendia_0_0_1_30_2_70&#39;</span>
        <span class="p">}</span>

        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phospho_type</span><span class="p">,</span> <span class="n">compendia_class_counts</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">60</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phospho_type</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">compendia_paths</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid phospho_type or compendia class counts&quot;</span><span class="p">)</span>

        <span class="n">compendia_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory_for_save_precompute</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phospho_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_hash</span><span class="p">,</span>
                                           <span class="n">compendia_paths</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">compendia_file_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Save activities to file</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2">.tsv&quot;</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">compendia_file_path</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">activities_list_df</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New precomputed random enrichment data for </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> saved to </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Save run information content</span>
        <span class="n">run_info_save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory_for_save_precompute</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phospho_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_hash</span><span class="p">,</span>
                                          <span class="s2">&quot;RUN_INFORMATION.txt&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">run_info_save_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">run_info_content</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RUN_INFORMATION.txt saved to </span><span class="si">{</span><span class="n">run_info_save_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="KinaseActivity.get_run_information_content"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.KinaseActivity.get_run_information_content">[docs]</a>    <span class="k">def</span> <span class="nf">get_run_information_content</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve network information from RUN_INFORMATION.txt based on phospho_type.</span>

<span class="sd">        Reads the RUN_INFORMATION.txt file from the appropriate network directory based on</span>
<span class="sd">        the phospho_type (&#39;Y&#39; or &#39;ST&#39;). The file contains network configuration details</span>
<span class="sd">        including unique ID, date, network specifications, and compendia counts.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            Contents of RUN_INFORMATION.txt if found.</span>
<span class="sd">            &#39;RUN_INFORMATION.txt file not found.&#39; if the file doesn&#39;t exist.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If phospho_type is not &#39;Y&#39; or &#39;ST&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base_path</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">NETWORK_DIR</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phospho_type</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span>
            <span class="n">run_info_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s2">&quot;RUN_INFORMATION.txt&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">phospho_type</span> <span class="o">==</span> <span class="s1">&#39;ST&#39;</span><span class="p">:</span>
            <span class="n">run_info_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="s1">&#39;ST&#39;</span><span class="p">,</span> <span class="s2">&quot;RUN_INFORMATION.txt&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid phospho_type&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">run_info_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RUN_INFORMATION.txt file not found at: </span><span class="si">{</span><span class="n">run_info_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;RUN_INFORMATION.txt file not found.&quot;</span></div>


    <span class="k">def</span> <span class="nf">add_networks_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">networks</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">network</span> <span class="ow">in</span> <span class="n">networks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_network</span><span class="p">(</span><span class="n">nid</span><span class="p">,</span> <span class="n">network</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_networks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">networks</span><span class="p">)</span>

<div class="viewcode-block" id="KinaseActivity.add_network"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.KinaseActivity.add_network">[docs]</a>    <span class="k">def</span> <span class="nf">add_network</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">network_id</span><span class="p">,</span> <span class="n">network</span><span class="p">,</span> <span class="n">network_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add network to be analyzed</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        network_id : str</span>
<span class="sd">            name of the network</span>
<span class="sd">        network : pandas DataFrame</span>
<span class="sd">            network with columns substrate_id, site, kinase_id</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="n">network_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">network</span>
        <span class="k">if</span> <span class="n">network_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">network_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">network_sizes</span><span class="p">[</span><span class="n">network_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">network_size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">network_sizes</span><span class="p">[</span><span class="n">network_id</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">network</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_ACCESSION</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ADD NETWORK : Number of Accession Sites : </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">network_sizes</span><span class="p">[</span><span class="n">network_id</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="KinaseActivity.get_run_date"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.KinaseActivity.get_run_date">[docs]</a>    <span class="k">def</span> <span class="nf">get_run_date</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        return date that kinase activities were run</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_date</span></div>

<div class="viewcode-block" id="KinaseActivity.set_evidence"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.KinaseActivity.set_evidence">[docs]</a>    <span class="k">def</span> <span class="nf">set_evidence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evidence</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evidence to use in analysis</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        evidence : pandas DataFrame</span>
<span class="sd">            substrate sites with activity seen.</span>
<span class="sd">            columns : dict for column mapping</span>
<span class="sd">                substrate : Uniprot ID (P12345)</span>
<span class="sd">                site : phosphorylation site (Y123)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">evidence</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_ACCESSION</span> <span class="ow">in</span> <span class="n">columns</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_SITE</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
            <span class="n">phospho_type</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phospho_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">evidence</span> <span class="o">=</span> <span class="n">evidence</span><span class="p">[</span><span class="n">evidence</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">phospho_type</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Evidence not set. Evidence columns must include &#39;</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_ACCESSION</span><span class="si">}</span><span class="s2">&#39; and &#39;</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="si">}</span><span class="s2">&#39; keys&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="KinaseActivity.create_binary_evidence"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.KinaseActivity.create_binary_evidence">[docs]</a>    <span class="k">def</span> <span class="nf">create_binary_evidence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agg</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">evidence_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">greater</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a binary evidence data frame according to the parameters passed in for method for aggregating</span>
<span class="sd">        duplicates and considering whether a site is included as evidence or not</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        threshold : float</span>
<span class="sd">            threshold value used to filter rows</span>
<span class="sd">        evidence_size: None or int</span>
<span class="sd">            the number of sites to use for prediction for each sample. If a value is provided, this will override the threshold, and will instead obtain the N sites with the greatest abundance within each sample.</span>
<span class="sd">        agg : {&#39;count&#39;, &#39;mean&#39;}</span>
<span class="sd">            method to use when aggregating duplicate substrate-sites.</span>
<span class="sd">            &#39;count&#39; combines multiple representations and adds if values are non-NaN</span>
<span class="sd">            &#39;mean&#39; uses the mean value of numerical data from multiple representations of the same peptide.</span>
<span class="sd">                NA values are droped from consideration.</span>
<span class="sd">        greater: Boolean</span>
<span class="sd">            whether to keep sites that have a numerical value &gt;=threshold (TRUE, default) or &lt;=threshold (FALSE)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        evidence_binary : pd.DataFrame</span>
<span class="sd">            Matches the evidence dataframe of the kinact object, but with 0 or 1 if a site is included or not.</span>
<span class="sd">            This is uniquified and rows that are never used are removed.</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">greater</span> <span class="o">=</span> <span class="n">greater</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_data_columns</span><span class="p">()</span>

        <span class="c1"># collapse sites into single row based on agg parameter</span>
        <span class="n">evidence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evidence</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_ACCESSION</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="p">])[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
            <span class="n">agg</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="c1"># set the binary evidence for whether a site is included</span>
        <span class="n">evidence_binary</span> <span class="o">=</span> <span class="n">evidence</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">evidence_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">greater</span><span class="p">:</span>
                    <span class="n">evidence_binary</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">evidence_binary</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">evidence_binary</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">evidence_binary</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">threshold</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span><span class="p">:</span>
                <span class="c1"># check how many non_nan sites there (if less than N, set n to be equal to number of sites available)</span>
                <span class="n">num_sites_available</span> <span class="o">=</span> <span class="n">evidence_binary</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">num_sites_available</span> <span class="o">&gt;=</span> <span class="n">evidence_size</span><span class="p">:</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="n">evidence_size</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="n">num_sites_available</span>

                <span class="k">if</span> <span class="n">greater</span><span class="p">:</span>
                    <span class="n">max_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">evidence_binary</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="p">]</span>
                    <span class="n">evidence_binary</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">col_loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">evidence_binary</span><span class="o">.</span><span class="n">columns</span> <span class="o">==</span> <span class="n">col</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">evidence_binary</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">max_indices</span><span class="p">,</span> <span class="n">col_loc</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">min_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">evidence_binary</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="p">]</span>
                    <span class="n">evidence_binary</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">col_loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">evidence_binary</span><span class="o">.</span><span class="n">columns</span> <span class="o">==</span> <span class="n">col</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">evidence_binary</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">min_indices</span><span class="p">,</span> <span class="n">col_loc</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># remove phosphorylation sites that were not selected in any experiment (useful for very large experiments where removing the need to copy data reduces time)</span>
        <span class="n">evidence_binary</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">evidence_binary</span><span class="p">[</span><span class="n">evidence_binary</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># add back compendia/study bias information to binary evidence</span>
        <span class="n">compendia</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">HUMAN_REF_COMPENDIA</span><span class="p">[</span>
            <span class="p">[</span><span class="s1">&#39;KSTAR_ACCESSION&#39;</span><span class="p">,</span> <span class="s1">&#39;KSTAR_SITE&#39;</span><span class="p">,</span> <span class="s1">&#39;KSTAR_NUM_COMPENDIA&#39;</span><span class="p">,</span> <span class="s1">&#39;KSTAR_NUM_COMPENDIA_CLASS&#39;</span><span class="p">]]</span>
        <span class="n">evidence_binary</span> <span class="o">=</span> <span class="n">evidence_binary</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">compendia</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_ACCESSION</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">evidence_binary</span></div>

<div class="viewcode-block" id="KinaseActivity.calculate_kinase_activities"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.KinaseActivity.calculate_kinase_activities">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_kinase_activities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agg</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">evidence_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">greater</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">PROCESSES</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates combined activity of experiments based that uses a threshold value to determine if an experiment sees a site or not</span>
<span class="sd">        To use values use &#39;mean&#39; as agg</span>
<span class="sd">            mean aggregation drops NA values from consideration</span>
<span class="sd">        To use count use &#39;count&#39; as agg - present if not na</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data_columns : list</span>
<span class="sd">            columns that represent experimental result, if None, takes the columns that start with `data:&#39;&#39; in experiment.</span>
<span class="sd">            Pass this value in as a list, if seeking to calculate on fewer than all available data columns</span>
<span class="sd">        threshold : float</span>
<span class="sd">            threshold value used to filter rows</span>
<span class="sd">        agg : {&#39;count&#39;, &#39;mean&#39;}</span>
<span class="sd">            method to use when aggregating duplicate substrate-sites.</span>
<span class="sd">            &#39;count&#39; combines multiple representations and adds if values are non-NaN</span>
<span class="sd">            &#39;mean&#39; uses the mean value of numerical data from multiple representations of the same peptide.</span>
<span class="sd">                NA values are droped from consideration.</span>
<span class="sd">        greater: Boolean</span>
<span class="sd">            whether to keep sites that have a numerical value &gt;=threshold (TRUE, default) or &lt;=threshold (FALSE)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        activities : dict</span>
<span class="sd">            key : experiment</span>
<span class="sd">            value : pd DataFrame</span>
<span class="sd">                network : network name, from networks key</span>
<span class="sd">                kinase : kinase examined</span>
<span class="sd">                frequency : number of times kinase was seen in subgraph of evidence and network</span>
<span class="sd">                kinase_activity : hypergeometric kinase activity</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># for each phosphoType, check that the</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aggregate</span> <span class="o">=</span> <span class="n">agg</span>
        <span class="c1"># if evidence size is given, ignore threshold, otherwise record threshold</span>
        <span class="k">if</span> <span class="n">evidence_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">evidence_size</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">evidence_size</span> <span class="o">=</span> <span class="n">evidence_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">greater</span> <span class="o">=</span> <span class="n">greater</span>
        <span class="c1"># self.set_data_columns(data_columns)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">evidence_binary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_binary_evidence</span><span class="p">(</span><span class="n">agg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">aggregate</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span>
                                                           <span class="n">evidence_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">evidence_size</span><span class="p">,</span> <span class="n">greater</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">greater</span><span class="p">)</span>

        <span class="c1"># if no data columns are provided use all columns that start with data:</span>
        <span class="c1"># data columns that filtered have no evidence are removed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Kinase Activity will be run on the following data columns: </span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># MULTIPROCESSING</span>
        <span class="k">if</span> <span class="n">PROCESSES</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">PROCESSES</span><span class="p">)</span>

            <span class="n">filtered_evidence_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">evidence_binary</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">evidence_binary</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span><span class="p">]</span>
            <span class="n">networks</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">)</span>
            <span class="n">network_sizes</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network_sizes</span><span class="p">)</span>
            <span class="n">iterable</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">filtered_evidence_list</span><span class="p">,</span> <span class="n">networks</span><span class="p">,</span> <span class="n">network_sizes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span><span class="p">)</span>
            <span class="n">real_enrichment</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="n">calculate_hypergeometric_activities</span><span class="p">,</span> <span class="n">iterable</span><span class="p">)</span>

        <span class="c1"># SINGLE CORE PROCESSING</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">real_enrichment</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span><span class="p">:</span>
                <span class="n">filtered_evidence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evidence_binary</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">evidence_binary</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">act</span> <span class="o">=</span> <span class="n">calculate_hypergeometric_activities</span><span class="p">(</span><span class="n">filtered_evidence</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_sizes</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
                <span class="n">act</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">col</span>
                <span class="n">real_enrichment</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">act</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_networks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network_sizes</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">real_enrichment</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">real_enrichment</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_enrichment</span></div>

<div class="viewcode-block" id="KinaseActivity.summarize_activities"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.KinaseActivity.summarize_activities">[docs]</a>    <span class="k">def</span> <span class="nf">summarize_activities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">activities</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;median_activity&#39;</span><span class="p">,</span> <span class="n">normalized</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Builds a single combined dataframe from the provided activities such that</span>
<span class="sd">        each piece of evidence is given a single column. Values are based on the method selected.</span>
<span class="sd">        The method must be a column in the activities</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        activities : dict</span>
<span class="sd">            hypergeometric activities that have previously been summarized by network.</span>
<span class="sd">            key : experiment name</span>
<span class="sd">            value : hypergeometric activity</span>
<span class="sd">        method : str</span>
<span class="sd">            The column in the hypergeometric activity to use for summarizing data</span>

<span class="sd">        Returns</span>
<span class="sd">        ---------</span>
<span class="sd">        activity_summary : pandas DataFrame</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">activities</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">activities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_activities</span>
        <span class="n">available_methods</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">activities</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">available_methods</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">available_methods</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;the method &#39;</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&#39; is not in the availble methods. </span><span class="se">\n</span><span class="s2">Available methods include : </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">available_methods</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">activity_summary</span> <span class="o">=</span> <span class="n">activities</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_KINASE</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                                            <span class="n">values</span><span class="o">=</span><span class="n">method</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span>
            <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_KINASE</span><span class="p">)</span>
        <span class="n">activity_summary</span> <span class="o">=</span> <span class="n">activity_summary</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">activity_summary</span></div>

<div class="viewcode-block" id="KinaseActivity.aggregate_activities"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.KinaseActivity.aggregate_activities">[docs]</a>    <span class="k">def</span> <span class="nf">aggregate_activities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">activities</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Aggregate network activity using median for all activities</span>

<span class="sd">        Parameters</span>
<span class="sd">        ---------</span>
<span class="sd">        activities : dict</span>
<span class="sd">            key : Experiment</span>
<span class="sd">            value : kinase activity result</span>

<span class="sd">        Returns</span>
<span class="sd">        ---------</span>
<span class="sd">        summaries : dict</span>
<span class="sd">            key : experiment</span>
<span class="sd">            value : summarized kinase activities accross networks</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">activities</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">activities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_enrichment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agg_activities</span> <span class="o">=</span> <span class="n">activities</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_KINASE</span><span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
            <span class="n">median_activity</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;kinase_activity&#39;</span><span class="p">,</span> <span class="s1">&#39;median&#39;</span><span class="p">),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">agg_activities</span></div>

<div class="viewcode-block" id="KinaseActivity.find_pvalue_limits"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.KinaseActivity.find_pvalue_limits">[docs]</a>    <span class="k">def</span> <span class="nf">find_pvalue_limits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_columns</span><span class="p">,</span> <span class="n">agg</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For each data column and network find the lowest p-value achievable and how many</span>
<span class="sd">        seen sites are required to get to that limit.</span>
<span class="sd">        Assumptions</span>
<span class="sd">            - kinase size in network is same for all kinases</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data_columns : list</span>
<span class="sd">            what columns in evidence to compare</span>
<span class="sd">        agg : str</span>
<span class="sd">            aggregate function - what function to use for determining if site is present</span>
<span class="sd">                count : use when using activity_count</span>
<span class="sd">                mean : use when using activity_threshold</span>
<span class="sd">        threshold : float</span>
<span class="sd">            threshold to use in determining if site present in evidence</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        all_limits : pandas DataFrame</span>
<span class="sd">            p-value limits of each column for each network</span>
<span class="sd">            columns:</span>
<span class="sd">                evidence        evidence data column</span>
<span class="sd">                network         network being compared</span>
<span class="sd">                kinase          kinase being evaluated</span>
<span class="sd">                evidence_size   size of evidence</span>
<span class="sd">                limit_size      number of sites to get non-zero p-value</span>
<span class="sd">                p-value          p-value generated</span>
<span class="sd">        limit_summary : pandas DataFrame</span>
<span class="sd">            summary of all_limits by taking average over by evidence</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">evidence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evidence</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_ACCESSION</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">agg</span><span class="p">)</span>
        <span class="n">all_rows</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">kinase_sizes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">network</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># kinase_sizes[nid] = network.groupby(config.KSTAR_KINASE).size()</span>
            <span class="n">kinase_sizes</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">network</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_KINASE</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">data_columns</span><span class="p">:</span>
            <span class="n">filtered_evidence</span> <span class="o">=</span> <span class="n">evidence</span><span class="p">[</span><span class="n">evidence</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">]</span>
            <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_evidence</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_ACCESSION</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">nid</span><span class="p">,</span> <span class="n">M</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_sizes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># kinases = list(kinase_sizes[nid].index)</span>
                <span class="c1"># for kinase in kinases:</span>
                <span class="c1"># n = int(kinase_sizes[nid].loc[kinase])</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">kinase_sizes</span><span class="p">[</span><span class="n">nid</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">pvalue</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">hypergeom</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span>
                        <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
                        <span class="n">M</span><span class="o">=</span><span class="n">M</span><span class="p">,</span>
                        <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>
                        <span class="n">N</span><span class="o">=</span><span class="n">N</span>
                    <span class="p">)</span>
                    <span class="c1"># pvalue = 1 - prb</span>
                    <span class="k">if</span> <span class="n">pvalue</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="n">row</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;evidence&#39;</span><span class="p">:</span> <span class="n">col</span><span class="p">,</span>
                    <span class="s1">&#39;network&#39;</span><span class="p">:</span> <span class="n">nid</span><span class="p">,</span>
                    <span class="c1"># &#39;kinase&#39; : kinase,</span>
                    <span class="s1">&#39;evidence_size&#39;</span><span class="p">:</span> <span class="n">N</span><span class="p">,</span>
                    <span class="s1">&#39;limit_size&#39;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span>
                    <span class="s1">&#39;kinase_size&#39;</span><span class="p">:</span> <span class="n">n</span><span class="p">,</span>
                    <span class="s1">&#39;network_size&#39;</span><span class="p">:</span> <span class="n">M</span><span class="p">,</span>
                    <span class="s1">&#39;p-value&#39;</span><span class="p">:</span> <span class="n">pvalue</span>
                <span class="p">}</span>
                <span class="n">all_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="n">all_limits</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">all_rows</span><span class="p">)</span>
        <span class="n">limit_summary</span> <span class="o">=</span> <span class="n">all_limits</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;evidence&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">all_limits</span><span class="p">,</span> <span class="n">limit_summary</span></div>

<div class="viewcode-block" id="KinaseActivity.calculate_Mann_Whitney_activities_sig"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.KinaseActivity.calculate_Mann_Whitney_activities_sig">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_Mann_Whitney_activities_sig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">number_sig_trials</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">PROCESSES</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For a kinact_dict, where random generation and activity has already been run for the phospho_types of interest,</span>
<span class="sd">        this will calculate the Mann-Whitney U test for comparing the array of p-values for real data</span>
<span class="sd">        to those of random data, across the number of networks used.</span>
<span class="sd">        It will also calculate the false positive rate for a pvalue, given observations of a random bootstrapping analysis</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        kinact_dict: dictionary</span>
<span class="sd">            A dictionary of kinact objects, with keys &#39;Y&#39; and/or &#39;ST&#39;</span>
<span class="sd">        log: logger</span>
<span class="sd">            Logger for logging activity messages</span>
<span class="sd">        phospho_types: {[&#39;Y&#39;, &#39;ST&#39;], [&#39;Y&#39;], [&#39;ST&#39;]}</span>
<span class="sd">            Which substrate/kinaset-type to run activity for: Both [&#39;Y, &#39;ST&#39;] (default), Tyrosine [&#39;Y&#39;], or Serine/Threonine [&#39;ST&#39;]</span>
<span class="sd">        number_sig_trials: int</span>
<span class="sd">            Maximum number of significant trials to run</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">random_enrichment</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Random activities do not exist, please run kstar_activity.normalize_analysis&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">number_sig_trials</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_random_experiments</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Warning: number of trials for Mann Whitney exceeds number available, using </span><span class="si">%d</span><span class="s2"> instead of </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_random_experiments</span><span class="p">,</span> <span class="n">number_sig_trials</span><span class="p">))</span>
            <span class="n">number_sig_trials</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_random_experiments</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">kinases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_enrichment</span><span class="p">[</span><span class="s1">&#39;KSTAR_KINASE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activities_mann_whitney</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kinases</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activities_mann_whitney</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;KSTAR_KINASE&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fpr_mann_whitney</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kinases</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fpr_mann_whitney</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;KSTAR_KINASE&#39;</span>
        <span class="c1"># for every kinase and every dataset, calculate and assemble dataframes of activities and significance values</span>
        <span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_columns</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;MW Working on </span><span class="si">%s</span><span class="s2">: &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">exp</span><span class="p">))</span>

            <span class="c1"># Get a subset of the random and real activites for this experiment</span>
            <span class="n">activities_sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_enrichment</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">real_enrichment</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">exp</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">activities_sub</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;activities_sub failed&#39;</span><span class="p">)</span>
            <span class="n">rand_activities_sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_enrichment</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">random_enrichment</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">exp</span><span class="p">)]</span>

            <span class="k">if</span> <span class="n">rand_activities_sub</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;rand_activities_sub failed, </span><span class="si">{</span><span class="n">exp</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">pval_arr</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">fpr_arr</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">PROCESSES</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">pval</span><span class="p">,</span> <span class="n">fpr</span> <span class="ow">in</span> <span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">calculate_MannWhitney_one_experiment_one_kinase</span><span class="p">,</span> <span class="n">repeat</span><span class="p">(</span><span class="n">activities_sub</span><span class="p">),</span>
                                              <span class="n">repeat</span><span class="p">(</span><span class="n">rand_activities_sub</span><span class="p">),</span> <span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_networks</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinases</span><span class="p">,</span>
                                              <span class="n">repeat</span><span class="p">(</span><span class="n">exp</span><span class="p">),</span> <span class="n">repeat</span><span class="p">(</span><span class="n">number_sig_trials</span><span class="p">)):</span>
                    <span class="n">pval_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pval</span><span class="p">)</span>
                    <span class="n">fpr_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fpr</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">activities_mann_whitney</span><span class="p">[</span><span class="n">exp</span><span class="p">]</span> <span class="o">=</span> <span class="n">pval_arr</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fpr_mann_whitney</span><span class="p">[</span><span class="n">exp</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpr_arr</span></div>

<div class="viewcode-block" id="KinaseActivity.getFilteredCompendia"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.KinaseActivity.getFilteredCompendia">[docs]</a>    <span class="k">def</span> <span class="nf">getFilteredCompendia</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selection_type</span><span class="o">=</span><span class="s1">&#39;KSTAR_NUM_COMPENDIA_CLASS&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get phosphorylation sites binned based on selection type</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">compendia</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">HUMAN_REF_COMPENDIA</span><span class="p">[</span>
            <span class="n">config</span><span class="o">.</span><span class="n">HUMAN_REF_COMPENDIA</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phospho_type</span><span class="p">))]</span>

        <span class="n">compendia</span> <span class="o">=</span> <span class="n">compendia</span><span class="p">[[</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_ACCESSION</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="p">,</span> <span class="n">selection_type</span><span class="p">]]</span>
        <span class="n">compendia</span> <span class="o">=</span> <span class="n">compendia</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_ACCESSION</span><span class="p">,</span>
                                       <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>  <span class="c1"># uniquify the compendia by KSTAR_ACCESSION and KSTAR_SITE</span>
        <span class="n">sizes</span> <span class="o">=</span> <span class="n">compendia</span><span class="p">[</span><span class="n">selection_type</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">filtered_compendia</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sizes</span><span class="p">:</span>
            <span class="n">filtered_compendia</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">compendia</span><span class="p">[</span><span class="n">compendia</span><span class="p">[</span><span class="n">selection_type</span><span class="p">]</span> <span class="o">==</span> <span class="n">s</span><span class="p">][</span>
                <span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_ACCESSION</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="p">]]</span>

        <span class="k">return</span> <span class="n">filtered_compendia</span></div></div>


<span class="k">def</span> <span class="nf">calculate_hypergeometric_single_network</span><span class="p">(</span><span class="n">evidence</span><span class="p">,</span> <span class="n">network</span><span class="p">,</span> <span class="n">network_size</span><span class="p">,</span> <span class="n">network_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Hypergeometric Cumulative Distribution Function calculated for each kinase given evidence</span>
<span class="sd">        k : number of times kinase seen in evidence</span>
<span class="sd">        M : number of unique sites in network</span>
<span class="sd">        n : number of times kinase seen in network</span>
<span class="sd">        N : size of evidence</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    evidence : pandas df</span>
<span class="sd">        subset of kstar evidence that has been filtered to only include evidence associated with experiment</span>
<span class="sd">    network_id : str</span>
<span class="sd">        network to use for analysis</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    results : pandas df</span>
<span class="sd">        Hypergeometric results of evidence for given network</span>
<span class="sd">        index : kinase_id</span>
<span class="sd">        columns</span>
<span class="sd">            frequency : number of times kinase seen in network</span>
<span class="sd">            kinase_activity : activity derived from hypergometric cdf</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">intersect</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">evidence</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span>
                         <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_ACCESSION</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="p">])</span>

    <span class="n">counts</span> <span class="o">=</span> <span class="n">intersect</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_KINASE</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">intersect</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_ACCESSION</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">])</span>

    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;kinase_activity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="n">K</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_KINASE</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>

    <span class="n">kinases</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">index</span>
    <span class="k">for</span> <span class="n">kin</span> <span class="ow">in</span> <span class="n">kinases</span><span class="p">:</span>
        <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">counts</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">kin</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">kin</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">prb</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">hypergeom</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span>
            <span class="n">k</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">),</span>
            <span class="n">M</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">network_size</span><span class="p">),</span>
            <span class="n">n</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">kin</span><span class="p">]),</span>
            <span class="n">N</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">kin</span><span class="p">,</span> <span class="s1">&#39;kinase_activity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prb</span>

    <span class="n">kinases</span> <span class="o">=</span> <span class="n">network</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_KINASE</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">kin</span> <span class="ow">in</span> <span class="n">kinases</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">kin</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">kin</span><span class="p">,</span> <span class="s1">&#39;frequency&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">results</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">kin</span><span class="p">,</span> <span class="s1">&#39;kinase_activity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">network_id</span>
    <span class="k">return</span> <span class="n">results</span>


<span class="k">def</span> <span class="nf">calculate_hypergeometric_activities</span><span class="p">(</span><span class="n">evidence</span><span class="p">,</span> <span class="n">networks</span><span class="p">,</span> <span class="n">network_sizes</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform hypergeometric kinase activity analysis given evidence on all networks</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    evidence : pandas df</span>
<span class="sd">        subset of class evidence variable where data is filtered based on experiment</span>
<span class="sd">    name : str</span>
<span class="sd">        name of experiment being performed</span>

<span class="sd">    Returns</span>
<span class="sd">    ---------</span>
<span class="sd">    fdr_act : pd DataFrame</span>
<span class="sd">        network : network name, from networks key</span>
<span class="sd">        frequency : number of times kinase was seen in subgraph of evidence and network</span>
<span class="sd">        kinase_activity : hypergeometric kinase activity</span>
<span class="sd">        fdr_corrected_kinase_activity : kinase activity after fdr correction</span>
<span class="sd">        significant : whether kinase activity is significant based on fdr alpha</span>
<span class="sd">    combined : pd DataFrame</span>
<span class="sd">        significant : number of networks where kinase was found to be significant</span>
<span class="sd">        fraction_significant : fraction of networks kinase was found to be significant through FDR correction</span>
<span class="sd">        avg_p_value : combined p-values of kinase using mean</span>
<span class="sd">        median_p_value : combined p-values of kinase using median</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># self.logger.info(f&quot;Running hypergeometric analysis on {name}&quot;)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">network_id</span> <span class="ow">in</span> <span class="n">networks</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>  <span class="c1"># calculate kinase activity within each network</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">calculate_hypergeometric_single_network</span><span class="p">(</span><span class="n">evidence</span><span class="p">,</span> <span class="n">networks</span><span class="p">[</span><span class="n">network_id</span><span class="p">],</span> <span class="n">network_sizes</span><span class="p">[</span><span class="n">network_id</span><span class="p">],</span>
                                                         <span class="n">network_id</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="c1"># combine results into single dataframe</span>
    <span class="n">hyp_act</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    <span class="n">hyp_act</span> <span class="o">=</span> <span class="n">hyp_act</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">hyp_act</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
    <span class="k">return</span> <span class="n">hyp_act</span>


<span class="k">def</span> <span class="nf">calculate_random_activity_singleExperiment</span><span class="p">(</span><span class="n">filtered_evidence</span><span class="p">,</span> <span class="n">filtered_compendia</span><span class="p">,</span> <span class="n">networks</span><span class="p">,</span> <span class="n">network_sizes</span><span class="p">,</span> <span class="n">data_col</span><span class="p">,</span>
                                               <span class="n">num_random_experiments</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">save_experiments</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">save_experiments</span><span class="p">:</span>
        <span class="n">real_enrichment</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">all_rand_experiments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_random_experiments</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data_col</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">rand_experiment</span> <span class="o">=</span> <span class="n">generate_random_experiments</span><span class="o">.</span><span class="n">build_single_filtered_experiment</span><span class="p">(</span><span class="n">filtered_evidence</span><span class="p">,</span>
                                                                                           <span class="n">filtered_compendia</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
                                                                                           <span class="n">selection_type</span><span class="o">=</span><span class="s1">&#39;KSTAR_NUM_COMPENDIA_CLASS&#39;</span><span class="p">)</span>
            <span class="n">all_rand_experiments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rand_experiment</span><span class="p">)</span>
            <span class="n">act</span> <span class="o">=</span> <span class="n">calculate_hypergeometric_activities</span><span class="p">(</span><span class="n">rand_experiment</span><span class="p">,</span> <span class="n">networks</span><span class="p">,</span> <span class="n">network_sizes</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">real_enrichment</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">act</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">real_enrichment</span><span class="p">,</span> <span class="n">all_rand_experiments</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">real_enrichment</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_random_experiments</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data_col</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">rand_experiment</span> <span class="o">=</span> <span class="n">generate_random_experiments</span><span class="o">.</span><span class="n">build_single_filtered_experiment</span><span class="p">(</span><span class="n">filtered_evidence</span><span class="p">,</span>
                                                                                           <span class="n">filtered_compendia</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
                                                                                           <span class="n">selection_type</span><span class="o">=</span><span class="s1">&#39;KSTAR_NUM_COMPENDIA_CLASS&#39;</span><span class="p">)</span>
            <span class="n">act</span> <span class="o">=</span> <span class="n">calculate_hypergeometric_activities</span><span class="p">(</span><span class="n">rand_experiment</span><span class="p">,</span> <span class="n">networks</span><span class="p">,</span> <span class="n">network_sizes</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">real_enrichment</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">act</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">real_enrichment</span>


<span class="k">def</span> <span class="nf">calculate_random_activity_singleExperiment2</span><span class="p">(</span><span class="n">compendia_sizes</span><span class="p">,</span> <span class="n">filtered_compendia</span><span class="p">,</span> <span class="n">networks</span><span class="p">,</span> <span class="n">network_sizes</span><span class="p">,</span> <span class="n">data_col</span><span class="p">,</span>
                                                <span class="n">exp_num</span><span class="p">,</span> <span class="n">save_experiments</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data_col</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">exp_num</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="n">rand_experiment</span> <span class="o">=</span> <span class="n">generate_random_experiments</span><span class="o">.</span><span class="n">build_single_filtered_experiment</span><span class="p">(</span><span class="n">compendia_sizes</span><span class="p">,</span> <span class="n">filtered_compendia</span><span class="p">,</span>
                                                                                   <span class="n">name</span><span class="p">,</span>
                                                                                   <span class="n">selection_type</span><span class="o">=</span><span class="s1">&#39;KSTAR_NUM_COMPENDIA_CLASS&#39;</span><span class="p">)</span>
    <span class="n">act</span> <span class="o">=</span> <span class="n">calculate_hypergeometric_activities</span><span class="p">(</span><span class="n">rand_experiment</span><span class="p">,</span> <span class="n">networks</span><span class="p">,</span> <span class="n">network_sizes</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">save_experiments</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">act</span><span class="p">,</span> <span class="n">rand_experiment</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">act</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">****************************************</span>
<span class="sd">Methods for Mann Whitney analysis</span>
<span class="sd">****************************************</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="k">def</span> <span class="nf">calculate_fpr_Mann_Whitney</span><span class="p">(</span><span class="n">random_kinase_activity_array</span><span class="p">,</span> <span class="n">number_sig_trials</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given an mxn array of kinase activities from m random experiments across n networks</span>
<span class="sd">    use bootstrapping to calculate an empirical p-value at which the false positive rate is controlled.</span>
<span class="sd">    This function takes one of m random experiments and calculates the Mann Whitney U pvalue</span>
<span class="sd">    then finds the pvalue at which the target_alpha is achieved</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    random_kinase_activity_array: np.array</span>
<span class="sd">        See calculate_MannWhitney_one_experiment_one_kinase for unwrapping all activities for a kinase and experiment</span>
<span class="sd">    number_sig_trials:</span>
<span class="sd">        Number of random trials to perform, where one random set is tested number_sig_trials against the full background</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    random_stats: np.array</span>
<span class="sd">        A vector of Mann Whitney p-values that is m long, representing pvalues from m bootstrap tests</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># calculate the significance by taking each experiment</span>
    <span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">random_kinase_activity_array</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">number_sig_trials</span> <span class="o">&gt;</span> <span class="n">m</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning, using </span><span class="si">%d</span><span class="s2">, maximum number for significance&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">m</span><span class="p">))</span>
        <span class="n">number_sig_trials</span> <span class="o">=</span> <span class="n">m</span>
    <span class="n">random_stats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">number_sig_trials</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">number_sig_trials</span><span class="p">):</span>
        <span class="c1"># take out one vector as real</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="n">random_kinase_activity_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">bgnd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">random_kinase_activity_array</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># remove the sample before testing</span>
        <span class="p">[</span><span class="n">stat</span><span class="p">,</span> <span class="n">random_stats</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">mannwhitneyu</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">sample</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">bgnd</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">bgnd</span><span class="o">.</span><span class="n">size</span><span class="p">)),</span>
                                                     <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;greater&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">random_stats</span>


<span class="k">def</span> <span class="nf">calculate_MannWhitney_one_experiment_one_kinase</span><span class="p">(</span><span class="n">kinact_activities</span><span class="p">,</span> <span class="n">rand_activities</span><span class="p">,</span> <span class="n">number_networks</span><span class="p">,</span> <span class="n">kinase</span><span class="p">,</span>
                                                    <span class="n">experiment</span><span class="p">,</span> <span class="n">number_sig_trials</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For a given kinact object, where random generation and activity has already been run, this will calculate</span>
<span class="sd">    the Mann-Whitney U test between the p-values across all networks for the given experiment name</span>
<span class="sd">    and from the random networks. It will also calculate the significance value for the given test</span>
<span class="sd">    based on the target_alpha value by using each random set as a real set to bootstrap.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kinact_activities : pandas.DataFrame</span>
<span class="sd">        DataFrame containing kinase activities for real experiments.</span>
<span class="sd">    rand_activities : pandas.DataFrame</span>
<span class="sd">        DataFrame containing kinase activities for random experiments.</span>
<span class="sd">    number_networks : int</span>
<span class="sd">        Number of networks used in the analysis.</span>
<span class="sd">    kinase : str</span>
<span class="sd">        Kinase name to measure significance for.</span>
<span class="sd">    experiment : str</span>
<span class="sd">        Experiment name to measure significance for.</span>
<span class="sd">    number_sig_trials : int</span>
<span class="sd">        Number of random trials to perform for significance testing.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    p_value : float</span>
<span class="sd">        p-value that results from Mann-Whitney U test.</span>
<span class="sd">    fpr_value : float</span>
<span class="sd">        The false positive rate where the p_value for the real experiment lies, given the random experiments.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">kinase_activity_list</span> <span class="o">=</span> <span class="n">kinact_activities</span><span class="p">[(</span><span class="n">kinact_activities</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_KINASE</span><span class="p">]</span> <span class="o">==</span> <span class="n">kinase</span><span class="p">)</span> <span class="o">&amp;</span>
        <span class="p">(</span><span class="n">kinact_activities</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">experiment</span><span class="p">)]</span><span class="o">.</span><span class="n">kinase_activity</span><span class="o">.</span><span class="n">values</span>

    <span class="n">filtered_rand_activities</span> <span class="o">=</span> <span class="n">rand_activities</span><span class="p">[</span><span class="n">rand_activities</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_KINASE</span><span class="p">]</span> <span class="o">==</span> <span class="n">kinase</span><span class="p">]</span>
    <span class="n">random_kinase_activity_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">number_sig_trials</span><span class="p">,</span> <span class="n">number_networks</span><span class="p">])</span>

    <span class="c1"># Randomly sample experiment indices from the available experiments</span>
    <span class="n">available_experiments</span> <span class="o">=</span> <span class="n">filtered_rand_activities</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">sampled_experiments</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">available_experiments</span><span class="p">,</span> <span class="n">number_sig_trials</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">experiment_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sampled_experiments</span><span class="p">):</span>
        <span class="n">random_kinase_activity_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">filtered_rand_activities</span><span class="p">[</span>
            <span class="n">filtered_rand_activities</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">experiment_name</span>
        <span class="p">]</span><span class="o">.</span><span class="n">kinase_activity</span><span class="o">.</span><span class="n">values</span>

    <span class="p">[</span><span class="n">stat</span><span class="p">,</span> <span class="n">p_value</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">mannwhitneyu</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">kinase_activity_list</span><span class="p">),</span>
        <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">random_kinase_activity_array</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">random_kinase_activity_array</span><span class="o">.</span><span class="n">size</span><span class="p">)),</span><span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;greater&#39;</span><span class="p">)</span>

    <span class="c1"># Calculate FPR using the helper function</span>
    <span class="n">randomStats</span> <span class="o">=</span> <span class="n">calculate_fpr_Mann_Whitney</span><span class="p">(</span><span class="n">random_kinase_activity_array</span><span class="p">,</span> <span class="n">number_sig_trials</span><span class="p">)</span>
    <span class="n">fpr_value</span> <span class="o">=</span> <span class="n">calculate_fpr</span><span class="o">.</span><span class="n">single_pvalue_fpr</span><span class="p">(</span><span class="n">randomStats</span><span class="p">,</span> <span class="n">p_value</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">fpr_value</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">****************************************</span>
<span class="sd">Methods for running KSTAR pipeline</span>
<span class="sd">****************************************</span>
<span class="sd">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="enrichment_analysis"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.enrichment_analysis">[docs]</a><span class="k">def</span> <span class="nf">enrichment_analysis</span><span class="p">(</span><span class="n">experiment</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">networks</span><span class="p">,</span> <span class="n">phospho_types</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;ST&#39;</span><span class="p">],</span> <span class="n">data_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">agg</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span>
                        <span class="n">threshold</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">evidence_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">greater</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">PROCESSES</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to establish a kstar KinaseActivity object from an experiment with an activity log</span>
<span class="sd">    add the networks, calculate, aggregate, and summarize the hypergeometric enrichment into a final activity object. Should be followed by</span>
<span class="sd">    randomized_analyis, then Mann_Whitney_analysis.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    experiment: pandas df</span>
<span class="sd">        experiment dataframe that has been mapped, includes KSTAR_SITE, KSTAR_ACCESSION, etc.</span>
<span class="sd">    log: logger object</span>
<span class="sd">        Log to write activity log error and update to</span>
<span class="sd">    networks: dictionary of dictionaries</span>
<span class="sd">        Outer dictionary keys are &#39;Y&#39; and &#39;ST&#39;.</span>
<span class="sd">        Establish a network by loading a pickle of desired networks. See the helpers and config file for this.</span>
<span class="sd">        If downloaded from FigShare, then the GLOBAL network pickles in config file can be loaded</span>
<span class="sd">        For example: networks[&#39;Y&#39;] = pickle.load(open(config.NETWORK_Y_PICKLE, &quot;rb&quot; ))</span>
<span class="sd">    phospho_types: {[&#39;Y&#39;, &#39;ST&#39;], [&#39;Y&#39;], [&#39;ST&#39;]}</span>
<span class="sd">        Which substrate/kinaset-type to run activity for: Both [&#39;Y, &#39;ST&#39;] (default), Tyrosine [&#39;Y&#39;], or Serine/Threonine [&#39;ST&#39;]</span>
<span class="sd">    data_columns : list</span>
<span class="sd">        columns that represent experimental result, if None, takes the columns that start with `data:&#39;&#39; in experiment.</span>
<span class="sd">        Pass this value in as a list, if seeking to calculate on fewer than all available data columns</span>
<span class="sd">    agg : {&#39;count&#39;, &#39;mean&#39;}</span>
<span class="sd">        method to use when aggregating duplicate substrate-sites.</span>
<span class="sd">        &#39;count&#39; combines multiple representations and adds if values are non-NaN</span>
<span class="sd">        &#39;mean&#39; uses the mean value of numerical data from multiple representations of the same peptide.</span>
<span class="sd">            NA values are droped from consideration.</span>
<span class="sd">    threshold : float</span>
<span class="sd">        threshold value used to filter rows</span>
<span class="sd">    greater: Boolean</span>
<span class="sd">        whether to keep sites that have a numerical value &gt;=threshold (TRUE, default) or &lt;=threshold (FALSE)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    kinactDict: dictionary of Kinase Activity Objects</span>
<span class="sd">        Outer keys are phosphoTypes run &#39;Y&#39; and &#39;ST&#39;</span>
<span class="sd">        Includes the activities dictionary (see calculate_kinase_activities)</span>
<span class="sd">        aggregation of activities across networks (see aggregate activities)</span>
<span class="sd">        activity summary (see summarize_activities)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kinact_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># For each phosphoType of interest, establish a kinase activity object on a filtered dataset and run, aggregate, and summarize activity</span>
    <span class="k">for</span> <span class="n">phospho_type</span> <span class="ow">in</span> <span class="n">phospho_types</span><span class="p">:</span>
        <span class="c1"># first check that networks for the phosphotypes were passed in</span>
        <span class="k">if</span> <span class="n">phospho_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">networks</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR: Please pass networks as dictionary with phosphotype key&quot;</span><span class="p">)</span>
        <span class="c1"># filter the experiment (log how many are of that type)</span>
        <span class="k">if</span> <span class="n">phospho_type</span> <span class="o">==</span> <span class="s1">&#39;ST&#39;</span><span class="p">:</span>
            <span class="n">experiment_sub</span> <span class="o">=</span> <span class="n">experiment</span><span class="p">[</span>
                <span class="p">(</span><span class="n">experiment</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;S&#39;</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">experiment</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">))]</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running Serine/Threonine Kinase Activity Analysis&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">phospho_type</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span>
            <span class="n">experiment_sub</span> <span class="o">=</span> <span class="n">experiment</span><span class="p">[(</span><span class="n">experiment</span><span class="o">.</span><span class="n">KSTAR_SITE</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">))]</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running Tyrosine Kinase Activity Analysis&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR: Did not recognize phosphoType </span><span class="si">%s</span><span class="s2">, which should only include &#39;Y&#39; or &#39;ST&#39; &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">phospho_type</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="n">kinact</span> <span class="o">=</span> <span class="n">KinaseActivity</span><span class="p">(</span><span class="n">experiment_sub</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">data_columns</span><span class="o">=</span><span class="n">data_columns</span><span class="p">,</span> <span class="n">phospho_type</span><span class="o">=</span><span class="n">phospho_type</span><span class="p">)</span>
        <span class="n">kinact</span><span class="o">.</span><span class="n">add_networks_batch</span><span class="p">(</span><span class="n">networks</span><span class="p">[</span><span class="n">phospho_type</span><span class="p">])</span>
        <span class="n">kinact</span><span class="o">.</span><span class="n">calculate_kinase_activities</span><span class="p">(</span><span class="n">agg</span><span class="o">=</span><span class="n">agg</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span> <span class="n">evidence_size</span><span class="o">=</span><span class="n">evidence_size</span><span class="p">,</span> <span class="n">greater</span><span class="o">=</span><span class="n">greater</span><span class="p">,</span>
                                           <span class="n">PROCESSES</span><span class="o">=</span><span class="n">PROCESSES</span><span class="p">)</span>
        <span class="c1">#kinact.aggregate_activities()</span>
        <span class="c1">#kinact.activities = kinact.summarize_activities()</span>
        <span class="n">kinact_dict</span><span class="p">[</span><span class="n">phospho_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">kinact</span>
    <span class="k">return</span> <span class="n">kinact_dict</span></div>

<div class="viewcode-block" id="randomized_analysis"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.randomized_analysis">[docs]</a><span class="k">def</span> <span class="nf">randomized_analysis</span><span class="p">(</span><span class="n">kinact_dict</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">num_random_experiments</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">use_pregen_data</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="n">save_new_precompute</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">pregenerated_experiments_path</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">directory_for_save_precompute</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">network_hash</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">save_random_experiments</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">PROCESSES</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform randomized analysis on kinase activity data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kinact_dict : dict</span>
<span class="sd">        Dictionary containing kinase activity data.</span>
<span class="sd">    log : Logger object</span>
<span class="sd">        Logger to record the progress and any issues during the randomization pipeline.</span>
<span class="sd">    num_random_experiments : int, optional</span>
<span class="sd">        Number of random experiments to generate, by default 150.</span>
<span class="sd">    use_pregen_data : bool, optional</span>
<span class="sd">        Whether to use pre-generated data, by default False.</span>
<span class="sd">    save_new_precompute : bool, optional</span>
<span class="sd">        Whether to save new precomputed data, by default None.</span>
<span class="sd">    pregenerated_experiments_path : str, optional</span>
<span class="sd">        Path to the directory containing pre-generated experiments, by default None.</span>
<span class="sd">    directory_for_save_precompute : str, optional</span>
<span class="sd">        Directory to save new precomputed data, by default None.</span>
<span class="sd">    network_hash : str, optional</span>
<span class="sd">        Hash of the network used, by default None.</span>
<span class="sd">    save_random_experiments : bool, optional</span>
<span class="sd">        Whether to save the generated random experiments, by default None.</span>
<span class="sd">    PROCESSES : int, optional</span>
<span class="sd">        Number of processes to use for parallel computation, by default 1.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">use_pregen_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">use_pregen_data</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">USE_PREGEN_DATA</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">use_pregen_data</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;use_pregen_data must be True or False&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">save_new_precompute</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">save_new_precompute</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">SAVE_NEW_PRECOMPUTE</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">save_new_precompute</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;use_pregen_data must be True or False&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pregenerated_experiments_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pregenerated_experiments_path</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">PREGENERATED_EXPERIMENTS_PATH</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pregenerated_experiments_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;pregenerated_experiments_path must be a string&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">directory_for_save_precompute</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">directory_for_save_precompute</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">DIRECTORY_FOR_SAVE_PRECOMPUTE</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">directory_for_save_precompute</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;pregenerated_experiments_path must be a string&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">phospho_type</span><span class="p">,</span> <span class="n">kinact</span> <span class="ow">in</span> <span class="n">kinact_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">network_hash</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">phospho_type</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span>
                <span class="n">network_hash</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">NETWORK_HASH_Y</span>
            <span class="k">elif</span> <span class="n">phospho_type</span> <span class="o">==</span> <span class="s1">&#39;ST&#39;</span><span class="p">:</span>
                <span class="n">network_hash</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">NETWORK_HASH_ST</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">fullmatch</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[a-fA-F0-9]</span><span class="si">{64}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">network_hash</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;network_hash must be a valid SHA-256 hash&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">phospho_type</span><span class="p">,</span> <span class="n">kinact</span> <span class="ow">in</span> <span class="n">kinact_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">kinact</span><span class="o">.</span><span class="n">calculate_random_activities</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="n">num_random_experiments</span><span class="p">,</span> <span class="n">use_pregen_data</span><span class="p">,</span><span class="n">save_new_precompute</span><span class="p">,</span>
                                           <span class="n">pregenerated_experiments_path</span><span class="p">,</span> <span class="n">directory_for_save_precompute</span><span class="p">,</span>
                                           <span class="n">network_hash</span><span class="p">,</span> <span class="n">save_random_experiments</span><span class="p">,</span> <span class="n">PROCESSES</span><span class="o">=</span><span class="n">PROCESSES</span><span class="p">)</span>
    <span class="c1"># Ensure `random_experiments` is stored in `kinact_dict`</span>
    <span class="n">kinact_dict</span><span class="p">[</span><span class="n">phospho_type</span><span class="p">]</span><span class="o">.</span><span class="n">random_experiments</span> <span class="o">=</span> <span class="n">kinact</span><span class="o">.</span><span class="n">random_experiments</span></div>

<div class="viewcode-block" id="Mann_Whitney_analysis"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.Mann_Whitney_analysis">[docs]</a><span class="k">def</span> <span class="nf">Mann_Whitney_analysis</span><span class="p">(</span><span class="n">kinact_dict</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">number_sig_trials</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">PROCESSES</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For a kinact_dict, where random generation and activity has already been run for the phospho_types of interest,</span>
<span class="sd">    this will calculate the Mann-Whitney U test for comparing the array of p-values for real data</span>
<span class="sd">    to those of random data, across the number of networks used.</span>
<span class="sd">    It will also calculate the false positive rate for a pvalue, given observations of a random bootstrapping analysis</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kinact_dict: dictionary</span>
<span class="sd">        A dictionary of kinact objects, with keys &#39;Y&#39; and/or &#39;ST&#39;</span>
<span class="sd">    log: logger</span>
<span class="sd">        Logger for logging activity messages</span>
<span class="sd">    number_sig_trials: int</span>
<span class="sd">        Maximum number of significant trials to run</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">phospho_type</span><span class="p">,</span> <span class="n">kinact</span> <span class="ow">in</span> <span class="n">kinact_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">kinact</span><span class="o">.</span><span class="n">calculate_Mann_Whitney_activities_sig</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="n">number_sig_trials</span><span class="o">=</span><span class="n">number_sig_trials</span><span class="p">,</span> <span class="n">PROCESSES</span><span class="o">=</span><span class="n">PROCESSES</span><span class="p">)</span></div>


<div class="viewcode-block" id="save_kstar"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.save_kstar">[docs]</a><span class="k">def</span> <span class="nf">save_kstar</span><span class="p">(</span><span class="n">kinact_dict</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">odir</span><span class="p">,</span> <span class="n">PICKLE</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Having performed kinase activities (run_kstar_analyis), save each of the important dataframes to files and the final pickle</span>
<span class="sd">    Saves an activities, aggregated_activities, summarized_activities tab-separated files</span>
<span class="sd">    Saves a pickle file of dictionary</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kinact_dict: dictionary of Kinase Activity Objects</span>
<span class="sd">        Outer keys are phosphoTypes run &#39;Y&#39; and &#39;ST&#39;</span>
<span class="sd">        Includes the activities dictionary (see calculate_kinase_activities)</span>
<span class="sd">        aggregation of activities across networks (see aggregate activities)</span>
<span class="sd">        activity summary (see summarize_activities)</span>
<span class="sd">    name: string</span>
<span class="sd">        The name to use when saving activities</span>
<span class="sd">    odir:  string</span>
<span class="sd">        Outputdirectory to save files and pickle to</span>
<span class="sd">    PICKLE: boolean</span>
<span class="sd">        Whether to save the entire pickle file</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Nothing</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS&quot;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">phospho_type</span> <span class="ow">in</span> <span class="n">kinact_dict</span><span class="p">:</span>
        <span class="n">kinact</span> <span class="o">=</span> <span class="n">kinact_dict</span><span class="p">[</span><span class="n">phospho_type</span><span class="p">]</span>
        <span class="n">name_out</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">phospho_type</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">kinact</span><span class="o">.</span><span class="n">real_enrichment</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name_out</span><span class="si">}</span><span class="s2">_real_enrichment.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">kinact</span><span class="o">.</span><span class="n">evidence_binary</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name_out</span><span class="si">}</span><span class="s2">_binarized_experiment.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">kinact</span><span class="p">,</span> <span class="s1">&#39;random_experiments&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">kinact</span><span class="o">.</span><span class="n">random_experiments</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kinact</span><span class="o">.</span><span class="n">random_experiments</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name_out</span><span class="si">}</span><span class="s2">_random_experiments.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">kinact</span><span class="p">,</span> <span class="s1">&#39;random_enrichment&#39;</span><span class="p">):</span>
            <span class="n">kinact</span><span class="o">.</span><span class="n">random_enrichment</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name_out</span><span class="si">}</span><span class="s2">_random_enrichment.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">kinact</span><span class="p">,</span> <span class="s1">&#39;activities_mann_whitney&#39;</span><span class="p">):</span>
            <span class="n">kinact</span><span class="o">.</span><span class="n">activities_mann_whitney</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name_out</span><span class="si">}</span><span class="s2">_mann_whitney_activities.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span>
                                                  <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">kinact</span><span class="o">.</span><span class="n">fpr_mann_whitney</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name_out</span><span class="si">}</span><span class="s2">_mann_whitney_fpr.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">PICKLE</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">kinact_dict</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_kinact.p&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">))</span></div>


<div class="viewcode-block" id="save_kstar_slim"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.save_kstar_slim">[docs]</a><span class="k">def</span> <span class="nf">save_kstar_slim</span><span class="p">(</span><span class="n">kinact_dict</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">odir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Having performed kinase activities (run_kstar_analyis), save each of the important dataframes, minimizing the memory storage needed to get back</span>
<span class="sd">    to a rebuilt version for plotting results and analysis. For each phospho_type in the kinact_dict, this will save three .tsv files for every activities</span>
<span class="sd">    analysis run, two additional if random analysis was run, and two more if Mann Whitney based analysis was run. It also creates a readme file of the parameter values</span>
<span class="sd">    used</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kinact_dict: dictionary of Kinase Activity Objects</span>
<span class="sd">        Outer keys are phosphoTypes run &#39;Y&#39; and &#39;ST&#39;</span>
<span class="sd">        Includes the activities dictionary (see calculate_kinase_activities)</span>
<span class="sd">        aggregation of activities across networks (see aggregate activities)</span>
<span class="sd">        activity summary (see summarize_activities)</span>
<span class="sd">    name: string</span>
<span class="sd">        The name to use when saving activities</span>
<span class="sd">    odir:  string</span>
<span class="sd">        Outputdirectory to save files and pickle to</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Nothing</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS&quot;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS&quot;</span><span class="p">)</span>

    <span class="n">param_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">phospho_type</span> <span class="ow">in</span> <span class="n">kinact_dict</span><span class="p">:</span>

        <span class="n">kinact</span> <span class="o">=</span> <span class="n">kinact_dict</span><span class="p">[</span><span class="n">phospho_type</span><span class="p">]</span>
        <span class="n">name_out</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">phospho_type</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">param_temp</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">param_temp</span><span class="p">[</span><span class="s1">&#39;data_columns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kinact</span><span class="o">.</span><span class="n">data_columns</span>
        <span class="n">param_temp</span><span class="p">[</span><span class="s1">&#39;aggregate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kinact</span><span class="o">.</span><span class="n">aggregate</span>
        <span class="n">param_temp</span><span class="p">[</span><span class="s1">&#39;greater&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kinact</span><span class="o">.</span><span class="n">greater</span>
        <span class="n">param_temp</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kinact</span><span class="o">.</span><span class="n">threshold</span>
        <span class="n">param_temp</span><span class="p">[</span><span class="s1">&#39;run_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kinact</span><span class="o">.</span><span class="n">run_date</span>
        <span class="n">param_temp</span><span class="p">[</span><span class="s1">&#39;mann_whitney&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">param_temp</span><span class="p">[</span><span class="s1">&#39;randomized&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">param_temp</span><span class="p">[</span><span class="s1">&#39;num_networks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kinact</span><span class="o">.</span><span class="n">num_networks</span>
        <span class="n">param_temp</span><span class="p">[</span><span class="s1">&#39;network_directory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kinact</span><span class="o">.</span><span class="n">network_directory</span>

        <span class="n">kinact</span><span class="o">.</span><span class="n">real_enrichment</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name_out</span><span class="si">}</span><span class="s2">_real_enrichment.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># kinact.activities.to_csv(f&quot;{odir}/RESULTS/{name_out}_activities.tsv&quot;, sep = &#39;\t&#39;, index = True)</span>
        <span class="n">kinact</span><span class="o">.</span><span class="n">evidence_binary</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name_out</span><span class="si">}</span><span class="s2">_binarized_experiment.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">kinact</span><span class="p">,</span> <span class="s1">&#39;random_enrichment&#39;</span><span class="p">):</span>
            <span class="n">param_temp</span><span class="p">[</span><span class="s1">&#39;randomized&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">param_temp</span><span class="p">[</span><span class="s1">&#39;num_random_experiments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kinact</span><span class="o">.</span><span class="n">num_random_experiments</span>
            <span class="n">kinact</span><span class="o">.</span><span class="n">random_enrichment</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name_out</span><span class="si">}</span><span class="s2">_random_enrichment.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1"># if hasattr(kinact, &#39;random_experiments&#39;):</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">kinact</span><span class="p">,</span> <span class="s1">&#39;activities_mann_whitney&#39;</span><span class="p">):</span>
            <span class="n">param_temp</span><span class="p">[</span><span class="s1">&#39;mann_whitney&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">kinact</span><span class="o">.</span><span class="n">activities_mann_whitney</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name_out</span><span class="si">}</span><span class="s2">_mann_whitney_activities.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span>
                                                  <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">kinact</span><span class="o">.</span><span class="n">fpr_mann_whitney</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name_out</span><span class="si">}</span><span class="s2">_mann_whitney_fpr.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">param_dict</span><span class="p">[</span><span class="n">phospho_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_temp</span>

    <span class="c1"># save the parameters in a pickle file for reinstantiating object information</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">param_dict</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_params.p&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">))</span></div>


<div class="viewcode-block" id="from_kstar_slim"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.from_kstar_slim">[docs]</a><span class="k">def</span> <span class="nf">from_kstar_slim</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">odir</span><span class="p">,</span> <span class="n">log</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given the name and output directory of a saved kstar analyis, load the parameters and minimum dataframes needed for reinstantiating a kinact object</span>
<span class="sd">    This minimum list will allow you to repeat normalization or mann whitney at a different false positive rate threshold and plot results.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name: string</span>
<span class="sd">        The name to used when saving activities and mapped data</span>
<span class="sd">    odir:  string</span>
<span class="sd">        Output directory of saved files and parameter pickle</span>
<span class="sd">    log: logger</span>
<span class="sd">        Logger for logging activity messages</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># First check for the param file</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">param_dict</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_params.p&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR: Cannot find parameter dictionary file in RESULTS: </span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_params.p&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR: Cannot find parameter dictionary file in RESULTS: </span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_params.p&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">kinact_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">phospho_type</span> <span class="ow">in</span> <span class="n">param_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">param_dict</span><span class="p">[</span><span class="n">phospho_type</span><span class="p">]</span>
        <span class="n">name_out</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">phospho_type</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="c1"># instantiate an object and update values according to</span>

        <span class="c1"># check that the minimum file set exists so we can use binary_evidence file as the experiment</span>
        <span class="n">evidence_binary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name_out</span><span class="si">}</span><span class="s2">_binarized_experiment.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">kinact</span> <span class="o">=</span> <span class="n">KinaseActivity</span><span class="p">(</span><span class="n">evidence_binary</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">phospho_type</span><span class="o">=</span><span class="n">phospho_type</span><span class="p">)</span>

        <span class="n">kinact</span><span class="o">.</span><span class="n">real_enrichment</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name_out</span><span class="si">}</span><span class="s2">_real_enrichment.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">kinact</span><span class="o">.</span><span class="n">evidence_binary</span> <span class="o">=</span> <span class="n">evidence_binary</span>

        <span class="k">if</span> <span class="s1">&#39;mann_whitney&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># read mann_whitney and load</span>
            <span class="n">kinact</span><span class="o">.</span><span class="n">activities_mann_whitney</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name_out</span><span class="si">}</span><span class="s2">_mann_whitney_activities.tsv&quot;</span><span class="p">,</span>
                                                         <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_KINASE</span><span class="p">)</span>
            <span class="n">kinact</span><span class="o">.</span><span class="n">fpr_mann_whitney</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name_out</span><span class="si">}</span><span class="s2">_mann_whitney_fpr.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span>
                                                  <span class="n">index_col</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_KINASE</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;mann_whitney&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;randomized&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">kinact</span><span class="o">.</span><span class="n">random_enrichment</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name_out</span><span class="si">}</span><span class="s2">_random_enrichment.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name_out</span><span class="si">}</span><span class="s2">_random_experiments.tsv&quot;</span><span class="p">):</span>
                <span class="n">kinact</span><span class="o">.</span><span class="n">random_experiments</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/RESULTS/</span><span class="si">{</span><span class="n">name_out</span><span class="si">}</span><span class="s2">_random_experiments.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">kinact</span><span class="p">,</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="n">param_name</span><span class="p">])</span>
        <span class="n">kinact_dict</span><span class="p">[</span><span class="n">phospho_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">kinact</span>
    <span class="k">return</span> <span class="n">kinact_dict</span></div>


<div class="viewcode-block" id="from_kstar_nextflow"><a class="viewcode-back" href="../../KSTAR.html#kstar.calculate.from_kstar_nextflow">[docs]</a><span class="k">def</span> <span class="nf">from_kstar_nextflow</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">odir</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given the name and output directory of a saved kstar analyis from the nextflow pipeline, load the results into new kinact object with</span>
<span class="sd">    the minimum dataframes required for analysis (binary experiment, hypergeometric activities, normalized activities, mann whitney activities)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name: string</span>
<span class="sd">        The name to used when saving activities and mapped data</span>
<span class="sd">    odir:  string</span>
<span class="sd">        Output directory of saved files</span>
<span class="sd">    log: logger</span>
<span class="sd">        logger used when loading nextflow data into kinase activity object. If not provided, new logger will be created.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># create new logger if not provided</span>
    <span class="k">if</span> <span class="n">log</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;activity_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/activity_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.log&quot;</span><span class="p">)</span>

    <span class="n">kinact_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">phospho_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;ST&#39;</span><span class="p">]:</span>
        <span class="c1"># check to see if folder for phosphotype is present (have Y or ST activities been calculated)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">phospho_type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="c1"># check that the minimum file set exists so we can use binary_evidence file as the experiment</span>
            <span class="n">evidence_binary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">phospho_type</span><span class="si">}</span><span class="s2">/binary_experiment/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_binarized_experiment.tsv&quot;</span><span class="p">,</span>
                                          <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">kinact</span> <span class="o">=</span> <span class="n">KinaseActivity</span><span class="p">(</span><span class="n">evidence_binary</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">phospho_type</span><span class="o">=</span><span class="n">phospho_type</span><span class="p">)</span>

            <span class="n">kinact</span><span class="o">.</span><span class="n">real_enrichment</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">phospho_type</span><span class="si">}</span><span class="s2">/hypergeometric_activity/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_real_enrichment.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">kinact</span><span class="o">.</span><span class="n">activities</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">phospho_type</span><span class="si">}</span><span class="s2">/hypergeometric_activity/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_activities.tsv&quot;</span><span class="p">,</span>
                                            <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_KINASE</span><span class="p">)</span>
            <span class="n">kinact</span><span class="o">.</span><span class="n">evidence_binary</span> <span class="o">=</span> <span class="n">evidence_binary</span>

            <span class="c1"># read mann_whitney and load</span>
            <span class="n">kinact</span><span class="o">.</span><span class="n">activities_mann_whitney</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">phospho_type</span><span class="si">}</span><span class="s2">/mann_whitney/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_mann_whitney_activities.tsv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="n">index_col</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_KINASE</span><span class="p">)</span>
            <span class="n">kinact</span><span class="o">.</span><span class="n">fpr_mann_whitney</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">odir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">phospho_type</span><span class="si">}</span><span class="s2">/mann_whitney/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_mann_whitney_fpr.tsv&quot;</span><span class="p">,</span>
                                                  <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">KSTAR_KINASE</span><span class="p">)</span>

            <span class="n">kinact_dict</span><span class="p">[</span><span class="n">phospho_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">kinact</span>

    <span class="c1"># check to see if any files were loaded</span>
    <span class="k">if</span> <span class="n">kinact_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;KSTAR results were not found for either Y or ST&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">kinact_dict</span></div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../../index.html">Table of Contents</a></h3>
    <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Dependencies.html">Dependencies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../KSTAR.html">KSTAR</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Tutorial/tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Examples/Examples.html">Analysis Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Parallel/parallel.html">KSTAR in Parallel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq.html">Frequently Asked Questions</a></li>
</ul>

  </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">KSTAR 1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">kstar.calculate</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, Naegle Lab.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.3.0.
    </div>
  </body>
</html>