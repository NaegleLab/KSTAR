
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Running Large Datasets with Nextflow &#8212; KSTAR 1 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/classic.css" />
    
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Analysis of HER2 Positive Patients using Microbiopsies ()" href="Examples/Microbiopsy_Analysis.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="Examples/Microbiopsy_Analysis.html" title="Analysis of HER2 Positive Patients using Microbiopsies ()"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">KSTAR 1 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Running Large Datasets with Nextflow</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section class="tex2jax_ignore mathjax_ignore" id="running-large-datasets-with-nextflow">
<h1>Running Large Datasets with Nextflow<a class="headerlink" href="#running-large-datasets-with-nextflow" title="Permalink to this headline">¶</a></h1>
<p>While our standard implementation of KSTAR can be run on most phosphotyrosine datasets and some small phosphoserine/threonine datasets, the memory and time costs are often too high for many large datasets. For these cases, we have implemented a highly parallel version of KSTAR  implemented with the nextflow software package. This implementation is best suited for high performance computing environments, with a minimum of 8 cpu cores and 16GB of available memory required. The remainder of this section will detail how to install and run KSTAR with nextflow.</p>
<section id="requirements">
<h2>Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h2>
<p>The nextflow pipeline that takes advantage of either Docker or Singularity containers. These are compatible with POSIX operating systems (Linux, OS X, etc.). However, KSTAR-HP can also be run on a Windows machine with the use of WSL2. For details on how to set up the WSL2 environment, see Section (enter here). For other details about nextflow, please see their documentation here: https://www.nextflow.io/</p>
</section>
<section id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h2>
<p>Before implementing KSTAR with nextflow, Docker will need to be installed. The nextflow implementation utilizes a docker container of the KSTAR algorithm. For details on how to install Docker, visit https://docs.docker.com/get-docker/.</p>
<p>First, it is recommended that you download KSTAR from github into an easily accessible folder:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">NaegleLab</span><span class="o">/</span><span class="n">KSTAR</span><span class="o">.</span><span class="n">git</span>
</pre></div>
</div>
<p>Next, set up a conda virtual environment and install nextflow:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">conda</span> <span class="n">create</span> <span class="o">-</span><span class="n">n</span> <span class="n">kstar</span>
<span class="n">conda</span> <span class="n">activate</span> <span class="n">kstar</span>
<span class="n">conda</span> <span class="n">install</span> <span class="o">-</span><span class="n">c</span> <span class="n">bioconda</span> <span class="n">nextflow</span>
</pre></div>
</div>
</section>
<section id="updating-networks-used-in-kstar">
<h2>Updating Networks used in KSTAR<a class="headerlink" href="#updating-networks-used-in-kstar" title="Permalink to this headline">¶</a></h2>
<p>When implementing KSTAR with nextflow, you will need to indicate where to find the kinase-substrate networks to use. Once providing the network directory, it will look for a folder for the phosphoresidue of interest (Y/ST). Ultimately, your directory structure should follow this pattern:</p>
<p>‘resource_directory/network_directory/{Insert_Mod_Here}/INDIVIDUAL_NETWORKS’</p>
<p>Each individual pruned network should be a .tsv file.</p>
</section>
<section id="mapping-datasets">
<h2>Mapping datasets<a class="headerlink" href="#mapping-datasets" title="Permalink to this headline">¶</a></h2>
<p>Datasets must be mapped prior to running KSTAR with nextflow. The nextflow implementation is strictly for activity prediction. The mapped data should be a .tsv file that contains at least data columns, KSTAR_ACCESSION, KSTAR_PEPTIDE, AND KSTAR_SITE.</p>
</section>
<section id="running-nextflow">
<h2>Running nextflow<a class="headerlink" href="#running-nextflow" title="Permalink to this headline">¶</a></h2>
<p>Once all the above requirements are satisfied, KSTAR can be run using a simple bash script within the nextflow directory that looks like the one below. First, you must point to the KSTAR nextflow directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>export KSTAR_DIR = /repo_loc/KSTAR/nextflow
cd $KSTAR_DIR

nextflow run main.nf -profile Y \
--name example \
--phospho_event Y \
--outdir ./results \
--experiment_file data/example_data_mapped.tsv \
--outdir ./results \
--resource_directory ../RESOURCE_FILES \
--network_directoyr /NETWORKS/NetworKIN \
--data_columns data:Column1,data:Column2,data:Column3,data:Column4 \
--num_random_experiments 150 \
--threshold 0.5 \
--activity_aggregate mean \
--fpr_alpha 0.05 \
--number_of_sig_trials 100
</pre></div>
</div>
<p>The first line of the bash script starts the nextflow pipeline and indicates which type of phospho_mod is of interest (either pY or pST). The remaining lines are parameters accepted by nextflow, which either indicate where to find/deposit files or are KSTAR parameters. See the table below for a description of the accepted parameters by nextflow:</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Parameter</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Required?</p></th>
<th class="head"><p>Default</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>experiment_file</p></td>
<td><p>full filename of the experiment</p></td>
<td><p>Yes</p></td>
<td><p>None</p></td>
</tr>
<tr class="row-odd"><td><p>name</p></td>
<td><p>the name of the experiment. This will be used to name folders/files outputted by KSTAR</p></td>
<td><p>No</p></td>
<td><p>‘kstar’</p></td>
</tr>
<tr class="row-even"><td><p>phospho_event</p></td>
<td><p>Type of phosphorylation network to analyze. Either Y or ST.</p></td>
<td><p>Yes</p></td>
<td><p>false</p></td>
</tr>
<tr class="row-odd"><td><p>num_random_experiments</p></td>
<td><p>The number of random experiments to generate for use in normalization and mann whitney tests</p></td>
<td><p>Yes</p></td>
<td><p>N/A</p></td>
</tr>
<tr class="row-even"><td><p>number_of_sig_trials</p></td>
<td><p>The number of significance trials to perform for the mann whitney tests</p></td>
<td><p>Yes</p></td>
<td><p>false</p></td>
</tr>
<tr class="row-odd"><td><p>resource_directory</p></td>
<td><p>directory where all necesary resources can be found. Should contain the network directory</p></td>
<td><p>Yes</p></td>
<td><p>false</p></td>
</tr>
<tr class="row-even"><td><p>threshold</p></td>
<td><p>The cutoff value to use for determining whether a site is used as evidence for a particular sample</p></td>
<td><p>No</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>outdir</p></td>
<td><p>directory where results should be deposited</p></td>
<td><p>No</p></td>
<td><p>‘./results’</p></td>
</tr>
<tr class="row-even"><td><p>network_directory</p></td>
<td><p>directory where all networks to be used in the analysis can be found</p></td>
<td><p>No</p></td>
<td><p>NETWORKS/NetworKIN</p></td>
</tr>
<tr class="row-odd"><td><p>data_columns</p></td>
<td><p>list of pre-mapped data columns to analyze. Must follow the following rules:  <ul><li>cannot include parenthesis, spaces, or commas in name</li><li> different data columns are split by a comma with no space in between</li><li>if left blank or false, all columns that start with ‘data:’ are analyzed </li></ul></p></td>
<td><p>No</p></td>
<td><p>false</p></td>
</tr>
<tr class="row-even"><td><p>add_data_before</p></td>
<td><p>boolean, where if true, ‘data:’ is added in front of each column name</p></td>
<td><p>No</p></td>
<td><p>false</p></td>
</tr>
<tr class="row-odd"><td><p>activity_aggregate</p></td>
<td><p>aggregate for binarizing the experiments. Choices include count, mean, median, max, min</p></td>
<td><p>No</p></td>
<td><p>count</p></td>
</tr>
<tr class="row-even"><td><p>fpr_alpha</p></td>
<td><p>Desired false positive rate</p></td>
<td><p>No</p></td>
<td><p>0.05</p></td>
</tr>
<tr class="row-odd"><td><p>greater</p></td>
<td><p>Boolean value that indicates whether sites above or below the threshold are used as evidence. If True, sites greater than evidence will be used</p></td>
<td><p>No</p></td>
<td><p>True</p></td>
</tr>
<tr class="row-even"><td><p>chunk_size</p></td>
<td><p></p></td>
<td><p>No</p></td>
<td><p>10</p></td>
</tr>
</tbody>
</table>
</section>
<section id="output-of-a-nextflow-run">
<h2>Output of a nextflow run<a class="headerlink" href="#output-of-a-nextflow-run" title="Permalink to this headline">¶</a></h2>
<p>Each run with KSTAR-HP will deposit all results from a run in the folder indicated by the outdir parameter. There will be seperate folders for tyrosine and serine/threonine results if both types of runs are performed. Within the out directory, there will be the following subfolders, most of which mirror what is saved in the pickle object in the base KSTAR algorithm:</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Subfolder</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Files within the folder</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>random_hypergeometric activity</p></td>
<td><p>Contains the predicted activities for each of the random experiments</p></td>
<td><p><ul><li>example_random_activities.tsv</li><li> example_aggregated_activities.tsv</li></ul></p></td>
</tr>
<tr class="row-odd"><td><p>pipeline_info</p></td>
<td><p>Contains all information about the nextflow run, including run time, memory used, and cpus used</p></td>
<td><p><ul><li>pipeline_dag.svg </li><li> execution_trace.txt </li><li>execution_timeline.html </li><li> execution_report.html</li></ul></p></td>
</tr>
<tr class="row-even"><td><p>normalized_activity</p></td>
<td><p>Contains activity and fpr predictions after original predictions have been normalized relative to the median p-values obtained from the random experiments</p></td>
<td><p><ul><li>example_normalized_aggregate_activity.tsv </li><li> example_normalized_activities.tsv </li></ul></p></td>
</tr>
<tr class="row-odd"><td><p>mann_whitney</p></td>
<td><p>Contains activity and fpr predictions obtained via the Mann Whitney statistical test, comparing the experiment p-values to the random experiments. These are the activity/fpr values we recommend using for analysis</p></td>
<td><p><ul><li>example_mann_whitney_fpr.tsv </li><li> example_mann_whitney_activities.tsv </li><li>mann_whitney_combined </li></ul></p></td>
</tr>
<tr class="row-even"><td><p>individual_experiments</p></td>
<td><p>This contains all of the random datasets generated for use in getting both the normalized and Mann Whitney activities</p></td>
<td><p><ul><li>folders containing results for each individual experiment/sample</li></ul></p></td>
</tr>
<tr class="row-odd"><td><p>hypergeometric_activity</p></td>
<td><p>Contains activity predictions prior to accounting for the expected p-values due to random chance</p></td>
<td><p><ul><li>example_aggregated_activities.tsv </li><li> example_activities_list.tsv </li><li>example_activities.tsv </li></ul></p></td>
</tr>
<tr class="row-even"><td><p>binary_experiment</p></td>
<td><p>Contains the mapped data after the evidence columns have been binarized based on the given threshold</p></td>
<td><p><ul><li> example_binarized_experiment.tsv </li></ul></p></td>
</tr>
</tbody>
</table>
</section>
<section id="running-kstar-nextflow-on-singularity">
<h2>Running KSTAR-nextflow on Singularity<a class="headerlink" href="#running-kstar-nextflow-on-singularity" title="Permalink to this headline">¶</a></h2>
<p>It is also possible to implement the above using singularity containers instead of docker containers. If singularity is already installed, only a small addition at the bottom of the bash script is needed to use singularity instead of docker.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>export KSTAR_DIR = /repo_loc/KSTAR/nextflow
cd $KSTAR_DIR

nextflow run main.nf -profile Y \
--name example \
--phospho_event Y \
--outdir ./results \
--experiment_file data/example_data_mapped.tsv \
--outdir ./results \
--resource_directory ../RESOURCE_FILES \
--network_directoyr /NETWORKS/NetworKIN \
--data_columns data:Column1,data:Column2,data:Column3,data:Column4 \
--num_random_experiments 150 \
--threshold 0.5 \
--activity_aggregate mean \
--fpr_alpha 0.05 \
--number_of_sig_trials 100
-with-singularity
-without-docker
</pre></div>
</div>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="Dependencies.html">Dependencies</a></li>
<li class="toctree-l1"><a class="reference internal" href="Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="KSTAR.html">KSTAR</a></li>
<li class="toctree-l1"><a class="reference internal" href="Tutorial/tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="Examples/Examples.html">Plotting Examples from KSTAR Paper</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Running Large Datasets with Nextflow</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#requirements">Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="#installation">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#updating-networks-used-in-kstar">Updating Networks used in KSTAR</a></li>
<li class="toctree-l2"><a class="reference internal" href="#mapping-datasets">Mapping datasets</a></li>
<li class="toctree-l2"><a class="reference internal" href="#running-nextflow">Running nextflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="#output-of-a-nextflow-run">Output of a nextflow run</a></li>
<li class="toctree-l2"><a class="reference internal" href="#running-kstar-nextflow-on-singularity">Running KSTAR-nextflow on Singularity</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="Examples/Microbiopsy_Analysis.html"
                        title="previous chapter">Analysis of HER2 Positive Patients using Microbiopsies ()</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/Running_with_nextflow.md.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="Examples/Microbiopsy_Analysis.html" title="Analysis of HER2 Positive Patients using Microbiopsies ()"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">KSTAR 1 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Running Large Datasets with Nextflow</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, Naegle Lab.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.0.1.
    </div>
  </body>
</html>